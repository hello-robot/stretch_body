<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.0.0"/>
    <title>stretch_body.transport API documentation</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../stretch_body.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;stretch_body</a>

<a href="https://github.com/hello-robot/stretch_body">            <img src="../images/banner.png" class="logo" alt="project logo"/>
</a>
            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#TransportError">TransportError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="variable" href="#RPC_V1_MAX_FRAMES">RPC_V1_MAX_FRAMES</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PUSH_FRAME_FIRST_MORE">RPC_V1_PUSH_FRAME_FIRST_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PUSH_FRAME_FIRST_ONLY">RPC_V1_PUSH_FRAME_FIRST_ONLY</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PUSH_FRAME_MORE">RPC_V1_PUSH_FRAME_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PUSH_FRAME_LAST">RPC_V1_PUSH_FRAME_LAST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PUSH_ACK">RPC_V1_PUSH_ACK</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PULL_FRAME_FIRST">RPC_V1_PULL_FRAME_FIRST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PULL_FRAME_MORE">RPC_V1_PULL_FRAME_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PULL_FRAME_ACK_MORE">RPC_V1_PULL_FRAME_ACK_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_PULL_FRAME_ACK_LAST">RPC_V1_PULL_FRAME_ACK_LAST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V1_FRAME_DATA_MAX_BYTES">RPC_V1_FRAME_DATA_MAX_BYTES</a>
            </li>
            <li>
                    <a class="variable" href="#COBBS_FRAME_SIZE_V1">COBBS_FRAME_SIZE_V1</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_START_NEW_RPC">RPC_V0_START_NEW_RPC</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_ACK_NEW_RPC">RPC_V0_ACK_NEW_RPC</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_SEND_BLOCK_MORE">RPC_V0_SEND_BLOCK_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_ACK_SEND_BLOCK_MORE">RPC_V0_ACK_SEND_BLOCK_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_SEND_BLOCK_LAST">RPC_V0_SEND_BLOCK_LAST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_ACK_SEND_BLOCK_LAST">RPC_V0_ACK_SEND_BLOCK_LAST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_GET_BLOCK">RPC_V0_GET_BLOCK</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_ACK_GET_BLOCK_MORE">RPC_V0_ACK_GET_BLOCK_MORE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_ACK_GET_BLOCK_LAST">RPC_V0_ACK_GET_BLOCK_LAST</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_V0_BLOCK_SIZE">RPC_V0_BLOCK_SIZE</a>
            </li>
            <li>
                    <a class="variable" href="#COBBS_FRAME_SIZE_V0">COBBS_FRAME_SIZE_V0</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_DATA_MAX_BYTES">RPC_DATA_MAX_BYTES</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_MAX_FRAME_SIZE">RPC_MAX_FRAME_SIZE</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_TRANSPORT_VERSION_0">RPC_TRANSPORT_VERSION_0</a>
            </li>
            <li>
                    <a class="variable" href="#RPC_TRANSPORT_VERSION_1">RPC_TRANSPORT_VERSION_1</a>
            </li>
            <li>
                    <a class="class" href="#SyncTransactionHandler">SyncTransactionHandler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SyncTransactionHandler.__init__">SyncTransactionHandler</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.ser">ser</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.logger">logger</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.port_name">port_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.empty_frame">empty_frame</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.status">status</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.version">version</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.timeout">timeout</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.packet_marker">packet_marker</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.lock">lock</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.dbg_buf">dbg_buf</a>
                        </li>
                        <li>
                                <a class="variable" href="#SyncTransactionHandler.dbg_on">dbg_on</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.get_empty_frame">get_empty_frame</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.handle_push_ack_v1">handle_push_ack_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.handle_pull_ack_v1">handle_pull_ack_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.sendFramedData">sendFramedData</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.receiveFramedData">receiveFramedData</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.receiveFramedData2">receiveFramedData2</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.do_rpc">do_rpc</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.do_push_transaction_v1">do_push_transaction_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.do_pull_transaction_v1">do_pull_transaction_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#SyncTransactionHandler.do_transaction_v0">do_transaction_v0</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AsyncTransactionHandler">AsyncTransactionHandler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.__init__">AsyncTransactionHandler</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.sendFramedData">sendFramedData</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.receiveFramedData">receiveFramedData</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.do_rpc">do_rpc</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.do_pull_transaction_v1">do_pull_transaction_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.do_push_transaction_v1">do_push_transaction_v1</a>
                        </li>
                        <li>
                                <a class="function" href="#AsyncTransactionHandler.do_transaction_v0">do_transaction_v0</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Transport">Transport</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Transport.__init__">Transport</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.port_name">port_name</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.logger">logger</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.lock">lock</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.status">status</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.empty_payload">empty_payload</a>
                        </li>
                        <li>
                                <a class="variable" href="#Transport.version">version</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.startup">startup</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.stop">stop</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.get_empty_payload">get_empty_payload</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.configure_version">configure_version</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.set_version">set_version</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.do_pull_rpc_async">do_pull_rpc_async</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.do_push_rpc_async">do_push_rpc_async</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.do_pull_rpc_sync">do_pull_rpc_sync</a>
                        </li>
                        <li>
                                <a class="function" href="#Transport.do_push_rpc_sync">do_push_rpc_sync</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#pack_string_t">pack_string_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_string_t">unpack_string_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_int32_t">unpack_int32_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_uint32_t">unpack_uint32_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_int64_t">unpack_int64_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_uint64_t">unpack_uint64_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_int16_t">unpack_int16_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_uint16_t">unpack_uint16_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_uint8_t">unpack_uint8_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_float_t">unpack_float_t</a>
            </li>
            <li>
                    <a class="function" href="#unpack_double_t">unpack_double_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_float_t">pack_float_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_double_t">pack_double_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_int32_t">pack_int32_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_uint32_t">pack_uint32_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_int16_t">pack_int16_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_uint16_t">pack_uint16_t</a>
            </li>
            <li>
                    <a class="function" href="#pack_uint8_t">pack_uint8_t</a>
            </li>
    </ul>


    <footer>My Package v1.0</footer>

        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                        <a class="pdoc-button git-button" href="https://github.com/hello-robot/stretch_body/tree/feature/pdoc/body/stretch_body/transport.py">Edit on GitHub</a>
                    <h1 class="modulename">
<a href="./../stretch_body.html">stretch_body</a><wbr>.transport    </h1>

                
                        <input id="mod-transport-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-transport-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="kn">import</span> <span class="nn">serial</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="kn">import</span> <span class="nn">struct</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="kn">import</span> <span class="nn">array</span> <span class="k">as</span> <span class="nn">arr</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">stretch_body.cobbs_framing</span> <span class="k">as</span> <span class="nn">cobbs_framing</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">copy</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">fcntl</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">logging</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">threading</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">aioserial</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">asyncio</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="sd">Loop protocol is:</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="sd">RPC Data is sent over a COBBS encoding with CRC error detection.</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="sd">The  packet is:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="sd">Data can be up to X bytes.</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="sd">Data is manually packed / unpacked into dictionaries (Python) and C-structs (Arduino).</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="sd">Care should be taken that the pack/unpack size and types are consistent between the two.</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="sd">This is not automated.</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="c1"># ##################### TRANSPORT ####################################</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="k">class</span> <span class="nc">TransportError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>    <span class="sd">&quot;&quot;&quot;Base class for exceptions in this module.&quot;&quot;&quot;</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>    <span class="k">pass</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="n">RPC_V1_MAX_FRAMES</span> <span class="o">=</span> <span class="mi">18</span>  <span class="c1"># Required to support 1024 bytes</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span> <span class="o">=</span> <span class="mi">201</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span> <span class="o">=</span> <span class="mi">202</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="n">RPC_V1_PUSH_FRAME_MORE</span> <span class="o">=</span> <span class="mi">203</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="n">RPC_V1_PUSH_FRAME_LAST</span> <span class="o">=</span> <span class="mi">204</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="n">RPC_V1_PUSH_ACK</span> <span class="o">=</span> <span class="mi">205</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="n">RPC_V1_PULL_FRAME_FIRST</span> <span class="o">=</span> <span class="mi">206</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="n">RPC_V1_PULL_FRAME_MORE</span> <span class="o">=</span> <span class="mi">207</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span> <span class="o">=</span> <span class="mi">208</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span> <span class="o">=</span> <span class="mi">209</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span> <span class="o">=</span> <span class="mi">58</span>  <span class="c1"># 63 - 2 (CRC) - 1 (Cobbs Header) - 1 (FRAME CMD) - 1 (Packet Marker)</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="n">COBBS_FRAME_SIZE_V1</span> <span class="o">=</span> <span class="mi">63</span>  <span class="c1"># Was seeing issues when transmitting 64 bytes so limiting to 63. Issue resolved.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="c1"># //////////////////////////////  V0 Defines ///////////////////////////////////////////////////</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="n">RPC_V0_START_NEW_RPC</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="n">RPC_V0_ACK_NEW_RPC</span> <span class="o">=</span> <span class="mi">101</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="n">RPC_V0_SEND_BLOCK_MORE</span> <span class="o">=</span> <span class="mi">102</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span> <span class="o">=</span> <span class="mi">103</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="n">RPC_V0_SEND_BLOCK_LAST</span> <span class="o">=</span> <span class="mi">104</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span> <span class="o">=</span> <span class="mi">105</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="n">RPC_V0_GET_BLOCK</span> <span class="o">=</span> <span class="mi">106</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="o">=</span> <span class="mi">107</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a><span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span> <span class="o">=</span> <span class="mi">108</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="n">RPC_V0_BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a><span class="n">COBBS_FRAME_SIZE_V0</span> <span class="o">=</span> <span class="mi">64</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="c1"># //////////////////////////////  Shared Defines ///////////////////////////////////////////////////</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a><span class="n">RPC_DATA_MAX_BYTES</span> <span class="o">=</span> <span class="mi">1024</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="n">RPC_MAX_FRAME_SIZE</span> <span class="o">=</span> <span class="mi">64</span>  <span class="c1"># Arduino and Linux USB Uart has a 64 byte buffer. When frame is &gt;64 have seen issues.</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="n">RPC_TRANSPORT_VERSION_0</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="n">RPC_TRANSPORT_VERSION_1</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="k">class</span> <span class="nc">SyncTransactionHandler</span><span class="p">():</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">port_name</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;read_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;write_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transactions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">.2</span>  <span class="c1"># Was .05 but on heavy loads can get starved</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="k">def</span> <span class="nf">get_empty_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span><span class="p">[:]</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="k">def</span> <span class="nf">handle_push_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V1_PUSH_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PUSH_ACK</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PUSH_ACK&#39;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="k">def</span> <span class="nf">handle_pull_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_PULL_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>                               <span class="s1">&#39; OR B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PULL_ACK&#39;</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span> <span class="ow">and</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>    <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>        <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">terminator</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rbuf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Transport invalid read </span><span class="si">%d</span><span class="s1"> bytes during _recv_framed_data&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">))</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a>        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rbuf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a>    <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a>            <span class="k">return</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="k">if</span> <span class="n">exiting</span><span class="p">:</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>    <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">                Parameters</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        ----------</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        -------</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">        Push command data</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>    <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">                Parameters</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        ----------</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        -------</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>    <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                <span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>            <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                        <span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>            <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>                <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                    <span class="k">break</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>        <span class="c1"># except TypeError as e:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="c1">#     self.logger.error(&quot;TypeError: %s : %s&quot; % (self.port_name, str(e)))</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="c1">#     self.ser=None</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="k">class</span> <span class="nc">AsyncTransactionHandler</span><span class="p">(</span><span class="n">SyncTransactionHandler</span><span class="p">):</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="n">SyncTransactionHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write_async</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>            <span class="k">return</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a>        <span class="c1"># if exiting:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>        <span class="c1">#     time.sleep(0.1) #May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="c1">#     self.ser.reset_output_buffer()</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>        <span class="c1">#     self.ser.reset_input_buffer()</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a><span class="sd">                Parameters</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a><span class="sd">        ----------</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a><span class="sd">        -------</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="sd">                Parameters</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a><span class="sd">        ----------</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">        -------</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">        Push command data</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>        <span class="n">frame_buf_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Remove stale data</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                <span class="k">if</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span><span class="p">(</span><span class="s2">&quot;Byte 0 not RPC_V1_PUSH_ACK&quot;</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>            <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                        <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>            <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>                                                                                                  <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a>                                                                                                  <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>                <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>                    <span class="k">break</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a><span class="k">class</span> <span class="nc">Transport</span><span class="p">():</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a><span class="sd">    Handle serial communications to a Hello Robot USB device using pySerial and asyncio</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a><span class="sd">    Aioserial supports the standard  pySerial interface as well as async versions of the pySerial interface.</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a><span class="sd">    This enables Transport to support both synchronous and asynchromous calls.</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="sd">    Devices can use standard pySerial for non-timing critical transactions.</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="sd">    They can use the asyncio interfaces for timing critical transactions where blocking on the RPC call is not desirable</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usb</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()):</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">usb</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">RPC_DATA_MAX_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># RPC ID + 1024 bytes of data</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">aioserial</span><span class="o">.</span><span class="n">AioSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">write_timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>            <span class="c1"># self.ser = serial.Serial(self.port_name,write_timeout=1.0)  # PosixPollSerial(self.usb)#Serial(self.usb)# 115200)  # , write_timeout=1.0)  # Baud not important since USB comms</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span> <span class="o">=</span> <span class="n">AsyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                                                         <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span> <span class="o">=</span> <span class="n">SyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                                                       <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;sync&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">isOpen</span><span class="p">():</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                    <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                        <span class="s1">&#39;Port </span><span class="si">%s</span><span class="s1"> is busy. Check if another Stretch Body process is already running&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to open serial port for device </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># return if hardware connection valid</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Shutting down TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>    <span class="k">def</span> <span class="nf">get_empty_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span><span class="p">[:]</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>    <span class="k">def</span> <span class="nf">configure_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firmware_version</span><span class="p">):</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a><span class="sd">        Starting with Stepper/Wacc/Pimu firmware v0.4.0 a faster version (V1) of the transport layer is supported</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="sd">        Check here if can run the Transport in V1 mode</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>        <span class="n">xl</span> <span class="o">=</span> <span class="n">firmware_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid firmware version len&#39;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Stepper&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Wacc&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Pimu&#39;</span><span class="p">):</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid device name &#39;</span><span class="p">)</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>        <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>        <span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>        <span class="k">if</span> <span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">)</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">)</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>    <span class="k">def</span> <span class="nf">set_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>        <span class="c1"># print(&#39;VERSION&#39;,v,self.port_name)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid version for Transport&#39;</span><span class="p">)</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">        Parameters</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">        ----------</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">        Returns</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        -------</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">        None</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>        <span class="c1"># Acquire the lock in a worker thread, suspending us while waiting.</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>        <span class="c1"># See https://stackoverflow.com/questions/63420413/how-to-use-threading-lock-in-async-function-while-object-can-be-accessed-from-mu</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">        Parameters</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">        ----------</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a><span class="sd">        Returns</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a><span class="sd">        -------</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a><span class="sd">        None</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>    <span class="k">def</span> <span class="nf">do_pull_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a><span class="sd">        Parameters</span>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        ----------</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">        Returns</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">        -------</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">        None</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>    <span class="k">def</span> <span class="nf">do_push_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">        Parameters</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        ----------</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">        Returns</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        -------</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">        None</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="c1"># #####################################</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="k">def</span> <span class="nf">pack_string_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="k">def</span> <span class="nf">unpack_string_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="k">def</span> <span class="nf">unpack_int32_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="k">def</span> <span class="nf">unpack_uint32_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a><span class="k">def</span> <span class="nf">unpack_int64_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a><span class="k">def</span> <span class="nf">unpack_uint64_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a><span class="k">def</span> <span class="nf">unpack_int16_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="k">def</span> <span class="nf">unpack_uint16_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="k">def</span> <span class="nf">unpack_uint8_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a><span class="k">def</span> <span class="nf">unpack_float_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="k">def</span> <span class="nf">unpack_double_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="k">def</span> <span class="nf">pack_float_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="k">def</span> <span class="nf">pack_double_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="k">def</span> <span class="nf">pack_int32_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="k">def</span> <span class="nf">pack_uint32_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="k">def</span> <span class="nf">pack_int16_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="k">def</span> <span class="nf">pack_uint16_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="k">def</span> <span class="nf">pack_uint8_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="TransportError">
                            <input id="TransportError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TransportError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="TransportError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransportError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransportError-37"><a href="#TransportError-37"><span class="linenos">37</span></a><span class="k">class</span> <span class="nc">TransportError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="TransportError-38"><a href="#TransportError-38"><span class="linenos">38</span></a>    <span class="sd">&quot;&quot;&quot;Base class for exceptions in this module.&quot;&quot;&quot;</span>
</span><span id="TransportError-39"><a href="#TransportError-39"><span class="linenos">39</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Base class for exceptions in this module.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="TransportError.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="TransportError.with_traceback" class="function">with_traceback</dd>
                <dd id="TransportError.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="RPC_V1_MAX_FRAMES">
                    <div class="attr variable">
            <span class="name">RPC_V1_MAX_FRAMES</span>        =
<span class="default_value">18</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_MAX_FRAMES"></a>
    
    

                </section>
                <section id="RPC_V1_PUSH_FRAME_FIRST_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V1_PUSH_FRAME_FIRST_MORE</span>        =
<span class="default_value">201</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PUSH_FRAME_FIRST_MORE"></a>
    
    

                </section>
                <section id="RPC_V1_PUSH_FRAME_FIRST_ONLY">
                    <div class="attr variable">
            <span class="name">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>        =
<span class="default_value">202</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PUSH_FRAME_FIRST_ONLY"></a>
    
    

                </section>
                <section id="RPC_V1_PUSH_FRAME_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V1_PUSH_FRAME_MORE</span>        =
<span class="default_value">203</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PUSH_FRAME_MORE"></a>
    
    

                </section>
                <section id="RPC_V1_PUSH_FRAME_LAST">
                    <div class="attr variable">
            <span class="name">RPC_V1_PUSH_FRAME_LAST</span>        =
<span class="default_value">204</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PUSH_FRAME_LAST"></a>
    
    

                </section>
                <section id="RPC_V1_PUSH_ACK">
                    <div class="attr variable">
            <span class="name">RPC_V1_PUSH_ACK</span>        =
<span class="default_value">205</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PUSH_ACK"></a>
    
    

                </section>
                <section id="RPC_V1_PULL_FRAME_FIRST">
                    <div class="attr variable">
            <span class="name">RPC_V1_PULL_FRAME_FIRST</span>        =
<span class="default_value">206</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PULL_FRAME_FIRST"></a>
    
    

                </section>
                <section id="RPC_V1_PULL_FRAME_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V1_PULL_FRAME_MORE</span>        =
<span class="default_value">207</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PULL_FRAME_MORE"></a>
    
    

                </section>
                <section id="RPC_V1_PULL_FRAME_ACK_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V1_PULL_FRAME_ACK_MORE</span>        =
<span class="default_value">208</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PULL_FRAME_ACK_MORE"></a>
    
    

                </section>
                <section id="RPC_V1_PULL_FRAME_ACK_LAST">
                    <div class="attr variable">
            <span class="name">RPC_V1_PULL_FRAME_ACK_LAST</span>        =
<span class="default_value">209</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_PULL_FRAME_ACK_LAST"></a>
    
    

                </section>
                <section id="RPC_V1_FRAME_DATA_MAX_BYTES">
                    <div class="attr variable">
            <span class="name">RPC_V1_FRAME_DATA_MAX_BYTES</span>        =
<span class="default_value">58</span>

        
    </div>
    <a class="headerlink" href="#RPC_V1_FRAME_DATA_MAX_BYTES"></a>
    
    

                </section>
                <section id="COBBS_FRAME_SIZE_V1">
                    <div class="attr variable">
            <span class="name">COBBS_FRAME_SIZE_V1</span>        =
<span class="default_value">63</span>

        
    </div>
    <a class="headerlink" href="#COBBS_FRAME_SIZE_V1"></a>
    
    

                </section>
                <section id="RPC_V0_START_NEW_RPC">
                    <div class="attr variable">
            <span class="name">RPC_V0_START_NEW_RPC</span>        =
<span class="default_value">100</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_START_NEW_RPC"></a>
    
    

                </section>
                <section id="RPC_V0_ACK_NEW_RPC">
                    <div class="attr variable">
            <span class="name">RPC_V0_ACK_NEW_RPC</span>        =
<span class="default_value">101</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_ACK_NEW_RPC"></a>
    
    

                </section>
                <section id="RPC_V0_SEND_BLOCK_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V0_SEND_BLOCK_MORE</span>        =
<span class="default_value">102</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_SEND_BLOCK_MORE"></a>
    
    

                </section>
                <section id="RPC_V0_ACK_SEND_BLOCK_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V0_ACK_SEND_BLOCK_MORE</span>        =
<span class="default_value">103</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_ACK_SEND_BLOCK_MORE"></a>
    
    

                </section>
                <section id="RPC_V0_SEND_BLOCK_LAST">
                    <div class="attr variable">
            <span class="name">RPC_V0_SEND_BLOCK_LAST</span>        =
<span class="default_value">104</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_SEND_BLOCK_LAST"></a>
    
    

                </section>
                <section id="RPC_V0_ACK_SEND_BLOCK_LAST">
                    <div class="attr variable">
            <span class="name">RPC_V0_ACK_SEND_BLOCK_LAST</span>        =
<span class="default_value">105</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_ACK_SEND_BLOCK_LAST"></a>
    
    

                </section>
                <section id="RPC_V0_GET_BLOCK">
                    <div class="attr variable">
            <span class="name">RPC_V0_GET_BLOCK</span>        =
<span class="default_value">106</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_GET_BLOCK"></a>
    
    

                </section>
                <section id="RPC_V0_ACK_GET_BLOCK_MORE">
                    <div class="attr variable">
            <span class="name">RPC_V0_ACK_GET_BLOCK_MORE</span>        =
<span class="default_value">107</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_ACK_GET_BLOCK_MORE"></a>
    
    

                </section>
                <section id="RPC_V0_ACK_GET_BLOCK_LAST">
                    <div class="attr variable">
            <span class="name">RPC_V0_ACK_GET_BLOCK_LAST</span>        =
<span class="default_value">108</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_ACK_GET_BLOCK_LAST"></a>
    
    

                </section>
                <section id="RPC_V0_BLOCK_SIZE">
                    <div class="attr variable">
            <span class="name">RPC_V0_BLOCK_SIZE</span>        =
<span class="default_value">32</span>

        
    </div>
    <a class="headerlink" href="#RPC_V0_BLOCK_SIZE"></a>
    
    

                </section>
                <section id="COBBS_FRAME_SIZE_V0">
                    <div class="attr variable">
            <span class="name">COBBS_FRAME_SIZE_V0</span>        =
<span class="default_value">64</span>

        
    </div>
    <a class="headerlink" href="#COBBS_FRAME_SIZE_V0"></a>
    
    

                </section>
                <section id="RPC_DATA_MAX_BYTES">
                    <div class="attr variable">
            <span class="name">RPC_DATA_MAX_BYTES</span>        =
<span class="default_value">1024</span>

        
    </div>
    <a class="headerlink" href="#RPC_DATA_MAX_BYTES"></a>
    
    

                </section>
                <section id="RPC_MAX_FRAME_SIZE">
                    <div class="attr variable">
            <span class="name">RPC_MAX_FRAME_SIZE</span>        =
<span class="default_value">64</span>

        
    </div>
    <a class="headerlink" href="#RPC_MAX_FRAME_SIZE"></a>
    
    

                </section>
                <section id="RPC_TRANSPORT_VERSION_0">
                    <div class="attr variable">
            <span class="name">RPC_TRANSPORT_VERSION_0</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#RPC_TRANSPORT_VERSION_0"></a>
    
    

                </section>
                <section id="RPC_TRANSPORT_VERSION_1">
                    <div class="attr variable">
            <span class="name">RPC_TRANSPORT_VERSION_1</span>        =
<span class="default_value">1</span>

        
    </div>
    <a class="headerlink" href="#RPC_TRANSPORT_VERSION_1"></a>
    
    

                </section>
                <section id="SyncTransactionHandler">
                            <input id="SyncTransactionHandler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SyncTransactionHandler</span>:

                <label class="view-source-button" for="SyncTransactionHandler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler-76"><a href="#SyncTransactionHandler-76"><span class="linenos"> 76</span></a><span class="k">class</span> <span class="nc">SyncTransactionHandler</span><span class="p">():</span>
</span><span id="SyncTransactionHandler-77"><a href="#SyncTransactionHandler-77"><span class="linenos"> 77</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-78"><a href="#SyncTransactionHandler-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span>
</span><span id="SyncTransactionHandler-79"><a href="#SyncTransactionHandler-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="SyncTransactionHandler-80"><a href="#SyncTransactionHandler-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">port_name</span>
</span><span id="SyncTransactionHandler-81"><a href="#SyncTransactionHandler-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-82"><a href="#SyncTransactionHandler-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;read_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;write_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transactions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="SyncTransactionHandler-83"><a href="#SyncTransactionHandler-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span><span id="SyncTransactionHandler-84"><a href="#SyncTransactionHandler-84"><span class="linenos"> 84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">.2</span>  <span class="c1"># Was .05 but on heavy loads can get starved</span>
</span><span id="SyncTransactionHandler-85"><a href="#SyncTransactionHandler-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler-86"><a href="#SyncTransactionHandler-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
</span><span id="SyncTransactionHandler-87"><a href="#SyncTransactionHandler-87"><span class="linenos"> 87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="SyncTransactionHandler-88"><a href="#SyncTransactionHandler-88"><span class="linenos"> 88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler-89"><a href="#SyncTransactionHandler-89"><span class="linenos"> 89</span></a>
</span><span id="SyncTransactionHandler-90"><a href="#SyncTransactionHandler-90"><span class="linenos"> 90</span></a>    <span class="k">def</span> <span class="nf">get_empty_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="SyncTransactionHandler-91"><a href="#SyncTransactionHandler-91"><span class="linenos"> 91</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span><span class="p">[:]</span>
</span><span id="SyncTransactionHandler-92"><a href="#SyncTransactionHandler-92"><span class="linenos"> 92</span></a>
</span><span id="SyncTransactionHandler-93"><a href="#SyncTransactionHandler-93"><span class="linenos"> 93</span></a>    <span class="k">def</span> <span class="nf">handle_push_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-94"><a href="#SyncTransactionHandler-94"><span class="linenos"> 94</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-95"><a href="#SyncTransactionHandler-95"><span class="linenos"> 95</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="SyncTransactionHandler-96"><a href="#SyncTransactionHandler-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-97"><a href="#SyncTransactionHandler-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-98"><a href="#SyncTransactionHandler-98"><span class="linenos"> 98</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-99"><a href="#SyncTransactionHandler-99"><span class="linenos"> 99</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V1_PUSH_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler-100"><a href="#SyncTransactionHandler-100"><span class="linenos">100</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PUSH_ACK</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler-101"><a href="#SyncTransactionHandler-101"><span class="linenos">101</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-102"><a href="#SyncTransactionHandler-102"><span class="linenos">102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PUSH_ACK&#39;</span>
</span><span id="SyncTransactionHandler-103"><a href="#SyncTransactionHandler-103"><span class="linenos">103</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-104"><a href="#SyncTransactionHandler-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-105"><a href="#SyncTransactionHandler-105"><span class="linenos">105</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-106"><a href="#SyncTransactionHandler-106"><span class="linenos">106</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-107"><a href="#SyncTransactionHandler-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-108"><a href="#SyncTransactionHandler-108"><span class="linenos">108</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-109"><a href="#SyncTransactionHandler-109"><span class="linenos">109</span></a>
</span><span id="SyncTransactionHandler-110"><a href="#SyncTransactionHandler-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">handle_pull_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-111"><a href="#SyncTransactionHandler-111"><span class="linenos">111</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-112"><a href="#SyncTransactionHandler-112"><span class="linenos">112</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="SyncTransactionHandler-113"><a href="#SyncTransactionHandler-113"><span class="linenos">113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-114"><a href="#SyncTransactionHandler-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-115"><a href="#SyncTransactionHandler-115"><span class="linenos">115</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-116"><a href="#SyncTransactionHandler-116"><span class="linenos">116</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_PULL_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler-117"><a href="#SyncTransactionHandler-117"><span class="linenos">117</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler-118"><a href="#SyncTransactionHandler-118"><span class="linenos">118</span></a>                               <span class="s1">&#39; OR B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler-119"><a href="#SyncTransactionHandler-119"><span class="linenos">119</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-120"><a href="#SyncTransactionHandler-120"><span class="linenos">120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PULL_ACK&#39;</span>
</span><span id="SyncTransactionHandler-121"><a href="#SyncTransactionHandler-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-122"><a href="#SyncTransactionHandler-122"><span class="linenos">122</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-123"><a href="#SyncTransactionHandler-123"><span class="linenos">123</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-124"><a href="#SyncTransactionHandler-124"><span class="linenos">124</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span> <span class="ow">and</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-125"><a href="#SyncTransactionHandler-125"><span class="linenos">125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-126"><a href="#SyncTransactionHandler-126"><span class="linenos">126</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-127"><a href="#SyncTransactionHandler-127"><span class="linenos">127</span></a>
</span><span id="SyncTransactionHandler-128"><a href="#SyncTransactionHandler-128"><span class="linenos">128</span></a>    <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-129"><a href="#SyncTransactionHandler-129"><span class="linenos">129</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-130"><a href="#SyncTransactionHandler-130"><span class="linenos">130</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="SyncTransactionHandler-131"><a href="#SyncTransactionHandler-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-132"><a href="#SyncTransactionHandler-132"><span class="linenos">132</span></a>
</span><span id="SyncTransactionHandler-133"><a href="#SyncTransactionHandler-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-134"><a href="#SyncTransactionHandler-134"><span class="linenos">134</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-135"><a href="#SyncTransactionHandler-135"><span class="linenos">135</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SyncTransactionHandler-136"><a href="#SyncTransactionHandler-136"><span class="linenos">136</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-137"><a href="#SyncTransactionHandler-137"><span class="linenos">137</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-138"><a href="#SyncTransactionHandler-138"><span class="linenos">138</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-139"><a href="#SyncTransactionHandler-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-140"><a href="#SyncTransactionHandler-140"><span class="linenos">140</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-141"><a href="#SyncTransactionHandler-141"><span class="linenos">141</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler-142"><a href="#SyncTransactionHandler-142"><span class="linenos">142</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-143"><a href="#SyncTransactionHandler-143"><span class="linenos">143</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-144"><a href="#SyncTransactionHandler-144"><span class="linenos">144</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-145"><a href="#SyncTransactionHandler-145"><span class="linenos">145</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="SyncTransactionHandler-146"><a href="#SyncTransactionHandler-146"><span class="linenos">146</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="SyncTransactionHandler-147"><a href="#SyncTransactionHandler-147"><span class="linenos">147</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-148"><a href="#SyncTransactionHandler-148"><span class="linenos">148</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-149"><a href="#SyncTransactionHandler-149"><span class="linenos">149</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-150"><a href="#SyncTransactionHandler-150"><span class="linenos">150</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-151"><a href="#SyncTransactionHandler-151"><span class="linenos">151</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="SyncTransactionHandler-152"><a href="#SyncTransactionHandler-152"><span class="linenos">152</span></a>
</span><span id="SyncTransactionHandler-153"><a href="#SyncTransactionHandler-153"><span class="linenos">153</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-154"><a href="#SyncTransactionHandler-154"><span class="linenos">154</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-155"><a href="#SyncTransactionHandler-155"><span class="linenos">155</span></a>        <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">terminator</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-156"><a href="#SyncTransactionHandler-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rbuf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-157"><a href="#SyncTransactionHandler-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Transport invalid read </span><span class="si">%d</span><span class="s1"> bytes during _recv_framed_data&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-158"><a href="#SyncTransactionHandler-158"><span class="linenos">158</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-159"><a href="#SyncTransactionHandler-159"><span class="linenos">159</span></a>        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rbuf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="SyncTransactionHandler-160"><a href="#SyncTransactionHandler-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="SyncTransactionHandler-161"><a href="#SyncTransactionHandler-161"><span class="linenos">161</span></a>
</span><span id="SyncTransactionHandler-162"><a href="#SyncTransactionHandler-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-163"><a href="#SyncTransactionHandler-163"><span class="linenos">163</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-164"><a href="#SyncTransactionHandler-164"><span class="linenos">164</span></a>            <span class="k">return</span>
</span><span id="SyncTransactionHandler-165"><a href="#SyncTransactionHandler-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-166"><a href="#SyncTransactionHandler-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">exiting</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-167"><a href="#SyncTransactionHandler-167"><span class="linenos">167</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="SyncTransactionHandler-168"><a href="#SyncTransactionHandler-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-169"><a href="#SyncTransactionHandler-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-170"><a href="#SyncTransactionHandler-170"><span class="linenos">170</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="SyncTransactionHandler-171"><a href="#SyncTransactionHandler-171"><span class="linenos">171</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-172"><a href="#SyncTransactionHandler-172"><span class="linenos">172</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="SyncTransactionHandler-173"><a href="#SyncTransactionHandler-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-174"><a href="#SyncTransactionHandler-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-175"><a href="#SyncTransactionHandler-175"><span class="linenos">175</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-176"><a href="#SyncTransactionHandler-176"><span class="linenos">176</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-177"><a href="#SyncTransactionHandler-177"><span class="linenos">177</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-178"><a href="#SyncTransactionHandler-178"><span class="linenos">178</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-179"><a href="#SyncTransactionHandler-179"><span class="linenos">179</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-180"><a href="#SyncTransactionHandler-180"><span class="linenos">180</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-181"><a href="#SyncTransactionHandler-181"><span class="linenos">181</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-182"><a href="#SyncTransactionHandler-182"><span class="linenos">182</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-183"><a href="#SyncTransactionHandler-183"><span class="linenos">183</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-184"><a href="#SyncTransactionHandler-184"><span class="linenos">184</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-185"><a href="#SyncTransactionHandler-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-186"><a href="#SyncTransactionHandler-186"><span class="linenos">186</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-187"><a href="#SyncTransactionHandler-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-188"><a href="#SyncTransactionHandler-188"><span class="linenos">188</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-189"><a href="#SyncTransactionHandler-189"><span class="linenos">189</span></a>
</span><span id="SyncTransactionHandler-190"><a href="#SyncTransactionHandler-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-191"><a href="#SyncTransactionHandler-191"><span class="linenos">191</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-192"><a href="#SyncTransactionHandler-192"><span class="linenos">192</span></a><span class="sd">                Parameters</span>
</span><span id="SyncTransactionHandler-193"><a href="#SyncTransactionHandler-193"><span class="linenos">193</span></a><span class="sd">        ----------</span>
</span><span id="SyncTransactionHandler-194"><a href="#SyncTransactionHandler-194"><span class="linenos">194</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="SyncTransactionHandler-195"><a href="#SyncTransactionHandler-195"><span class="linenos">195</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="SyncTransactionHandler-196"><a href="#SyncTransactionHandler-196"><span class="linenos">196</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="SyncTransactionHandler-197"><a href="#SyncTransactionHandler-197"><span class="linenos">197</span></a><span class="sd">        -------</span>
</span><span id="SyncTransactionHandler-198"><a href="#SyncTransactionHandler-198"><span class="linenos">198</span></a><span class="sd">        Push command data</span>
</span><span id="SyncTransactionHandler-199"><a href="#SyncTransactionHandler-199"><span class="linenos">199</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="SyncTransactionHandler-200"><a href="#SyncTransactionHandler-200"><span class="linenos">200</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="SyncTransactionHandler-201"><a href="#SyncTransactionHandler-201"><span class="linenos">201</span></a>
</span><span id="SyncTransactionHandler-202"><a href="#SyncTransactionHandler-202"><span class="linenos">202</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="SyncTransactionHandler-203"><a href="#SyncTransactionHandler-203"><span class="linenos">203</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="SyncTransactionHandler-204"><a href="#SyncTransactionHandler-204"><span class="linenos">204</span></a>
</span><span id="SyncTransactionHandler-205"><a href="#SyncTransactionHandler-205"><span class="linenos">205</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="SyncTransactionHandler-206"><a href="#SyncTransactionHandler-206"><span class="linenos">206</span></a>
</span><span id="SyncTransactionHandler-207"><a href="#SyncTransactionHandler-207"><span class="linenos">207</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="SyncTransactionHandler-208"><a href="#SyncTransactionHandler-208"><span class="linenos">208</span></a>
</span><span id="SyncTransactionHandler-209"><a href="#SyncTransactionHandler-209"><span class="linenos">209</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="SyncTransactionHandler-210"><a href="#SyncTransactionHandler-210"><span class="linenos">210</span></a>
</span><span id="SyncTransactionHandler-211"><a href="#SyncTransactionHandler-211"><span class="linenos">211</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="SyncTransactionHandler-212"><a href="#SyncTransactionHandler-212"><span class="linenos">212</span></a>
</span><span id="SyncTransactionHandler-213"><a href="#SyncTransactionHandler-213"><span class="linenos">213</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler-214"><a href="#SyncTransactionHandler-214"><span class="linenos">214</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler-215"><a href="#SyncTransactionHandler-215"><span class="linenos">215</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler-216"><a href="#SyncTransactionHandler-216"><span class="linenos">216</span></a>
</span><span id="SyncTransactionHandler-217"><a href="#SyncTransactionHandler-217"><span class="linenos">217</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="SyncTransactionHandler-218"><a href="#SyncTransactionHandler-218"><span class="linenos">218</span></a>
</span><span id="SyncTransactionHandler-219"><a href="#SyncTransactionHandler-219"><span class="linenos">219</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="SyncTransactionHandler-220"><a href="#SyncTransactionHandler-220"><span class="linenos">220</span></a>
</span><span id="SyncTransactionHandler-221"><a href="#SyncTransactionHandler-221"><span class="linenos">221</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="SyncTransactionHandler-222"><a href="#SyncTransactionHandler-222"><span class="linenos">222</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="SyncTransactionHandler-223"><a href="#SyncTransactionHandler-223"><span class="linenos">223</span></a>
</span><span id="SyncTransactionHandler-224"><a href="#SyncTransactionHandler-224"><span class="linenos">224</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="SyncTransactionHandler-225"><a href="#SyncTransactionHandler-225"><span class="linenos">225</span></a>
</span><span id="SyncTransactionHandler-226"><a href="#SyncTransactionHandler-226"><span class="linenos">226</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="SyncTransactionHandler-227"><a href="#SyncTransactionHandler-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-228"><a href="#SyncTransactionHandler-228"><span class="linenos">228</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-229"><a href="#SyncTransactionHandler-229"><span class="linenos">229</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler-230"><a href="#SyncTransactionHandler-230"><span class="linenos">230</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-231"><a href="#SyncTransactionHandler-231"><span class="linenos">231</span></a>
</span><span id="SyncTransactionHandler-232"><a href="#SyncTransactionHandler-232"><span class="linenos">232</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-233"><a href="#SyncTransactionHandler-233"><span class="linenos">233</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-234"><a href="#SyncTransactionHandler-234"><span class="linenos">234</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="SyncTransactionHandler-235"><a href="#SyncTransactionHandler-235"><span class="linenos">235</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-236"><a href="#SyncTransactionHandler-236"><span class="linenos">236</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="SyncTransactionHandler-237"><a href="#SyncTransactionHandler-237"><span class="linenos">237</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-238"><a href="#SyncTransactionHandler-238"><span class="linenos">238</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="SyncTransactionHandler-239"><a href="#SyncTransactionHandler-239"><span class="linenos">239</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-240"><a href="#SyncTransactionHandler-240"><span class="linenos">240</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="SyncTransactionHandler-241"><a href="#SyncTransactionHandler-241"><span class="linenos">241</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-242"><a href="#SyncTransactionHandler-242"><span class="linenos">242</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="SyncTransactionHandler-243"><a href="#SyncTransactionHandler-243"><span class="linenos">243</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-244"><a href="#SyncTransactionHandler-244"><span class="linenos">244</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-245"><a href="#SyncTransactionHandler-245"><span class="linenos">245</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="SyncTransactionHandler-246"><a href="#SyncTransactionHandler-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-247"><a href="#SyncTransactionHandler-247"><span class="linenos">247</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="SyncTransactionHandler-248"><a href="#SyncTransactionHandler-248"><span class="linenos">248</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-249"><a href="#SyncTransactionHandler-249"><span class="linenos">249</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SyncTransactionHandler-250"><a href="#SyncTransactionHandler-250"><span class="linenos">250</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-251"><a href="#SyncTransactionHandler-251"><span class="linenos">251</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="SyncTransactionHandler-252"><a href="#SyncTransactionHandler-252"><span class="linenos">252</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SyncTransactionHandler-253"><a href="#SyncTransactionHandler-253"><span class="linenos">253</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-254"><a href="#SyncTransactionHandler-254"><span class="linenos">254</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-255"><a href="#SyncTransactionHandler-255"><span class="linenos">255</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-256"><a href="#SyncTransactionHandler-256"><span class="linenos">256</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-257"><a href="#SyncTransactionHandler-257"><span class="linenos">257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-258"><a href="#SyncTransactionHandler-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-259"><a href="#SyncTransactionHandler-259"><span class="linenos">259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-260"><a href="#SyncTransactionHandler-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-261"><a href="#SyncTransactionHandler-261"><span class="linenos">261</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-262"><a href="#SyncTransactionHandler-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-263"><a href="#SyncTransactionHandler-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-264"><a href="#SyncTransactionHandler-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-265"><a href="#SyncTransactionHandler-265"><span class="linenos">265</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-266"><a href="#SyncTransactionHandler-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-267"><a href="#SyncTransactionHandler-267"><span class="linenos">267</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-268"><a href="#SyncTransactionHandler-268"><span class="linenos">268</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-269"><a href="#SyncTransactionHandler-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-270"><a href="#SyncTransactionHandler-270"><span class="linenos">270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-271"><a href="#SyncTransactionHandler-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="SyncTransactionHandler-272"><a href="#SyncTransactionHandler-272"><span class="linenos">272</span></a>
</span><span id="SyncTransactionHandler-273"><a href="#SyncTransactionHandler-273"><span class="linenos">273</span></a>    <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-274"><a href="#SyncTransactionHandler-274"><span class="linenos">274</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-275"><a href="#SyncTransactionHandler-275"><span class="linenos">275</span></a><span class="sd">                Parameters</span>
</span><span id="SyncTransactionHandler-276"><a href="#SyncTransactionHandler-276"><span class="linenos">276</span></a><span class="sd">        ----------</span>
</span><span id="SyncTransactionHandler-277"><a href="#SyncTransactionHandler-277"><span class="linenos">277</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="SyncTransactionHandler-278"><a href="#SyncTransactionHandler-278"><span class="linenos">278</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="SyncTransactionHandler-279"><a href="#SyncTransactionHandler-279"><span class="linenos">279</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="SyncTransactionHandler-280"><a href="#SyncTransactionHandler-280"><span class="linenos">280</span></a><span class="sd">        -------</span>
</span><span id="SyncTransactionHandler-281"><a href="#SyncTransactionHandler-281"><span class="linenos">281</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="SyncTransactionHandler-282"><a href="#SyncTransactionHandler-282"><span class="linenos">282</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="SyncTransactionHandler-283"><a href="#SyncTransactionHandler-283"><span class="linenos">283</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="SyncTransactionHandler-284"><a href="#SyncTransactionHandler-284"><span class="linenos">284</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler-285"><a href="#SyncTransactionHandler-285"><span class="linenos">285</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-286"><a href="#SyncTransactionHandler-286"><span class="linenos">286</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-287"><a href="#SyncTransactionHandler-287"><span class="linenos">287</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="SyncTransactionHandler-288"><a href="#SyncTransactionHandler-288"><span class="linenos">288</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="SyncTransactionHandler-289"><a href="#SyncTransactionHandler-289"><span class="linenos">289</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-290"><a href="#SyncTransactionHandler-290"><span class="linenos">290</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-291"><a href="#SyncTransactionHandler-291"><span class="linenos">291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-292"><a href="#SyncTransactionHandler-292"><span class="linenos">292</span></a>
</span><span id="SyncTransactionHandler-293"><a href="#SyncTransactionHandler-293"><span class="linenos">293</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-294"><a href="#SyncTransactionHandler-294"><span class="linenos">294</span></a>
</span><span id="SyncTransactionHandler-295"><a href="#SyncTransactionHandler-295"><span class="linenos">295</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="SyncTransactionHandler-296"><a href="#SyncTransactionHandler-296"><span class="linenos">296</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-297"><a href="#SyncTransactionHandler-297"><span class="linenos">297</span></a>
</span><span id="SyncTransactionHandler-298"><a href="#SyncTransactionHandler-298"><span class="linenos">298</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-299"><a href="#SyncTransactionHandler-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SyncTransactionHandler-300"><a href="#SyncTransactionHandler-300"><span class="linenos">300</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-301"><a href="#SyncTransactionHandler-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="SyncTransactionHandler-302"><a href="#SyncTransactionHandler-302"><span class="linenos">302</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-303"><a href="#SyncTransactionHandler-303"><span class="linenos">303</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="SyncTransactionHandler-304"><a href="#SyncTransactionHandler-304"><span class="linenos">304</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="SyncTransactionHandler-305"><a href="#SyncTransactionHandler-305"><span class="linenos">305</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="SyncTransactionHandler-306"><a href="#SyncTransactionHandler-306"><span class="linenos">306</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-307"><a href="#SyncTransactionHandler-307"><span class="linenos">307</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-308"><a href="#SyncTransactionHandler-308"><span class="linenos">308</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-309"><a href="#SyncTransactionHandler-309"><span class="linenos">309</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-310"><a href="#SyncTransactionHandler-310"><span class="linenos">310</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-311"><a href="#SyncTransactionHandler-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-312"><a href="#SyncTransactionHandler-312"><span class="linenos">312</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-313"><a href="#SyncTransactionHandler-313"><span class="linenos">313</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-314"><a href="#SyncTransactionHandler-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-315"><a href="#SyncTransactionHandler-315"><span class="linenos">315</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-316"><a href="#SyncTransactionHandler-316"><span class="linenos">316</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-317"><a href="#SyncTransactionHandler-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-318"><a href="#SyncTransactionHandler-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-319"><a href="#SyncTransactionHandler-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-320"><a href="#SyncTransactionHandler-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-321"><a href="#SyncTransactionHandler-321"><span class="linenos">321</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-322"><a href="#SyncTransactionHandler-322"><span class="linenos">322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-323"><a href="#SyncTransactionHandler-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-324"><a href="#SyncTransactionHandler-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-325"><a href="#SyncTransactionHandler-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-326"><a href="#SyncTransactionHandler-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-327"><a href="#SyncTransactionHandler-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-328"><a href="#SyncTransactionHandler-328"><span class="linenos">328</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-329"><a href="#SyncTransactionHandler-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-330"><a href="#SyncTransactionHandler-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-331"><a href="#SyncTransactionHandler-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="SyncTransactionHandler-332"><a href="#SyncTransactionHandler-332"><span class="linenos">332</span></a>
</span><span id="SyncTransactionHandler-333"><a href="#SyncTransactionHandler-333"><span class="linenos">333</span></a>    <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="SyncTransactionHandler-334"><a href="#SyncTransactionHandler-334"><span class="linenos">334</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="SyncTransactionHandler-335"><a href="#SyncTransactionHandler-335"><span class="linenos">335</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-336"><a href="#SyncTransactionHandler-336"><span class="linenos">336</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-337"><a href="#SyncTransactionHandler-337"><span class="linenos">337</span></a>                <span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-338"><a href="#SyncTransactionHandler-338"><span class="linenos">338</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="SyncTransactionHandler-339"><a href="#SyncTransactionHandler-339"><span class="linenos">339</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="SyncTransactionHandler-340"><a href="#SyncTransactionHandler-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-341"><a href="#SyncTransactionHandler-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-342"><a href="#SyncTransactionHandler-342"><span class="linenos">342</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-343"><a href="#SyncTransactionHandler-343"><span class="linenos">343</span></a>            <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-344"><a href="#SyncTransactionHandler-344"><span class="linenos">344</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-345"><a href="#SyncTransactionHandler-345"><span class="linenos">345</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-346"><a href="#SyncTransactionHandler-346"><span class="linenos">346</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-347"><a href="#SyncTransactionHandler-347"><span class="linenos">347</span></a>                        <span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-348"><a href="#SyncTransactionHandler-348"><span class="linenos">348</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler-349"><a href="#SyncTransactionHandler-349"><span class="linenos">349</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-350"><a href="#SyncTransactionHandler-350"><span class="linenos">350</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="SyncTransactionHandler-351"><a href="#SyncTransactionHandler-351"><span class="linenos">351</span></a>
</span><span id="SyncTransactionHandler-352"><a href="#SyncTransactionHandler-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-353"><a href="#SyncTransactionHandler-353"><span class="linenos">353</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-354"><a href="#SyncTransactionHandler-354"><span class="linenos">354</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler-355"><a href="#SyncTransactionHandler-355"><span class="linenos">355</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-356"><a href="#SyncTransactionHandler-356"><span class="linenos">356</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-357"><a href="#SyncTransactionHandler-357"><span class="linenos">357</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="SyncTransactionHandler-358"><a href="#SyncTransactionHandler-358"><span class="linenos">358</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="SyncTransactionHandler-359"><a href="#SyncTransactionHandler-359"><span class="linenos">359</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler-360"><a href="#SyncTransactionHandler-360"><span class="linenos">360</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-361"><a href="#SyncTransactionHandler-361"><span class="linenos">361</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="SyncTransactionHandler-362"><a href="#SyncTransactionHandler-362"><span class="linenos">362</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-363"><a href="#SyncTransactionHandler-363"><span class="linenos">363</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="SyncTransactionHandler-364"><a href="#SyncTransactionHandler-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="SyncTransactionHandler-365"><a href="#SyncTransactionHandler-365"><span class="linenos">365</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="SyncTransactionHandler-366"><a href="#SyncTransactionHandler-366"><span class="linenos">366</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="SyncTransactionHandler-367"><a href="#SyncTransactionHandler-367"><span class="linenos">367</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-368"><a href="#SyncTransactionHandler-368"><span class="linenos">368</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler-369"><a href="#SyncTransactionHandler-369"><span class="linenos">369</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-370"><a href="#SyncTransactionHandler-370"><span class="linenos">370</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-371"><a href="#SyncTransactionHandler-371"><span class="linenos">371</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-372"><a href="#SyncTransactionHandler-372"><span class="linenos">372</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-373"><a href="#SyncTransactionHandler-373"><span class="linenos">373</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="SyncTransactionHandler-374"><a href="#SyncTransactionHandler-374"><span class="linenos">374</span></a>
</span><span id="SyncTransactionHandler-375"><a href="#SyncTransactionHandler-375"><span class="linenos">375</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-376"><a href="#SyncTransactionHandler-376"><span class="linenos">376</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-377"><a href="#SyncTransactionHandler-377"><span class="linenos">377</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-378"><a href="#SyncTransactionHandler-378"><span class="linenos">378</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-379"><a href="#SyncTransactionHandler-379"><span class="linenos">379</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-380"><a href="#SyncTransactionHandler-380"><span class="linenos">380</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-381"><a href="#SyncTransactionHandler-381"><span class="linenos">381</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-382"><a href="#SyncTransactionHandler-382"><span class="linenos">382</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="SyncTransactionHandler-383"><a href="#SyncTransactionHandler-383"><span class="linenos">383</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-384"><a href="#SyncTransactionHandler-384"><span class="linenos">384</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="SyncTransactionHandler-385"><a href="#SyncTransactionHandler-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-386"><a href="#SyncTransactionHandler-386"><span class="linenos">386</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="SyncTransactionHandler-387"><a href="#SyncTransactionHandler-387"><span class="linenos">387</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="SyncTransactionHandler-388"><a href="#SyncTransactionHandler-388"><span class="linenos">388</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler-389"><a href="#SyncTransactionHandler-389"><span class="linenos">389</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-390"><a href="#SyncTransactionHandler-390"><span class="linenos">390</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-391"><a href="#SyncTransactionHandler-391"><span class="linenos">391</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="SyncTransactionHandler-392"><a href="#SyncTransactionHandler-392"><span class="linenos">392</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="SyncTransactionHandler-393"><a href="#SyncTransactionHandler-393"><span class="linenos">393</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-394"><a href="#SyncTransactionHandler-394"><span class="linenos">394</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler-395"><a href="#SyncTransactionHandler-395"><span class="linenos">395</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-396"><a href="#SyncTransactionHandler-396"><span class="linenos">396</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-397"><a href="#SyncTransactionHandler-397"><span class="linenos">397</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-398"><a href="#SyncTransactionHandler-398"><span class="linenos">398</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-399"><a href="#SyncTransactionHandler-399"><span class="linenos">399</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler-400"><a href="#SyncTransactionHandler-400"><span class="linenos">400</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-401"><a href="#SyncTransactionHandler-401"><span class="linenos">401</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-402"><a href="#SyncTransactionHandler-402"><span class="linenos">402</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-403"><a href="#SyncTransactionHandler-403"><span class="linenos">403</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-404"><a href="#SyncTransactionHandler-404"><span class="linenos">404</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-405"><a href="#SyncTransactionHandler-405"><span class="linenos">405</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler-406"><a href="#SyncTransactionHandler-406"><span class="linenos">406</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-407"><a href="#SyncTransactionHandler-407"><span class="linenos">407</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="SyncTransactionHandler-408"><a href="#SyncTransactionHandler-408"><span class="linenos">408</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-409"><a href="#SyncTransactionHandler-409"><span class="linenos">409</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="SyncTransactionHandler-410"><a href="#SyncTransactionHandler-410"><span class="linenos">410</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="SyncTransactionHandler-411"><a href="#SyncTransactionHandler-411"><span class="linenos">411</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler-412"><a href="#SyncTransactionHandler-412"><span class="linenos">412</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-413"><a href="#SyncTransactionHandler-413"><span class="linenos">413</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="SyncTransactionHandler-414"><a href="#SyncTransactionHandler-414"><span class="linenos">414</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-415"><a href="#SyncTransactionHandler-415"><span class="linenos">415</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-416"><a href="#SyncTransactionHandler-416"><span class="linenos">416</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="SyncTransactionHandler-417"><a href="#SyncTransactionHandler-417"><span class="linenos">417</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-418"><a href="#SyncTransactionHandler-418"><span class="linenos">418</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="SyncTransactionHandler-419"><a href="#SyncTransactionHandler-419"><span class="linenos">419</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-420"><a href="#SyncTransactionHandler-420"><span class="linenos">420</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="SyncTransactionHandler-421"><a href="#SyncTransactionHandler-421"><span class="linenos">421</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-422"><a href="#SyncTransactionHandler-422"><span class="linenos">422</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-423"><a href="#SyncTransactionHandler-423"><span class="linenos">423</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-424"><a href="#SyncTransactionHandler-424"><span class="linenos">424</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="SyncTransactionHandler-425"><a href="#SyncTransactionHandler-425"><span class="linenos">425</span></a>                <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="SyncTransactionHandler-426"><a href="#SyncTransactionHandler-426"><span class="linenos">426</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="SyncTransactionHandler-427"><a href="#SyncTransactionHandler-427"><span class="linenos">427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SyncTransactionHandler-428"><a href="#SyncTransactionHandler-428"><span class="linenos">428</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler-429"><a href="#SyncTransactionHandler-429"><span class="linenos">429</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler-430"><a href="#SyncTransactionHandler-430"><span class="linenos">430</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="SyncTransactionHandler-431"><a href="#SyncTransactionHandler-431"><span class="linenos">431</span></a>
</span><span id="SyncTransactionHandler-432"><a href="#SyncTransactionHandler-432"><span class="linenos">432</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-433"><a href="#SyncTransactionHandler-433"><span class="linenos">433</span></a>                    <span class="k">break</span>
</span><span id="SyncTransactionHandler-434"><a href="#SyncTransactionHandler-434"><span class="linenos">434</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="SyncTransactionHandler-435"><a href="#SyncTransactionHandler-435"><span class="linenos">435</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler-436"><a href="#SyncTransactionHandler-436"><span class="linenos">436</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="SyncTransactionHandler-437"><a href="#SyncTransactionHandler-437"><span class="linenos">437</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="SyncTransactionHandler-438"><a href="#SyncTransactionHandler-438"><span class="linenos">438</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-439"><a href="#SyncTransactionHandler-439"><span class="linenos">439</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-440"><a href="#SyncTransactionHandler-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-441"><a href="#SyncTransactionHandler-441"><span class="linenos">441</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-442"><a href="#SyncTransactionHandler-442"><span class="linenos">442</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler-443"><a href="#SyncTransactionHandler-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-444"><a href="#SyncTransactionHandler-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-445"><a href="#SyncTransactionHandler-445"><span class="linenos">445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler-446"><a href="#SyncTransactionHandler-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-447"><a href="#SyncTransactionHandler-447"><span class="linenos">447</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-448"><a href="#SyncTransactionHandler-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler-449"><a href="#SyncTransactionHandler-449"><span class="linenos">449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-450"><a href="#SyncTransactionHandler-450"><span class="linenos">450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-451"><a href="#SyncTransactionHandler-451"><span class="linenos">451</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler-452"><a href="#SyncTransactionHandler-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler-453"><a href="#SyncTransactionHandler-453"><span class="linenos">453</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler-454"><a href="#SyncTransactionHandler-454"><span class="linenos">454</span></a>        <span class="c1"># except TypeError as e:</span>
</span><span id="SyncTransactionHandler-455"><a href="#SyncTransactionHandler-455"><span class="linenos">455</span></a>        <span class="c1">#     self.logger.error(&quot;TypeError: %s : %s&quot; % (self.port_name, str(e)))</span>
</span><span id="SyncTransactionHandler-456"><a href="#SyncTransactionHandler-456"><span class="linenos">456</span></a>        <span class="c1">#     self.ser=None</span>
</span></pre></div>


    

                            <div id="SyncTransactionHandler.__init__" class="classattr">
                                        <input id="SyncTransactionHandler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SyncTransactionHandler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">port_name</span>, </span><span class="param"><span class="n">ser</span>, </span><span class="param"><span class="n">logger</span>, </span><span class="param"><span class="n">lock</span></span>)</span>

                <label class="view-source-button" for="SyncTransactionHandler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.__init__-77"><a href="#SyncTransactionHandler.__init__-77"><span class="linenos">77</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.__init__-78"><a href="#SyncTransactionHandler.__init__-78"><span class="linenos">78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">ser</span>
</span><span id="SyncTransactionHandler.__init__-79"><a href="#SyncTransactionHandler.__init__-79"><span class="linenos">79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="SyncTransactionHandler.__init__-80"><a href="#SyncTransactionHandler.__init__-80"><span class="linenos">80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">port_name</span>
</span><span id="SyncTransactionHandler.__init__-81"><a href="#SyncTransactionHandler.__init__-81"><span class="linenos">81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.__init__-82"><a href="#SyncTransactionHandler.__init__-82"><span class="linenos">82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;read_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;write_error&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;transactions&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
</span><span id="SyncTransactionHandler.__init__-83"><a href="#SyncTransactionHandler.__init__-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span><span id="SyncTransactionHandler.__init__-84"><a href="#SyncTransactionHandler.__init__-84"><span class="linenos">84</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">.2</span>  <span class="c1"># Was .05 but on heavy loads can get starved</span>
</span><span id="SyncTransactionHandler.__init__-85"><a href="#SyncTransactionHandler.__init__-85"><span class="linenos">85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler.__init__-86"><a href="#SyncTransactionHandler.__init__-86"><span class="linenos">86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">lock</span>
</span><span id="SyncTransactionHandler.__init__-87"><a href="#SyncTransactionHandler.__init__-87"><span class="linenos">87</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span id="SyncTransactionHandler.__init__-88"><a href="#SyncTransactionHandler.__init__-88"><span class="linenos">88</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span> <span class="o">=</span> <span class="mi">0</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.ser" class="classattr">
                                <div class="attr variable">
            <span class="name">ser</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.ser"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.logger" class="classattr">
                                <div class="attr variable">
            <span class="name">logger</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.logger"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.port_name" class="classattr">
                                <div class="attr variable">
            <span class="name">port_name</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.port_name"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.empty_frame" class="classattr">
                                <div class="attr variable">
            <span class="name">empty_frame</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.empty_frame"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.status" class="classattr">
                                <div class="attr variable">
            <span class="name">status</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.status"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.version" class="classattr">
                                <div class="attr variable">
            <span class="name">version</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.version"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.timeout" class="classattr">
                                <div class="attr variable">
            <span class="name">timeout</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.timeout"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.packet_marker" class="classattr">
                                <div class="attr variable">
            <span class="name">packet_marker</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.packet_marker"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.lock" class="classattr">
                                <div class="attr variable">
            <span class="name">lock</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.lock"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.dbg_buf" class="classattr">
                                <div class="attr variable">
            <span class="name">dbg_buf</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.dbg_buf"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.dbg_on" class="classattr">
                                <div class="attr variable">
            <span class="name">dbg_on</span>

        
    </div>
    <a class="headerlink" href="#SyncTransactionHandler.dbg_on"></a>
    
    

                            </div>
                            <div id="SyncTransactionHandler.get_empty_frame" class="classattr">
                                        <input id="SyncTransactionHandler.get_empty_frame-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_empty_frame</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.get_empty_frame-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.get_empty_frame"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.get_empty_frame-90"><a href="#SyncTransactionHandler.get_empty_frame-90"><span class="linenos">90</span></a>    <span class="k">def</span> <span class="nf">get_empty_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="SyncTransactionHandler.get_empty_frame-91"><a href="#SyncTransactionHandler.get_empty_frame-91"><span class="linenos">91</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_frame</span><span class="p">[:]</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.handle_push_ack_v1" class="classattr">
                                        <input id="SyncTransactionHandler.handle_push_ack_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_push_ack_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">crc</span>, </span><span class="param"><span class="n">nr</span>, </span><span class="param"><span class="n">ack_code</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.handle_push_ack_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.handle_push_ack_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.handle_push_ack_v1-93"><a href="#SyncTransactionHandler.handle_push_ack_v1-93"><span class="linenos"> 93</span></a>    <span class="k">def</span> <span class="nf">handle_push_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-94"><a href="#SyncTransactionHandler.handle_push_ack_v1-94"><span class="linenos"> 94</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-95"><a href="#SyncTransactionHandler.handle_push_ack_v1-95"><span class="linenos"> 95</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-96"><a href="#SyncTransactionHandler.handle_push_ack_v1-96"><span class="linenos"> 96</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-97"><a href="#SyncTransactionHandler.handle_push_ack_v1-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-98"><a href="#SyncTransactionHandler.handle_push_ack_v1-98"><span class="linenos"> 98</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-99"><a href="#SyncTransactionHandler.handle_push_ack_v1-99"><span class="linenos"> 99</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V1_PUSH_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler.handle_push_ack_v1-100"><a href="#SyncTransactionHandler.handle_push_ack_v1-100"><span class="linenos">100</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PUSH_ACK</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-101"><a href="#SyncTransactionHandler.handle_push_ack_v1-101"><span class="linenos">101</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-102"><a href="#SyncTransactionHandler.handle_push_ack_v1-102"><span class="linenos">102</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PUSH_ACK&#39;</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-103"><a href="#SyncTransactionHandler.handle_push_ack_v1-103"><span class="linenos">103</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-104"><a href="#SyncTransactionHandler.handle_push_ack_v1-104"><span class="linenos">104</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-105"><a href="#SyncTransactionHandler.handle_push_ack_v1-105"><span class="linenos">105</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-106"><a href="#SyncTransactionHandler.handle_push_ack_v1-106"><span class="linenos">106</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-107"><a href="#SyncTransactionHandler.handle_push_ack_v1-107"><span class="linenos">107</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V1_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.handle_push_ack_v1-108"><a href="#SyncTransactionHandler.handle_push_ack_v1-108"><span class="linenos">108</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for code readability</p>
</div>


                            </div>
                            <div id="SyncTransactionHandler.handle_pull_ack_v1" class="classattr">
                                        <input id="SyncTransactionHandler.handle_pull_ack_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">handle_pull_ack_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">crc</span>, </span><span class="param"><span class="n">nr</span>, </span><span class="param"><span class="n">ack_code</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.handle_pull_ack_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.handle_pull_ack_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.handle_pull_ack_v1-110"><a href="#SyncTransactionHandler.handle_pull_ack_v1-110"><span class="linenos">110</span></a>    <span class="k">def</span> <span class="nf">handle_pull_ack_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-111"><a href="#SyncTransactionHandler.handle_pull_ack_v1-111"><span class="linenos">111</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-112"><a href="#SyncTransactionHandler.handle_pull_ack_v1-112"><span class="linenos">112</span></a><span class="sd">        Utility function for code readability</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-113"><a href="#SyncTransactionHandler.handle_pull_ack_v1-113"><span class="linenos">113</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-114"><a href="#SyncTransactionHandler.handle_pull_ack_v1-114"><span class="linenos">114</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-115"><a href="#SyncTransactionHandler.handle_pull_ack_v1-115"><span class="linenos">115</span></a>            <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-116"><a href="#SyncTransactionHandler.handle_pull_ack_v1-116"><span class="linenos">116</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_PULL_ACK CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-117"><a href="#SyncTransactionHandler.handle_pull_ack_v1-117"><span class="linenos">117</span></a>                               <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ack_code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">)</span> <span class="o">+</span> \
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-118"><a href="#SyncTransactionHandler.handle_pull_ack_v1-118"><span class="linenos">118</span></a>                               <span class="s1">&#39; OR B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-119"><a href="#SyncTransactionHandler.handle_pull_ack_v1-119"><span class="linenos">119</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-120"><a href="#SyncTransactionHandler.handle_pull_ack_v1-120"><span class="linenos">120</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_PULL_ACK&#39;</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-121"><a href="#SyncTransactionHandler.handle_pull_ack_v1-121"><span class="linenos">121</span></a>        <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-122"><a href="#SyncTransactionHandler.handle_pull_ack_v1-122"><span class="linenos">122</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport CRC Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-123"><a href="#SyncTransactionHandler.handle_pull_ack_v1-123"><span class="linenos">123</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-124"><a href="#SyncTransactionHandler.handle_pull_ack_v1-124"><span class="linenos">124</span></a>        <span class="k">if</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span> <span class="ow">and</span> <span class="n">ack_code</span> <span class="o">!=</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-125"><a href="#SyncTransactionHandler.handle_pull_ack_v1-125"><span class="linenos">125</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_PUSH_ACK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">ack_code</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.handle_pull_ack_v1-126"><a href="#SyncTransactionHandler.handle_pull_ack_v1-126"><span class="linenos">126</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span></pre></div>


            <div class="docstring"><p>Utility function for code readability</p>
</div>


                            </div>
                            <div id="SyncTransactionHandler.sendFramedData" class="classattr">
                                        <input id="SyncTransactionHandler.sendFramedData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sendFramedData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">size</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.sendFramedData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.sendFramedData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.sendFramedData-128"><a href="#SyncTransactionHandler.sendFramedData-128"><span class="linenos">128</span></a>    <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.sendFramedData-129"><a href="#SyncTransactionHandler.sendFramedData-129"><span class="linenos">129</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.sendFramedData-130"><a href="#SyncTransactionHandler.sendFramedData-130"><span class="linenos">130</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="SyncTransactionHandler.sendFramedData-131"><a href="#SyncTransactionHandler.sendFramedData-131"><span class="linenos">131</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.receiveFramedData" class="classattr">
                                        <input id="SyncTransactionHandler.receiveFramedData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">receiveFramedData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.receiveFramedData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.receiveFramedData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.receiveFramedData-133"><a href="#SyncTransactionHandler.receiveFramedData-133"><span class="linenos">133</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.receiveFramedData-134"><a href="#SyncTransactionHandler.receiveFramedData-134"><span class="linenos">134</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.receiveFramedData-135"><a href="#SyncTransactionHandler.receiveFramedData-135"><span class="linenos">135</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SyncTransactionHandler.receiveFramedData-136"><a href="#SyncTransactionHandler.receiveFramedData-136"><span class="linenos">136</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.receiveFramedData-137"><a href="#SyncTransactionHandler.receiveFramedData-137"><span class="linenos">137</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.receiveFramedData-138"><a href="#SyncTransactionHandler.receiveFramedData-138"><span class="linenos">138</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.receiveFramedData-139"><a href="#SyncTransactionHandler.receiveFramedData-139"><span class="linenos">139</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.receiveFramedData-140"><a href="#SyncTransactionHandler.receiveFramedData-140"><span class="linenos">140</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.receiveFramedData-141"><a href="#SyncTransactionHandler.receiveFramedData-141"><span class="linenos">141</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler.receiveFramedData-142"><a href="#SyncTransactionHandler.receiveFramedData-142"><span class="linenos">142</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.receiveFramedData-143"><a href="#SyncTransactionHandler.receiveFramedData-143"><span class="linenos">143</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.receiveFramedData-144"><a href="#SyncTransactionHandler.receiveFramedData-144"><span class="linenos">144</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.receiveFramedData-145"><a href="#SyncTransactionHandler.receiveFramedData-145"><span class="linenos">145</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="SyncTransactionHandler.receiveFramedData-146"><a href="#SyncTransactionHandler.receiveFramedData-146"><span class="linenos">146</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="SyncTransactionHandler.receiveFramedData-147"><a href="#SyncTransactionHandler.receiveFramedData-147"><span class="linenos">147</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.receiveFramedData-148"><a href="#SyncTransactionHandler.receiveFramedData-148"><span class="linenos">148</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.receiveFramedData-149"><a href="#SyncTransactionHandler.receiveFramedData-149"><span class="linenos">149</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.receiveFramedData-150"><a href="#SyncTransactionHandler.receiveFramedData-150"><span class="linenos">150</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.receiveFramedData-151"><a href="#SyncTransactionHandler.receiveFramedData-151"><span class="linenos">151</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.receiveFramedData2" class="classattr">
                                        <input id="SyncTransactionHandler.receiveFramedData2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">receiveFramedData2</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.receiveFramedData2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.receiveFramedData2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.receiveFramedData2-153"><a href="#SyncTransactionHandler.receiveFramedData2-153"><span class="linenos">153</span></a>    <span class="k">def</span> <span class="nf">receiveFramedData2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-154"><a href="#SyncTransactionHandler.receiveFramedData2-154"><span class="linenos">154</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-155"><a href="#SyncTransactionHandler.receiveFramedData2-155"><span class="linenos">155</span></a>        <span class="n">rbuf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">terminator</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">RPC_MAX_FRAME_SIZE</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-156"><a href="#SyncTransactionHandler.receiveFramedData2-156"><span class="linenos">156</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rbuf</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-157"><a href="#SyncTransactionHandler.receiveFramedData2-157"><span class="linenos">157</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Transport invalid read </span><span class="si">%d</span><span class="s1"> bytes during _recv_framed_data&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">rbuf</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-158"><a href="#SyncTransactionHandler.receiveFramedData2-158"><span class="linenos">158</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-159"><a href="#SyncTransactionHandler.receiveFramedData2-159"><span class="linenos">159</span></a>        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rbuf</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</span><span id="SyncTransactionHandler.receiveFramedData2-160"><a href="#SyncTransactionHandler.receiveFramedData2-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.do_rpc" class="classattr">
                                        <input id="SyncTransactionHandler.do_rpc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_rpc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">push</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.do_rpc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.do_rpc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.do_rpc-162"><a href="#SyncTransactionHandler.do_rpc-162"><span class="linenos">162</span></a>    <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_rpc-163"><a href="#SyncTransactionHandler.do_rpc-163"><span class="linenos">163</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-164"><a href="#SyncTransactionHandler.do_rpc-164"><span class="linenos">164</span></a>            <span class="k">return</span>
</span><span id="SyncTransactionHandler.do_rpc-165"><a href="#SyncTransactionHandler.do_rpc-165"><span class="linenos">165</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_rpc-166"><a href="#SyncTransactionHandler.do_rpc-166"><span class="linenos">166</span></a>        <span class="k">if</span> <span class="n">exiting</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-167"><a href="#SyncTransactionHandler.do_rpc-167"><span class="linenos">167</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="SyncTransactionHandler.do_rpc-168"><a href="#SyncTransactionHandler.do_rpc-168"><span class="linenos">168</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_rpc-169"><a href="#SyncTransactionHandler.do_rpc-169"><span class="linenos">169</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_rpc-170"><a href="#SyncTransactionHandler.do_rpc-170"><span class="linenos">170</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="SyncTransactionHandler.do_rpc-171"><a href="#SyncTransactionHandler.do_rpc-171"><span class="linenos">171</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-172"><a href="#SyncTransactionHandler.do_rpc-172"><span class="linenos">172</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="SyncTransactionHandler.do_rpc-173"><a href="#SyncTransactionHandler.do_rpc-173"><span class="linenos">173</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-174"><a href="#SyncTransactionHandler.do_rpc-174"><span class="linenos">174</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-175"><a href="#SyncTransactionHandler.do_rpc-175"><span class="linenos">175</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_rpc-176"><a href="#SyncTransactionHandler.do_rpc-176"><span class="linenos">176</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-177"><a href="#SyncTransactionHandler.do_rpc-177"><span class="linenos">177</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_rpc-178"><a href="#SyncTransactionHandler.do_rpc-178"><span class="linenos">178</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-179"><a href="#SyncTransactionHandler.do_rpc-179"><span class="linenos">179</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-180"><a href="#SyncTransactionHandler.do_rpc-180"><span class="linenos">180</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_rpc-181"><a href="#SyncTransactionHandler.do_rpc-181"><span class="linenos">181</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-182"><a href="#SyncTransactionHandler.do_rpc-182"><span class="linenos">182</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_rpc-183"><a href="#SyncTransactionHandler.do_rpc-183"><span class="linenos">183</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-184"><a href="#SyncTransactionHandler.do_rpc-184"><span class="linenos">184</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.do_rpc-185"><a href="#SyncTransactionHandler.do_rpc-185"><span class="linenos">185</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_rpc-186"><a href="#SyncTransactionHandler.do_rpc-186"><span class="linenos">186</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_rpc-187"><a href="#SyncTransactionHandler.do_rpc-187"><span class="linenos">187</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_rpc-188"><a href="#SyncTransactionHandler.do_rpc-188"><span class="linenos">188</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="SyncTransactionHandler.do_push_transaction_v1" class="classattr">
                                        <input id="SyncTransactionHandler.do_push_transaction_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_push_transaction_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc_data</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.do_push_transaction_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.do_push_transaction_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.do_push_transaction_v1-190"><a href="#SyncTransactionHandler.do_push_transaction_v1-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-191"><a href="#SyncTransactionHandler.do_push_transaction_v1-191"><span class="linenos">191</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-192"><a href="#SyncTransactionHandler.do_push_transaction_v1-192"><span class="linenos">192</span></a><span class="sd">                Parameters</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-193"><a href="#SyncTransactionHandler.do_push_transaction_v1-193"><span class="linenos">193</span></a><span class="sd">        ----------</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-194"><a href="#SyncTransactionHandler.do_push_transaction_v1-194"><span class="linenos">194</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-195"><a href="#SyncTransactionHandler.do_push_transaction_v1-195"><span class="linenos">195</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-196"><a href="#SyncTransactionHandler.do_push_transaction_v1-196"><span class="linenos">196</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-197"><a href="#SyncTransactionHandler.do_push_transaction_v1-197"><span class="linenos">197</span></a><span class="sd">        -------</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-198"><a href="#SyncTransactionHandler.do_push_transaction_v1-198"><span class="linenos">198</span></a><span class="sd">        Push command data</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-199"><a href="#SyncTransactionHandler.do_push_transaction_v1-199"><span class="linenos">199</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-200"><a href="#SyncTransactionHandler.do_push_transaction_v1-200"><span class="linenos">200</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-201"><a href="#SyncTransactionHandler.do_push_transaction_v1-201"><span class="linenos">201</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-202"><a href="#SyncTransactionHandler.do_push_transaction_v1-202"><span class="linenos">202</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-203"><a href="#SyncTransactionHandler.do_push_transaction_v1-203"><span class="linenos">203</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-204"><a href="#SyncTransactionHandler.do_push_transaction_v1-204"><span class="linenos">204</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-205"><a href="#SyncTransactionHandler.do_push_transaction_v1-205"><span class="linenos">205</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-206"><a href="#SyncTransactionHandler.do_push_transaction_v1-206"><span class="linenos">206</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-207"><a href="#SyncTransactionHandler.do_push_transaction_v1-207"><span class="linenos">207</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-208"><a href="#SyncTransactionHandler.do_push_transaction_v1-208"><span class="linenos">208</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-209"><a href="#SyncTransactionHandler.do_push_transaction_v1-209"><span class="linenos">209</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-210"><a href="#SyncTransactionHandler.do_push_transaction_v1-210"><span class="linenos">210</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-211"><a href="#SyncTransactionHandler.do_push_transaction_v1-211"><span class="linenos">211</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-212"><a href="#SyncTransactionHandler.do_push_transaction_v1-212"><span class="linenos">212</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-213"><a href="#SyncTransactionHandler.do_push_transaction_v1-213"><span class="linenos">213</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-214"><a href="#SyncTransactionHandler.do_push_transaction_v1-214"><span class="linenos">214</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-215"><a href="#SyncTransactionHandler.do_push_transaction_v1-215"><span class="linenos">215</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-216"><a href="#SyncTransactionHandler.do_push_transaction_v1-216"><span class="linenos">216</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-217"><a href="#SyncTransactionHandler.do_push_transaction_v1-217"><span class="linenos">217</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-218"><a href="#SyncTransactionHandler.do_push_transaction_v1-218"><span class="linenos">218</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-219"><a href="#SyncTransactionHandler.do_push_transaction_v1-219"><span class="linenos">219</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-220"><a href="#SyncTransactionHandler.do_push_transaction_v1-220"><span class="linenos">220</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-221"><a href="#SyncTransactionHandler.do_push_transaction_v1-221"><span class="linenos">221</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-222"><a href="#SyncTransactionHandler.do_push_transaction_v1-222"><span class="linenos">222</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-223"><a href="#SyncTransactionHandler.do_push_transaction_v1-223"><span class="linenos">223</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-224"><a href="#SyncTransactionHandler.do_push_transaction_v1-224"><span class="linenos">224</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-225"><a href="#SyncTransactionHandler.do_push_transaction_v1-225"><span class="linenos">225</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-226"><a href="#SyncTransactionHandler.do_push_transaction_v1-226"><span class="linenos">226</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-227"><a href="#SyncTransactionHandler.do_push_transaction_v1-227"><span class="linenos">227</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-228"><a href="#SyncTransactionHandler.do_push_transaction_v1-228"><span class="linenos">228</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-229"><a href="#SyncTransactionHandler.do_push_transaction_v1-229"><span class="linenos">229</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-230"><a href="#SyncTransactionHandler.do_push_transaction_v1-230"><span class="linenos">230</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-231"><a href="#SyncTransactionHandler.do_push_transaction_v1-231"><span class="linenos">231</span></a>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-232"><a href="#SyncTransactionHandler.do_push_transaction_v1-232"><span class="linenos">232</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-233"><a href="#SyncTransactionHandler.do_push_transaction_v1-233"><span class="linenos">233</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-234"><a href="#SyncTransactionHandler.do_push_transaction_v1-234"><span class="linenos">234</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-235"><a href="#SyncTransactionHandler.do_push_transaction_v1-235"><span class="linenos">235</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-236"><a href="#SyncTransactionHandler.do_push_transaction_v1-236"><span class="linenos">236</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-237"><a href="#SyncTransactionHandler.do_push_transaction_v1-237"><span class="linenos">237</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-238"><a href="#SyncTransactionHandler.do_push_transaction_v1-238"><span class="linenos">238</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-239"><a href="#SyncTransactionHandler.do_push_transaction_v1-239"><span class="linenos">239</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-240"><a href="#SyncTransactionHandler.do_push_transaction_v1-240"><span class="linenos">240</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-241"><a href="#SyncTransactionHandler.do_push_transaction_v1-241"><span class="linenos">241</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-242"><a href="#SyncTransactionHandler.do_push_transaction_v1-242"><span class="linenos">242</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-243"><a href="#SyncTransactionHandler.do_push_transaction_v1-243"><span class="linenos">243</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-244"><a href="#SyncTransactionHandler.do_push_transaction_v1-244"><span class="linenos">244</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-245"><a href="#SyncTransactionHandler.do_push_transaction_v1-245"><span class="linenos">245</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-246"><a href="#SyncTransactionHandler.do_push_transaction_v1-246"><span class="linenos">246</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-247"><a href="#SyncTransactionHandler.do_push_transaction_v1-247"><span class="linenos">247</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-248"><a href="#SyncTransactionHandler.do_push_transaction_v1-248"><span class="linenos">248</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-249"><a href="#SyncTransactionHandler.do_push_transaction_v1-249"><span class="linenos">249</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-250"><a href="#SyncTransactionHandler.do_push_transaction_v1-250"><span class="linenos">250</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-251"><a href="#SyncTransactionHandler.do_push_transaction_v1-251"><span class="linenos">251</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-252"><a href="#SyncTransactionHandler.do_push_transaction_v1-252"><span class="linenos">252</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-253"><a href="#SyncTransactionHandler.do_push_transaction_v1-253"><span class="linenos">253</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-254"><a href="#SyncTransactionHandler.do_push_transaction_v1-254"><span class="linenos">254</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-255"><a href="#SyncTransactionHandler.do_push_transaction_v1-255"><span class="linenos">255</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-256"><a href="#SyncTransactionHandler.do_push_transaction_v1-256"><span class="linenos">256</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-257"><a href="#SyncTransactionHandler.do_push_transaction_v1-257"><span class="linenos">257</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-258"><a href="#SyncTransactionHandler.do_push_transaction_v1-258"><span class="linenos">258</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-259"><a href="#SyncTransactionHandler.do_push_transaction_v1-259"><span class="linenos">259</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-260"><a href="#SyncTransactionHandler.do_push_transaction_v1-260"><span class="linenos">260</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-261"><a href="#SyncTransactionHandler.do_push_transaction_v1-261"><span class="linenos">261</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-262"><a href="#SyncTransactionHandler.do_push_transaction_v1-262"><span class="linenos">262</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-263"><a href="#SyncTransactionHandler.do_push_transaction_v1-263"><span class="linenos">263</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-264"><a href="#SyncTransactionHandler.do_push_transaction_v1-264"><span class="linenos">264</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-265"><a href="#SyncTransactionHandler.do_push_transaction_v1-265"><span class="linenos">265</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-266"><a href="#SyncTransactionHandler.do_push_transaction_v1-266"><span class="linenos">266</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-267"><a href="#SyncTransactionHandler.do_push_transaction_v1-267"><span class="linenos">267</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-268"><a href="#SyncTransactionHandler.do_push_transaction_v1-268"><span class="linenos">268</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-269"><a href="#SyncTransactionHandler.do_push_transaction_v1-269"><span class="linenos">269</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-270"><a href="#SyncTransactionHandler.do_push_transaction_v1-270"><span class="linenos">270</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_push_transaction_v1-271"><a href="#SyncTransactionHandler.do_push_transaction_v1-271"><span class="linenos">271</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>rpc_data: Buffer of data to transmit in RPC
rpc_callback: Call back to process RPC reply data</p>

<h2 id="returns-truefalse-if-successful">Returns: True/False if successful</h2>

<p>Push command data
Take the rpc_data, break into 64 byte encoded frames, and write to serial.
Recieve back acks for each frame sent</p>

<p>RPC data looks like:
rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</p>

<p>The rpc_data is then grouped into one or more 59 byte frames.</p>

<p>For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</p>

<p>push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</p>

<p>If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</p>

<p>frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)
frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)
frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</p>

<p>Before transmission each frame is first Cobbs encoded as:</p>

<p>[ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</p>

<p>A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was
succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</p>

<p>reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</p>

<p>Finally, reply data is decoded and passed to the rpc_callback</p>
</div>


                            </div>
                            <div id="SyncTransactionHandler.do_pull_transaction_v1" class="classattr">
                                        <input id="SyncTransactionHandler.do_pull_transaction_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_pull_transaction_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc_data</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.do_pull_transaction_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.do_pull_transaction_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.do_pull_transaction_v1-273"><a href="#SyncTransactionHandler.do_pull_transaction_v1-273"><span class="linenos">273</span></a>    <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-274"><a href="#SyncTransactionHandler.do_pull_transaction_v1-274"><span class="linenos">274</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-275"><a href="#SyncTransactionHandler.do_pull_transaction_v1-275"><span class="linenos">275</span></a><span class="sd">                Parameters</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-276"><a href="#SyncTransactionHandler.do_pull_transaction_v1-276"><span class="linenos">276</span></a><span class="sd">        ----------</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-277"><a href="#SyncTransactionHandler.do_pull_transaction_v1-277"><span class="linenos">277</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-278"><a href="#SyncTransactionHandler.do_pull_transaction_v1-278"><span class="linenos">278</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-279"><a href="#SyncTransactionHandler.do_pull_transaction_v1-279"><span class="linenos">279</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-280"><a href="#SyncTransactionHandler.do_pull_transaction_v1-280"><span class="linenos">280</span></a><span class="sd">        -------</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-281"><a href="#SyncTransactionHandler.do_pull_transaction_v1-281"><span class="linenos">281</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-282"><a href="#SyncTransactionHandler.do_pull_transaction_v1-282"><span class="linenos">282</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-283"><a href="#SyncTransactionHandler.do_pull_transaction_v1-283"><span class="linenos">283</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-284"><a href="#SyncTransactionHandler.do_pull_transaction_v1-284"><span class="linenos">284</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-285"><a href="#SyncTransactionHandler.do_pull_transaction_v1-285"><span class="linenos">285</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-286"><a href="#SyncTransactionHandler.do_pull_transaction_v1-286"><span class="linenos">286</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-287"><a href="#SyncTransactionHandler.do_pull_transaction_v1-287"><span class="linenos">287</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-288"><a href="#SyncTransactionHandler.do_pull_transaction_v1-288"><span class="linenos">288</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-289"><a href="#SyncTransactionHandler.do_pull_transaction_v1-289"><span class="linenos">289</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-290"><a href="#SyncTransactionHandler.do_pull_transaction_v1-290"><span class="linenos">290</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-291"><a href="#SyncTransactionHandler.do_pull_transaction_v1-291"><span class="linenos">291</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-292"><a href="#SyncTransactionHandler.do_pull_transaction_v1-292"><span class="linenos">292</span></a>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-293"><a href="#SyncTransactionHandler.do_pull_transaction_v1-293"><span class="linenos">293</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-294"><a href="#SyncTransactionHandler.do_pull_transaction_v1-294"><span class="linenos">294</span></a>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-295"><a href="#SyncTransactionHandler.do_pull_transaction_v1-295"><span class="linenos">295</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-296"><a href="#SyncTransactionHandler.do_pull_transaction_v1-296"><span class="linenos">296</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-297"><a href="#SyncTransactionHandler.do_pull_transaction_v1-297"><span class="linenos">297</span></a>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-298"><a href="#SyncTransactionHandler.do_pull_transaction_v1-298"><span class="linenos">298</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-299"><a href="#SyncTransactionHandler.do_pull_transaction_v1-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-300"><a href="#SyncTransactionHandler.do_pull_transaction_v1-300"><span class="linenos">300</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-301"><a href="#SyncTransactionHandler.do_pull_transaction_v1-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-302"><a href="#SyncTransactionHandler.do_pull_transaction_v1-302"><span class="linenos">302</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-303"><a href="#SyncTransactionHandler.do_pull_transaction_v1-303"><span class="linenos">303</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-304"><a href="#SyncTransactionHandler.do_pull_transaction_v1-304"><span class="linenos">304</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-305"><a href="#SyncTransactionHandler.do_pull_transaction_v1-305"><span class="linenos">305</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-306"><a href="#SyncTransactionHandler.do_pull_transaction_v1-306"><span class="linenos">306</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-307"><a href="#SyncTransactionHandler.do_pull_transaction_v1-307"><span class="linenos">307</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-308"><a href="#SyncTransactionHandler.do_pull_transaction_v1-308"><span class="linenos">308</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-309"><a href="#SyncTransactionHandler.do_pull_transaction_v1-309"><span class="linenos">309</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-310"><a href="#SyncTransactionHandler.do_pull_transaction_v1-310"><span class="linenos">310</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-311"><a href="#SyncTransactionHandler.do_pull_transaction_v1-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-312"><a href="#SyncTransactionHandler.do_pull_transaction_v1-312"><span class="linenos">312</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-313"><a href="#SyncTransactionHandler.do_pull_transaction_v1-313"><span class="linenos">313</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-314"><a href="#SyncTransactionHandler.do_pull_transaction_v1-314"><span class="linenos">314</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-315"><a href="#SyncTransactionHandler.do_pull_transaction_v1-315"><span class="linenos">315</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-316"><a href="#SyncTransactionHandler.do_pull_transaction_v1-316"><span class="linenos">316</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-317"><a href="#SyncTransactionHandler.do_pull_transaction_v1-317"><span class="linenos">317</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-318"><a href="#SyncTransactionHandler.do_pull_transaction_v1-318"><span class="linenos">318</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-319"><a href="#SyncTransactionHandler.do_pull_transaction_v1-319"><span class="linenos">319</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-320"><a href="#SyncTransactionHandler.do_pull_transaction_v1-320"><span class="linenos">320</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-321"><a href="#SyncTransactionHandler.do_pull_transaction_v1-321"><span class="linenos">321</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-322"><a href="#SyncTransactionHandler.do_pull_transaction_v1-322"><span class="linenos">322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-323"><a href="#SyncTransactionHandler.do_pull_transaction_v1-323"><span class="linenos">323</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-324"><a href="#SyncTransactionHandler.do_pull_transaction_v1-324"><span class="linenos">324</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-325"><a href="#SyncTransactionHandler.do_pull_transaction_v1-325"><span class="linenos">325</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-326"><a href="#SyncTransactionHandler.do_pull_transaction_v1-326"><span class="linenos">326</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-327"><a href="#SyncTransactionHandler.do_pull_transaction_v1-327"><span class="linenos">327</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-328"><a href="#SyncTransactionHandler.do_pull_transaction_v1-328"><span class="linenos">328</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-329"><a href="#SyncTransactionHandler.do_pull_transaction_v1-329"><span class="linenos">329</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-330"><a href="#SyncTransactionHandler.do_pull_transaction_v1-330"><span class="linenos">330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_pull_transaction_v1-331"><a href="#SyncTransactionHandler.do_pull_transaction_v1-331"><span class="linenos">331</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>rpc_data: Buffer of data to transmit in RPC
rpc_callback: Call back to process RPC reply data</p>

<h2 id="returns-truefalse-if-successful">Returns: True/False if successful</h2>

<p>This pulls status data from the device. The frame layout is analogous to do_push_transaction.
However, here we send down only a pull request (single frame with an RPC_ID).
We get back one or more frames of status data which is then decoded and passed to the callback.</p>
</div>


                            </div>
                            <div id="SyncTransactionHandler.do_transaction_v0" class="classattr">
                                        <input id="SyncTransactionHandler.do_transaction_v0-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_transaction_v0</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SyncTransactionHandler.do_transaction_v0-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SyncTransactionHandler.do_transaction_v0"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SyncTransactionHandler.do_transaction_v0-333"><a href="#SyncTransactionHandler.do_transaction_v0-333"><span class="linenos">333</span></a>    <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-334"><a href="#SyncTransactionHandler.do_transaction_v0-334"><span class="linenos">334</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-335"><a href="#SyncTransactionHandler.do_transaction_v0-335"><span class="linenos">335</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-336"><a href="#SyncTransactionHandler.do_transaction_v0-336"><span class="linenos">336</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-337"><a href="#SyncTransactionHandler.do_transaction_v0-337"><span class="linenos">337</span></a>                <span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-338"><a href="#SyncTransactionHandler.do_transaction_v0-338"><span class="linenos">338</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-339"><a href="#SyncTransactionHandler.do_transaction_v0-339"><span class="linenos">339</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-340"><a href="#SyncTransactionHandler.do_transaction_v0-340"><span class="linenos">340</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-341"><a href="#SyncTransactionHandler.do_transaction_v0-341"><span class="linenos">341</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-342"><a href="#SyncTransactionHandler.do_transaction_v0-342"><span class="linenos">342</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-343"><a href="#SyncTransactionHandler.do_transaction_v0-343"><span class="linenos">343</span></a>            <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-344"><a href="#SyncTransactionHandler.do_transaction_v0-344"><span class="linenos">344</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-345"><a href="#SyncTransactionHandler.do_transaction_v0-345"><span class="linenos">345</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-346"><a href="#SyncTransactionHandler.do_transaction_v0-346"><span class="linenos">346</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-347"><a href="#SyncTransactionHandler.do_transaction_v0-347"><span class="linenos">347</span></a>                        <span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-348"><a href="#SyncTransactionHandler.do_transaction_v0-348"><span class="linenos">348</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-349"><a href="#SyncTransactionHandler.do_transaction_v0-349"><span class="linenos">349</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-350"><a href="#SyncTransactionHandler.do_transaction_v0-350"><span class="linenos">350</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-351"><a href="#SyncTransactionHandler.do_transaction_v0-351"><span class="linenos">351</span></a>
</span><span id="SyncTransactionHandler.do_transaction_v0-352"><a href="#SyncTransactionHandler.do_transaction_v0-352"><span class="linenos">352</span></a>            <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-353"><a href="#SyncTransactionHandler.do_transaction_v0-353"><span class="linenos">353</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-354"><a href="#SyncTransactionHandler.do_transaction_v0-354"><span class="linenos">354</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-355"><a href="#SyncTransactionHandler.do_transaction_v0-355"><span class="linenos">355</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-356"><a href="#SyncTransactionHandler.do_transaction_v0-356"><span class="linenos">356</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-357"><a href="#SyncTransactionHandler.do_transaction_v0-357"><span class="linenos">357</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-358"><a href="#SyncTransactionHandler.do_transaction_v0-358"><span class="linenos">358</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-359"><a href="#SyncTransactionHandler.do_transaction_v0-359"><span class="linenos">359</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-360"><a href="#SyncTransactionHandler.do_transaction_v0-360"><span class="linenos">360</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-361"><a href="#SyncTransactionHandler.do_transaction_v0-361"><span class="linenos">361</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-362"><a href="#SyncTransactionHandler.do_transaction_v0-362"><span class="linenos">362</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-363"><a href="#SyncTransactionHandler.do_transaction_v0-363"><span class="linenos">363</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-364"><a href="#SyncTransactionHandler.do_transaction_v0-364"><span class="linenos">364</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-365"><a href="#SyncTransactionHandler.do_transaction_v0-365"><span class="linenos">365</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-366"><a href="#SyncTransactionHandler.do_transaction_v0-366"><span class="linenos">366</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-367"><a href="#SyncTransactionHandler.do_transaction_v0-367"><span class="linenos">367</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-368"><a href="#SyncTransactionHandler.do_transaction_v0-368"><span class="linenos">368</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-369"><a href="#SyncTransactionHandler.do_transaction_v0-369"><span class="linenos">369</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-370"><a href="#SyncTransactionHandler.do_transaction_v0-370"><span class="linenos">370</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-371"><a href="#SyncTransactionHandler.do_transaction_v0-371"><span class="linenos">371</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-372"><a href="#SyncTransactionHandler.do_transaction_v0-372"><span class="linenos">372</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-373"><a href="#SyncTransactionHandler.do_transaction_v0-373"><span class="linenos">373</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-374"><a href="#SyncTransactionHandler.do_transaction_v0-374"><span class="linenos">374</span></a>
</span><span id="SyncTransactionHandler.do_transaction_v0-375"><a href="#SyncTransactionHandler.do_transaction_v0-375"><span class="linenos">375</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-376"><a href="#SyncTransactionHandler.do_transaction_v0-376"><span class="linenos">376</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-377"><a href="#SyncTransactionHandler.do_transaction_v0-377"><span class="linenos">377</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-378"><a href="#SyncTransactionHandler.do_transaction_v0-378"><span class="linenos">378</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-379"><a href="#SyncTransactionHandler.do_transaction_v0-379"><span class="linenos">379</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-380"><a href="#SyncTransactionHandler.do_transaction_v0-380"><span class="linenos">380</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-381"><a href="#SyncTransactionHandler.do_transaction_v0-381"><span class="linenos">381</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-382"><a href="#SyncTransactionHandler.do_transaction_v0-382"><span class="linenos">382</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-383"><a href="#SyncTransactionHandler.do_transaction_v0-383"><span class="linenos">383</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-384"><a href="#SyncTransactionHandler.do_transaction_v0-384"><span class="linenos">384</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-385"><a href="#SyncTransactionHandler.do_transaction_v0-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-386"><a href="#SyncTransactionHandler.do_transaction_v0-386"><span class="linenos">386</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-387"><a href="#SyncTransactionHandler.do_transaction_v0-387"><span class="linenos">387</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-388"><a href="#SyncTransactionHandler.do_transaction_v0-388"><span class="linenos">388</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-389"><a href="#SyncTransactionHandler.do_transaction_v0-389"><span class="linenos">389</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-390"><a href="#SyncTransactionHandler.do_transaction_v0-390"><span class="linenos">390</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-391"><a href="#SyncTransactionHandler.do_transaction_v0-391"><span class="linenos">391</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-392"><a href="#SyncTransactionHandler.do_transaction_v0-392"><span class="linenos">392</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-393"><a href="#SyncTransactionHandler.do_transaction_v0-393"><span class="linenos">393</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-394"><a href="#SyncTransactionHandler.do_transaction_v0-394"><span class="linenos">394</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-395"><a href="#SyncTransactionHandler.do_transaction_v0-395"><span class="linenos">395</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-396"><a href="#SyncTransactionHandler.do_transaction_v0-396"><span class="linenos">396</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-397"><a href="#SyncTransactionHandler.do_transaction_v0-397"><span class="linenos">397</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-398"><a href="#SyncTransactionHandler.do_transaction_v0-398"><span class="linenos">398</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-399"><a href="#SyncTransactionHandler.do_transaction_v0-399"><span class="linenos">399</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-400"><a href="#SyncTransactionHandler.do_transaction_v0-400"><span class="linenos">400</span></a>                    <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-401"><a href="#SyncTransactionHandler.do_transaction_v0-401"><span class="linenos">401</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-402"><a href="#SyncTransactionHandler.do_transaction_v0-402"><span class="linenos">402</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-403"><a href="#SyncTransactionHandler.do_transaction_v0-403"><span class="linenos">403</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-404"><a href="#SyncTransactionHandler.do_transaction_v0-404"><span class="linenos">404</span></a>                                <span class="n">crc</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-405"><a href="#SyncTransactionHandler.do_transaction_v0-405"><span class="linenos">405</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-406"><a href="#SyncTransactionHandler.do_transaction_v0-406"><span class="linenos">406</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-407"><a href="#SyncTransactionHandler.do_transaction_v0-407"><span class="linenos">407</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-408"><a href="#SyncTransactionHandler.do_transaction_v0-408"><span class="linenos">408</span></a>                    <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-409"><a href="#SyncTransactionHandler.do_transaction_v0-409"><span class="linenos">409</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-410"><a href="#SyncTransactionHandler.do_transaction_v0-410"><span class="linenos">410</span></a>                                                                                                                <span class="n">decoded_data</span><span class="p">[</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-411"><a href="#SyncTransactionHandler.do_transaction_v0-411"><span class="linenos">411</span></a>                                                                                                                    <span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-412"><a href="#SyncTransactionHandler.do_transaction_v0-412"><span class="linenos">412</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-413"><a href="#SyncTransactionHandler.do_transaction_v0-413"><span class="linenos">413</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-414"><a href="#SyncTransactionHandler.do_transaction_v0-414"><span class="linenos">414</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-415"><a href="#SyncTransactionHandler.do_transaction_v0-415"><span class="linenos">415</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-416"><a href="#SyncTransactionHandler.do_transaction_v0-416"><span class="linenos">416</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-417"><a href="#SyncTransactionHandler.do_transaction_v0-417"><span class="linenos">417</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-418"><a href="#SyncTransactionHandler.do_transaction_v0-418"><span class="linenos">418</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-419"><a href="#SyncTransactionHandler.do_transaction_v0-419"><span class="linenos">419</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-420"><a href="#SyncTransactionHandler.do_transaction_v0-420"><span class="linenos">420</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-421"><a href="#SyncTransactionHandler.do_transaction_v0-421"><span class="linenos">421</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-422"><a href="#SyncTransactionHandler.do_transaction_v0-422"><span class="linenos">422</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-423"><a href="#SyncTransactionHandler.do_transaction_v0-423"><span class="linenos">423</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-424"><a href="#SyncTransactionHandler.do_transaction_v0-424"><span class="linenos">424</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-425"><a href="#SyncTransactionHandler.do_transaction_v0-425"><span class="linenos">425</span></a>                <span class="k">if</span> <span class="n">crc</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-426"><a href="#SyncTransactionHandler.do_transaction_v0-426"><span class="linenos">426</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-427"><a href="#SyncTransactionHandler.do_transaction_v0-427"><span class="linenos">427</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-428"><a href="#SyncTransactionHandler.do_transaction_v0-428"><span class="linenos">428</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-429"><a href="#SyncTransactionHandler.do_transaction_v0-429"><span class="linenos">429</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-430"><a href="#SyncTransactionHandler.do_transaction_v0-430"><span class="linenos">430</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-431"><a href="#SyncTransactionHandler.do_transaction_v0-431"><span class="linenos">431</span></a>
</span><span id="SyncTransactionHandler.do_transaction_v0-432"><a href="#SyncTransactionHandler.do_transaction_v0-432"><span class="linenos">432</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-433"><a href="#SyncTransactionHandler.do_transaction_v0-433"><span class="linenos">433</span></a>                    <span class="k">break</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-434"><a href="#SyncTransactionHandler.do_transaction_v0-434"><span class="linenos">434</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-435"><a href="#SyncTransactionHandler.do_transaction_v0-435"><span class="linenos">435</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-436"><a href="#SyncTransactionHandler.do_transaction_v0-436"><span class="linenos">436</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-437"><a href="#SyncTransactionHandler.do_transaction_v0-437"><span class="linenos">437</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-438"><a href="#SyncTransactionHandler.do_transaction_v0-438"><span class="linenos">438</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-439"><a href="#SyncTransactionHandler.do_transaction_v0-439"><span class="linenos">439</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-440"><a href="#SyncTransactionHandler.do_transaction_v0-440"><span class="linenos">440</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-441"><a href="#SyncTransactionHandler.do_transaction_v0-441"><span class="linenos">441</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-442"><a href="#SyncTransactionHandler.do_transaction_v0-442"><span class="linenos">442</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-443"><a href="#SyncTransactionHandler.do_transaction_v0-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-444"><a href="#SyncTransactionHandler.do_transaction_v0-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-445"><a href="#SyncTransactionHandler.do_transaction_v0-445"><span class="linenos">445</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-446"><a href="#SyncTransactionHandler.do_transaction_v0-446"><span class="linenos">446</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-447"><a href="#SyncTransactionHandler.do_transaction_v0-447"><span class="linenos">447</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-448"><a href="#SyncTransactionHandler.do_transaction_v0-448"><span class="linenos">448</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-449"><a href="#SyncTransactionHandler.do_transaction_v0-449"><span class="linenos">449</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-450"><a href="#SyncTransactionHandler.do_transaction_v0-450"><span class="linenos">450</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-451"><a href="#SyncTransactionHandler.do_transaction_v0-451"><span class="linenos">451</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-452"><a href="#SyncTransactionHandler.do_transaction_v0-452"><span class="linenos">452</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-453"><a href="#SyncTransactionHandler.do_transaction_v0-453"><span class="linenos">453</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-454"><a href="#SyncTransactionHandler.do_transaction_v0-454"><span class="linenos">454</span></a>        <span class="c1"># except TypeError as e:</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-455"><a href="#SyncTransactionHandler.do_transaction_v0-455"><span class="linenos">455</span></a>        <span class="c1">#     self.logger.error(&quot;TypeError: %s : %s&quot; % (self.port_name, str(e)))</span>
</span><span id="SyncTransactionHandler.do_transaction_v0-456"><a href="#SyncTransactionHandler.do_transaction_v0-456"><span class="linenos">456</span></a>        <span class="c1">#     self.ser=None</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="AsyncTransactionHandler">
                            <input id="AsyncTransactionHandler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AsyncTransactionHandler</span><wbr>(<span class="base"><a href="#SyncTransactionHandler">SyncTransactionHandler</a></span>):

                <label class="view-source-button" for="AsyncTransactionHandler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler-459"><a href="#AsyncTransactionHandler-459"><span class="linenos">459</span></a><span class="k">class</span> <span class="nc">AsyncTransactionHandler</span><span class="p">(</span><span class="n">SyncTransactionHandler</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-460"><a href="#AsyncTransactionHandler-460"><span class="linenos">460</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-461"><a href="#AsyncTransactionHandler-461"><span class="linenos">461</span></a>        <span class="n">SyncTransactionHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-462"><a href="#AsyncTransactionHandler-462"><span class="linenos">462</span></a>
</span><span id="AsyncTransactionHandler-463"><a href="#AsyncTransactionHandler-463"><span class="linenos">463</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-464"><a href="#AsyncTransactionHandler-464"><span class="linenos">464</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-465"><a href="#AsyncTransactionHandler-465"><span class="linenos">465</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler-466"><a href="#AsyncTransactionHandler-466"><span class="linenos">466</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write_async</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-467"><a href="#AsyncTransactionHandler-467"><span class="linenos">467</span></a>
</span><span id="AsyncTransactionHandler-468"><a href="#AsyncTransactionHandler-468"><span class="linenos">468</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-469"><a href="#AsyncTransactionHandler-469"><span class="linenos">469</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-470"><a href="#AsyncTransactionHandler-470"><span class="linenos">470</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AsyncTransactionHandler-471"><a href="#AsyncTransactionHandler-471"><span class="linenos">471</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-472"><a href="#AsyncTransactionHandler-472"><span class="linenos">472</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-473"><a href="#AsyncTransactionHandler-473"><span class="linenos">473</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-474"><a href="#AsyncTransactionHandler-474"><span class="linenos">474</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-475"><a href="#AsyncTransactionHandler-475"><span class="linenos">475</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-476"><a href="#AsyncTransactionHandler-476"><span class="linenos">476</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler-477"><a href="#AsyncTransactionHandler-477"><span class="linenos">477</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-478"><a href="#AsyncTransactionHandler-478"><span class="linenos">478</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-479"><a href="#AsyncTransactionHandler-479"><span class="linenos">479</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-480"><a href="#AsyncTransactionHandler-480"><span class="linenos">480</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="AsyncTransactionHandler-481"><a href="#AsyncTransactionHandler-481"><span class="linenos">481</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="AsyncTransactionHandler-482"><a href="#AsyncTransactionHandler-482"><span class="linenos">482</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-483"><a href="#AsyncTransactionHandler-483"><span class="linenos">483</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-484"><a href="#AsyncTransactionHandler-484"><span class="linenos">484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-485"><a href="#AsyncTransactionHandler-485"><span class="linenos">485</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-486"><a href="#AsyncTransactionHandler-486"><span class="linenos">486</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="AsyncTransactionHandler-487"><a href="#AsyncTransactionHandler-487"><span class="linenos">487</span></a>
</span><span id="AsyncTransactionHandler-488"><a href="#AsyncTransactionHandler-488"><span class="linenos">488</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-489"><a href="#AsyncTransactionHandler-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-490"><a href="#AsyncTransactionHandler-490"><span class="linenos">490</span></a>            <span class="k">return</span>
</span><span id="AsyncTransactionHandler-491"><a href="#AsyncTransactionHandler-491"><span class="linenos">491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-492"><a href="#AsyncTransactionHandler-492"><span class="linenos">492</span></a>        <span class="c1"># if exiting:</span>
</span><span id="AsyncTransactionHandler-493"><a href="#AsyncTransactionHandler-493"><span class="linenos">493</span></a>        <span class="c1">#     time.sleep(0.1) #May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="AsyncTransactionHandler-494"><a href="#AsyncTransactionHandler-494"><span class="linenos">494</span></a>        <span class="c1">#     self.ser.reset_output_buffer()</span>
</span><span id="AsyncTransactionHandler-495"><a href="#AsyncTransactionHandler-495"><span class="linenos">495</span></a>        <span class="c1">#     self.ser.reset_input_buffer()</span>
</span><span id="AsyncTransactionHandler-496"><a href="#AsyncTransactionHandler-496"><span class="linenos">496</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="AsyncTransactionHandler-497"><a href="#AsyncTransactionHandler-497"><span class="linenos">497</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-498"><a href="#AsyncTransactionHandler-498"><span class="linenos">498</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="AsyncTransactionHandler-499"><a href="#AsyncTransactionHandler-499"><span class="linenos">499</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-500"><a href="#AsyncTransactionHandler-500"><span class="linenos">500</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-501"><a href="#AsyncTransactionHandler-501"><span class="linenos">501</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-502"><a href="#AsyncTransactionHandler-502"><span class="linenos">502</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-503"><a href="#AsyncTransactionHandler-503"><span class="linenos">503</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-504"><a href="#AsyncTransactionHandler-504"><span class="linenos">504</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-505"><a href="#AsyncTransactionHandler-505"><span class="linenos">505</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-506"><a href="#AsyncTransactionHandler-506"><span class="linenos">506</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-507"><a href="#AsyncTransactionHandler-507"><span class="linenos">507</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-508"><a href="#AsyncTransactionHandler-508"><span class="linenos">508</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-509"><a href="#AsyncTransactionHandler-509"><span class="linenos">509</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-510"><a href="#AsyncTransactionHandler-510"><span class="linenos">510</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler-511"><a href="#AsyncTransactionHandler-511"><span class="linenos">511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-512"><a href="#AsyncTransactionHandler-512"><span class="linenos">512</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-513"><a href="#AsyncTransactionHandler-513"><span class="linenos">513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-514"><a href="#AsyncTransactionHandler-514"><span class="linenos">514</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler-515"><a href="#AsyncTransactionHandler-515"><span class="linenos">515</span></a>
</span><span id="AsyncTransactionHandler-516"><a href="#AsyncTransactionHandler-516"><span class="linenos">516</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-517"><a href="#AsyncTransactionHandler-517"><span class="linenos">517</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler-518"><a href="#AsyncTransactionHandler-518"><span class="linenos">518</span></a><span class="sd">                Parameters</span>
</span><span id="AsyncTransactionHandler-519"><a href="#AsyncTransactionHandler-519"><span class="linenos">519</span></a><span class="sd">        ----------</span>
</span><span id="AsyncTransactionHandler-520"><a href="#AsyncTransactionHandler-520"><span class="linenos">520</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="AsyncTransactionHandler-521"><a href="#AsyncTransactionHandler-521"><span class="linenos">521</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="AsyncTransactionHandler-522"><a href="#AsyncTransactionHandler-522"><span class="linenos">522</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="AsyncTransactionHandler-523"><a href="#AsyncTransactionHandler-523"><span class="linenos">523</span></a><span class="sd">        -------</span>
</span><span id="AsyncTransactionHandler-524"><a href="#AsyncTransactionHandler-524"><span class="linenos">524</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="AsyncTransactionHandler-525"><a href="#AsyncTransactionHandler-525"><span class="linenos">525</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="AsyncTransactionHandler-526"><a href="#AsyncTransactionHandler-526"><span class="linenos">526</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="AsyncTransactionHandler-527"><a href="#AsyncTransactionHandler-527"><span class="linenos">527</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler-528"><a href="#AsyncTransactionHandler-528"><span class="linenos">528</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-529"><a href="#AsyncTransactionHandler-529"><span class="linenos">529</span></a>
</span><span id="AsyncTransactionHandler-530"><a href="#AsyncTransactionHandler-530"><span class="linenos">530</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-531"><a href="#AsyncTransactionHandler-531"><span class="linenos">531</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="AsyncTransactionHandler-532"><a href="#AsyncTransactionHandler-532"><span class="linenos">532</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="AsyncTransactionHandler-533"><a href="#AsyncTransactionHandler-533"><span class="linenos">533</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler-534"><a href="#AsyncTransactionHandler-534"><span class="linenos">534</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-535"><a href="#AsyncTransactionHandler-535"><span class="linenos">535</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-536"><a href="#AsyncTransactionHandler-536"><span class="linenos">536</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-537"><a href="#AsyncTransactionHandler-537"><span class="linenos">537</span></a>
</span><span id="AsyncTransactionHandler-538"><a href="#AsyncTransactionHandler-538"><span class="linenos">538</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="AsyncTransactionHandler-539"><a href="#AsyncTransactionHandler-539"><span class="linenos">539</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-540"><a href="#AsyncTransactionHandler-540"><span class="linenos">540</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-541"><a href="#AsyncTransactionHandler-541"><span class="linenos">541</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler-542"><a href="#AsyncTransactionHandler-542"><span class="linenos">542</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-543"><a href="#AsyncTransactionHandler-543"><span class="linenos">543</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="AsyncTransactionHandler-544"><a href="#AsyncTransactionHandler-544"><span class="linenos">544</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-545"><a href="#AsyncTransactionHandler-545"><span class="linenos">545</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AsyncTransactionHandler-546"><a href="#AsyncTransactionHandler-546"><span class="linenos">546</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="AsyncTransactionHandler-547"><a href="#AsyncTransactionHandler-547"><span class="linenos">547</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="AsyncTransactionHandler-548"><a href="#AsyncTransactionHandler-548"><span class="linenos">548</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler-549"><a href="#AsyncTransactionHandler-549"><span class="linenos">549</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-550"><a href="#AsyncTransactionHandler-550"><span class="linenos">550</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-551"><a href="#AsyncTransactionHandler-551"><span class="linenos">551</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-552"><a href="#AsyncTransactionHandler-552"><span class="linenos">552</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-553"><a href="#AsyncTransactionHandler-553"><span class="linenos">553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-554"><a href="#AsyncTransactionHandler-554"><span class="linenos">554</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-555"><a href="#AsyncTransactionHandler-555"><span class="linenos">555</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-556"><a href="#AsyncTransactionHandler-556"><span class="linenos">556</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-557"><a href="#AsyncTransactionHandler-557"><span class="linenos">557</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-558"><a href="#AsyncTransactionHandler-558"><span class="linenos">558</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-559"><a href="#AsyncTransactionHandler-559"><span class="linenos">559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-560"><a href="#AsyncTransactionHandler-560"><span class="linenos">560</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-561"><a href="#AsyncTransactionHandler-561"><span class="linenos">561</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-562"><a href="#AsyncTransactionHandler-562"><span class="linenos">562</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-563"><a href="#AsyncTransactionHandler-563"><span class="linenos">563</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-564"><a href="#AsyncTransactionHandler-564"><span class="linenos">564</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-565"><a href="#AsyncTransactionHandler-565"><span class="linenos">565</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-566"><a href="#AsyncTransactionHandler-566"><span class="linenos">566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-567"><a href="#AsyncTransactionHandler-567"><span class="linenos">567</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-568"><a href="#AsyncTransactionHandler-568"><span class="linenos">568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-569"><a href="#AsyncTransactionHandler-569"><span class="linenos">569</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-570"><a href="#AsyncTransactionHandler-570"><span class="linenos">570</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-571"><a href="#AsyncTransactionHandler-571"><span class="linenos">571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-572"><a href="#AsyncTransactionHandler-572"><span class="linenos">572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-573"><a href="#AsyncTransactionHandler-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AsyncTransactionHandler-574"><a href="#AsyncTransactionHandler-574"><span class="linenos">574</span></a>
</span><span id="AsyncTransactionHandler-575"><a href="#AsyncTransactionHandler-575"><span class="linenos">575</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-576"><a href="#AsyncTransactionHandler-576"><span class="linenos">576</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler-577"><a href="#AsyncTransactionHandler-577"><span class="linenos">577</span></a><span class="sd">                Parameters</span>
</span><span id="AsyncTransactionHandler-578"><a href="#AsyncTransactionHandler-578"><span class="linenos">578</span></a><span class="sd">        ----------</span>
</span><span id="AsyncTransactionHandler-579"><a href="#AsyncTransactionHandler-579"><span class="linenos">579</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="AsyncTransactionHandler-580"><a href="#AsyncTransactionHandler-580"><span class="linenos">580</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="AsyncTransactionHandler-581"><a href="#AsyncTransactionHandler-581"><span class="linenos">581</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="AsyncTransactionHandler-582"><a href="#AsyncTransactionHandler-582"><span class="linenos">582</span></a><span class="sd">        -------</span>
</span><span id="AsyncTransactionHandler-583"><a href="#AsyncTransactionHandler-583"><span class="linenos">583</span></a><span class="sd">        Push command data</span>
</span><span id="AsyncTransactionHandler-584"><a href="#AsyncTransactionHandler-584"><span class="linenos">584</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="AsyncTransactionHandler-585"><a href="#AsyncTransactionHandler-585"><span class="linenos">585</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="AsyncTransactionHandler-586"><a href="#AsyncTransactionHandler-586"><span class="linenos">586</span></a>
</span><span id="AsyncTransactionHandler-587"><a href="#AsyncTransactionHandler-587"><span class="linenos">587</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="AsyncTransactionHandler-588"><a href="#AsyncTransactionHandler-588"><span class="linenos">588</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="AsyncTransactionHandler-589"><a href="#AsyncTransactionHandler-589"><span class="linenos">589</span></a>
</span><span id="AsyncTransactionHandler-590"><a href="#AsyncTransactionHandler-590"><span class="linenos">590</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="AsyncTransactionHandler-591"><a href="#AsyncTransactionHandler-591"><span class="linenos">591</span></a>
</span><span id="AsyncTransactionHandler-592"><a href="#AsyncTransactionHandler-592"><span class="linenos">592</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="AsyncTransactionHandler-593"><a href="#AsyncTransactionHandler-593"><span class="linenos">593</span></a>
</span><span id="AsyncTransactionHandler-594"><a href="#AsyncTransactionHandler-594"><span class="linenos">594</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="AsyncTransactionHandler-595"><a href="#AsyncTransactionHandler-595"><span class="linenos">595</span></a>
</span><span id="AsyncTransactionHandler-596"><a href="#AsyncTransactionHandler-596"><span class="linenos">596</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="AsyncTransactionHandler-597"><a href="#AsyncTransactionHandler-597"><span class="linenos">597</span></a>
</span><span id="AsyncTransactionHandler-598"><a href="#AsyncTransactionHandler-598"><span class="linenos">598</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler-599"><a href="#AsyncTransactionHandler-599"><span class="linenos">599</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler-600"><a href="#AsyncTransactionHandler-600"><span class="linenos">600</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler-601"><a href="#AsyncTransactionHandler-601"><span class="linenos">601</span></a>
</span><span id="AsyncTransactionHandler-602"><a href="#AsyncTransactionHandler-602"><span class="linenos">602</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="AsyncTransactionHandler-603"><a href="#AsyncTransactionHandler-603"><span class="linenos">603</span></a>
</span><span id="AsyncTransactionHandler-604"><a href="#AsyncTransactionHandler-604"><span class="linenos">604</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="AsyncTransactionHandler-605"><a href="#AsyncTransactionHandler-605"><span class="linenos">605</span></a>
</span><span id="AsyncTransactionHandler-606"><a href="#AsyncTransactionHandler-606"><span class="linenos">606</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="AsyncTransactionHandler-607"><a href="#AsyncTransactionHandler-607"><span class="linenos">607</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="AsyncTransactionHandler-608"><a href="#AsyncTransactionHandler-608"><span class="linenos">608</span></a>
</span><span id="AsyncTransactionHandler-609"><a href="#AsyncTransactionHandler-609"><span class="linenos">609</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="AsyncTransactionHandler-610"><a href="#AsyncTransactionHandler-610"><span class="linenos">610</span></a>
</span><span id="AsyncTransactionHandler-611"><a href="#AsyncTransactionHandler-611"><span class="linenos">611</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="AsyncTransactionHandler-612"><a href="#AsyncTransactionHandler-612"><span class="linenos">612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler-613"><a href="#AsyncTransactionHandler-613"><span class="linenos">613</span></a>
</span><span id="AsyncTransactionHandler-614"><a href="#AsyncTransactionHandler-614"><span class="linenos">614</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-615"><a href="#AsyncTransactionHandler-615"><span class="linenos">615</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler-616"><a href="#AsyncTransactionHandler-616"><span class="linenos">616</span></a>        <span class="n">frame_buf_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-617"><a href="#AsyncTransactionHandler-617"><span class="linenos">617</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-618"><a href="#AsyncTransactionHandler-618"><span class="linenos">618</span></a>
</span><span id="AsyncTransactionHandler-619"><a href="#AsyncTransactionHandler-619"><span class="linenos">619</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-620"><a href="#AsyncTransactionHandler-620"><span class="linenos">620</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-621"><a href="#AsyncTransactionHandler-621"><span class="linenos">621</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="AsyncTransactionHandler-622"><a href="#AsyncTransactionHandler-622"><span class="linenos">622</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-623"><a href="#AsyncTransactionHandler-623"><span class="linenos">623</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="AsyncTransactionHandler-624"><a href="#AsyncTransactionHandler-624"><span class="linenos">624</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-625"><a href="#AsyncTransactionHandler-625"><span class="linenos">625</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="AsyncTransactionHandler-626"><a href="#AsyncTransactionHandler-626"><span class="linenos">626</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-627"><a href="#AsyncTransactionHandler-627"><span class="linenos">627</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="AsyncTransactionHandler-628"><a href="#AsyncTransactionHandler-628"><span class="linenos">628</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-629"><a href="#AsyncTransactionHandler-629"><span class="linenos">629</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="AsyncTransactionHandler-630"><a href="#AsyncTransactionHandler-630"><span class="linenos">630</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-631"><a href="#AsyncTransactionHandler-631"><span class="linenos">631</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-632"><a href="#AsyncTransactionHandler-632"><span class="linenos">632</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="AsyncTransactionHandler-633"><a href="#AsyncTransactionHandler-633"><span class="linenos">633</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-634"><a href="#AsyncTransactionHandler-634"><span class="linenos">634</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="AsyncTransactionHandler-635"><a href="#AsyncTransactionHandler-635"><span class="linenos">635</span></a>                <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Remove stale data</span>
</span><span id="AsyncTransactionHandler-636"><a href="#AsyncTransactionHandler-636"><span class="linenos">636</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-637"><a href="#AsyncTransactionHandler-637"><span class="linenos">637</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler-638"><a href="#AsyncTransactionHandler-638"><span class="linenos">638</span></a>                <span class="k">if</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-639"><a href="#AsyncTransactionHandler-639"><span class="linenos">639</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span><span class="p">(</span><span class="s2">&quot;Byte 0 not RPC_V1_PUSH_ACK&quot;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-640"><a href="#AsyncTransactionHandler-640"><span class="linenos">640</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-641"><a href="#AsyncTransactionHandler-641"><span class="linenos">641</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler-642"><a href="#AsyncTransactionHandler-642"><span class="linenos">642</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="AsyncTransactionHandler-643"><a href="#AsyncTransactionHandler-643"><span class="linenos">643</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-644"><a href="#AsyncTransactionHandler-644"><span class="linenos">644</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-645"><a href="#AsyncTransactionHandler-645"><span class="linenos">645</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-646"><a href="#AsyncTransactionHandler-646"><span class="linenos">646</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-647"><a href="#AsyncTransactionHandler-647"><span class="linenos">647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-648"><a href="#AsyncTransactionHandler-648"><span class="linenos">648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-649"><a href="#AsyncTransactionHandler-649"><span class="linenos">649</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-650"><a href="#AsyncTransactionHandler-650"><span class="linenos">650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-651"><a href="#AsyncTransactionHandler-651"><span class="linenos">651</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-652"><a href="#AsyncTransactionHandler-652"><span class="linenos">652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-653"><a href="#AsyncTransactionHandler-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-654"><a href="#AsyncTransactionHandler-654"><span class="linenos">654</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-655"><a href="#AsyncTransactionHandler-655"><span class="linenos">655</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-656"><a href="#AsyncTransactionHandler-656"><span class="linenos">656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-657"><a href="#AsyncTransactionHandler-657"><span class="linenos">657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-658"><a href="#AsyncTransactionHandler-658"><span class="linenos">658</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-659"><a href="#AsyncTransactionHandler-659"><span class="linenos">659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-660"><a href="#AsyncTransactionHandler-660"><span class="linenos">660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-661"><a href="#AsyncTransactionHandler-661"><span class="linenos">661</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="AsyncTransactionHandler-662"><a href="#AsyncTransactionHandler-662"><span class="linenos">662</span></a>
</span><span id="AsyncTransactionHandler-663"><a href="#AsyncTransactionHandler-663"><span class="linenos">663</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="AsyncTransactionHandler-664"><a href="#AsyncTransactionHandler-664"><span class="linenos">664</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler-665"><a href="#AsyncTransactionHandler-665"><span class="linenos">665</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-666"><a href="#AsyncTransactionHandler-666"><span class="linenos">666</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-667"><a href="#AsyncTransactionHandler-667"><span class="linenos">667</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-668"><a href="#AsyncTransactionHandler-668"><span class="linenos">668</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="AsyncTransactionHandler-669"><a href="#AsyncTransactionHandler-669"><span class="linenos">669</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="AsyncTransactionHandler-670"><a href="#AsyncTransactionHandler-670"><span class="linenos">670</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-671"><a href="#AsyncTransactionHandler-671"><span class="linenos">671</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-672"><a href="#AsyncTransactionHandler-672"><span class="linenos">672</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-673"><a href="#AsyncTransactionHandler-673"><span class="linenos">673</span></a>            <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-674"><a href="#AsyncTransactionHandler-674"><span class="linenos">674</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-675"><a href="#AsyncTransactionHandler-675"><span class="linenos">675</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-676"><a href="#AsyncTransactionHandler-676"><span class="linenos">676</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-677"><a href="#AsyncTransactionHandler-677"><span class="linenos">677</span></a>                        <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-678"><a href="#AsyncTransactionHandler-678"><span class="linenos">678</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="AsyncTransactionHandler-679"><a href="#AsyncTransactionHandler-679"><span class="linenos">679</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-680"><a href="#AsyncTransactionHandler-680"><span class="linenos">680</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="AsyncTransactionHandler-681"><a href="#AsyncTransactionHandler-681"><span class="linenos">681</span></a>
</span><span id="AsyncTransactionHandler-682"><a href="#AsyncTransactionHandler-682"><span class="linenos">682</span></a>            <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-683"><a href="#AsyncTransactionHandler-683"><span class="linenos">683</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-684"><a href="#AsyncTransactionHandler-684"><span class="linenos">684</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler-685"><a href="#AsyncTransactionHandler-685"><span class="linenos">685</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-686"><a href="#AsyncTransactionHandler-686"><span class="linenos">686</span></a>
</span><span id="AsyncTransactionHandler-687"><a href="#AsyncTransactionHandler-687"><span class="linenos">687</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-688"><a href="#AsyncTransactionHandler-688"><span class="linenos">688</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="AsyncTransactionHandler-689"><a href="#AsyncTransactionHandler-689"><span class="linenos">689</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="AsyncTransactionHandler-690"><a href="#AsyncTransactionHandler-690"><span class="linenos">690</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler-691"><a href="#AsyncTransactionHandler-691"><span class="linenos">691</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-692"><a href="#AsyncTransactionHandler-692"><span class="linenos">692</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="AsyncTransactionHandler-693"><a href="#AsyncTransactionHandler-693"><span class="linenos">693</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-694"><a href="#AsyncTransactionHandler-694"><span class="linenos">694</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="AsyncTransactionHandler-695"><a href="#AsyncTransactionHandler-695"><span class="linenos">695</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="AsyncTransactionHandler-696"><a href="#AsyncTransactionHandler-696"><span class="linenos">696</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="AsyncTransactionHandler-697"><a href="#AsyncTransactionHandler-697"><span class="linenos">697</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="AsyncTransactionHandler-698"><a href="#AsyncTransactionHandler-698"><span class="linenos">698</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-699"><a href="#AsyncTransactionHandler-699"><span class="linenos">699</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler-700"><a href="#AsyncTransactionHandler-700"><span class="linenos">700</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-701"><a href="#AsyncTransactionHandler-701"><span class="linenos">701</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-702"><a href="#AsyncTransactionHandler-702"><span class="linenos">702</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-703"><a href="#AsyncTransactionHandler-703"><span class="linenos">703</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-704"><a href="#AsyncTransactionHandler-704"><span class="linenos">704</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler-705"><a href="#AsyncTransactionHandler-705"><span class="linenos">705</span></a>
</span><span id="AsyncTransactionHandler-706"><a href="#AsyncTransactionHandler-706"><span class="linenos">706</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-707"><a href="#AsyncTransactionHandler-707"><span class="linenos">707</span></a>
</span><span id="AsyncTransactionHandler-708"><a href="#AsyncTransactionHandler-708"><span class="linenos">708</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-709"><a href="#AsyncTransactionHandler-709"><span class="linenos">709</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-710"><a href="#AsyncTransactionHandler-710"><span class="linenos">710</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-711"><a href="#AsyncTransactionHandler-711"><span class="linenos">711</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-712"><a href="#AsyncTransactionHandler-712"><span class="linenos">712</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-713"><a href="#AsyncTransactionHandler-713"><span class="linenos">713</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-714"><a href="#AsyncTransactionHandler-714"><span class="linenos">714</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="AsyncTransactionHandler-715"><a href="#AsyncTransactionHandler-715"><span class="linenos">715</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-716"><a href="#AsyncTransactionHandler-716"><span class="linenos">716</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler-717"><a href="#AsyncTransactionHandler-717"><span class="linenos">717</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-718"><a href="#AsyncTransactionHandler-718"><span class="linenos">718</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-719"><a href="#AsyncTransactionHandler-719"><span class="linenos">719</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="AsyncTransactionHandler-720"><a href="#AsyncTransactionHandler-720"><span class="linenos">720</span></a>                                                                                                  <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler-721"><a href="#AsyncTransactionHandler-721"><span class="linenos">721</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-722"><a href="#AsyncTransactionHandler-722"><span class="linenos">722</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-723"><a href="#AsyncTransactionHandler-723"><span class="linenos">723</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="AsyncTransactionHandler-724"><a href="#AsyncTransactionHandler-724"><span class="linenos">724</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="AsyncTransactionHandler-725"><a href="#AsyncTransactionHandler-725"><span class="linenos">725</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-726"><a href="#AsyncTransactionHandler-726"><span class="linenos">726</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler-727"><a href="#AsyncTransactionHandler-727"><span class="linenos">727</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-728"><a href="#AsyncTransactionHandler-728"><span class="linenos">728</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-729"><a href="#AsyncTransactionHandler-729"><span class="linenos">729</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-730"><a href="#AsyncTransactionHandler-730"><span class="linenos">730</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-731"><a href="#AsyncTransactionHandler-731"><span class="linenos">731</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler-732"><a href="#AsyncTransactionHandler-732"><span class="linenos">732</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-733"><a href="#AsyncTransactionHandler-733"><span class="linenos">733</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-734"><a href="#AsyncTransactionHandler-734"><span class="linenos">734</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-735"><a href="#AsyncTransactionHandler-735"><span class="linenos">735</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-736"><a href="#AsyncTransactionHandler-736"><span class="linenos">736</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-737"><a href="#AsyncTransactionHandler-737"><span class="linenos">737</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler-738"><a href="#AsyncTransactionHandler-738"><span class="linenos">738</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-739"><a href="#AsyncTransactionHandler-739"><span class="linenos">739</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="AsyncTransactionHandler-740"><a href="#AsyncTransactionHandler-740"><span class="linenos">740</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-741"><a href="#AsyncTransactionHandler-741"><span class="linenos">741</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-742"><a href="#AsyncTransactionHandler-742"><span class="linenos">742</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="AsyncTransactionHandler-743"><a href="#AsyncTransactionHandler-743"><span class="linenos">743</span></a>                                                                                                  <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler-744"><a href="#AsyncTransactionHandler-744"><span class="linenos">744</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-745"><a href="#AsyncTransactionHandler-745"><span class="linenos">745</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="AsyncTransactionHandler-746"><a href="#AsyncTransactionHandler-746"><span class="linenos">746</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-747"><a href="#AsyncTransactionHandler-747"><span class="linenos">747</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-748"><a href="#AsyncTransactionHandler-748"><span class="linenos">748</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="AsyncTransactionHandler-749"><a href="#AsyncTransactionHandler-749"><span class="linenos">749</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-750"><a href="#AsyncTransactionHandler-750"><span class="linenos">750</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="AsyncTransactionHandler-751"><a href="#AsyncTransactionHandler-751"><span class="linenos">751</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-752"><a href="#AsyncTransactionHandler-752"><span class="linenos">752</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="AsyncTransactionHandler-753"><a href="#AsyncTransactionHandler-753"><span class="linenos">753</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-754"><a href="#AsyncTransactionHandler-754"><span class="linenos">754</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-755"><a href="#AsyncTransactionHandler-755"><span class="linenos">755</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-756"><a href="#AsyncTransactionHandler-756"><span class="linenos">756</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="AsyncTransactionHandler-757"><a href="#AsyncTransactionHandler-757"><span class="linenos">757</span></a>                <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="AsyncTransactionHandler-758"><a href="#AsyncTransactionHandler-758"><span class="linenos">758</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler-759"><a href="#AsyncTransactionHandler-759"><span class="linenos">759</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler-760"><a href="#AsyncTransactionHandler-760"><span class="linenos">760</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler-761"><a href="#AsyncTransactionHandler-761"><span class="linenos">761</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler-762"><a href="#AsyncTransactionHandler-762"><span class="linenos">762</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler-763"><a href="#AsyncTransactionHandler-763"><span class="linenos">763</span></a>
</span><span id="AsyncTransactionHandler-764"><a href="#AsyncTransactionHandler-764"><span class="linenos">764</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-765"><a href="#AsyncTransactionHandler-765"><span class="linenos">765</span></a>                    <span class="k">break</span>
</span><span id="AsyncTransactionHandler-766"><a href="#AsyncTransactionHandler-766"><span class="linenos">766</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="AsyncTransactionHandler-767"><a href="#AsyncTransactionHandler-767"><span class="linenos">767</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler-768"><a href="#AsyncTransactionHandler-768"><span class="linenos">768</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="AsyncTransactionHandler-769"><a href="#AsyncTransactionHandler-769"><span class="linenos">769</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="AsyncTransactionHandler-770"><a href="#AsyncTransactionHandler-770"><span class="linenos">770</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-771"><a href="#AsyncTransactionHandler-771"><span class="linenos">771</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-772"><a href="#AsyncTransactionHandler-772"><span class="linenos">772</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-773"><a href="#AsyncTransactionHandler-773"><span class="linenos">773</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-774"><a href="#AsyncTransactionHandler-774"><span class="linenos">774</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler-775"><a href="#AsyncTransactionHandler-775"><span class="linenos">775</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-776"><a href="#AsyncTransactionHandler-776"><span class="linenos">776</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-777"><a href="#AsyncTransactionHandler-777"><span class="linenos">777</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler-778"><a href="#AsyncTransactionHandler-778"><span class="linenos">778</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-779"><a href="#AsyncTransactionHandler-779"><span class="linenos">779</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-780"><a href="#AsyncTransactionHandler-780"><span class="linenos">780</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler-781"><a href="#AsyncTransactionHandler-781"><span class="linenos">781</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-782"><a href="#AsyncTransactionHandler-782"><span class="linenos">782</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-783"><a href="#AsyncTransactionHandler-783"><span class="linenos">783</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-784"><a href="#AsyncTransactionHandler-784"><span class="linenos">784</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-785"><a href="#AsyncTransactionHandler-785"><span class="linenos">785</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler-786"><a href="#AsyncTransactionHandler-786"><span class="linenos">786</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler-787"><a href="#AsyncTransactionHandler-787"><span class="linenos">787</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler-788"><a href="#AsyncTransactionHandler-788"><span class="linenos">788</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            <div id="AsyncTransactionHandler.__init__" class="classattr">
                                        <input id="AsyncTransactionHandler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AsyncTransactionHandler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">port_name</span>, </span><span class="param"><span class="n">ser</span>, </span><span class="param"><span class="n">logger</span>, </span><span class="param"><span class="n">lock</span></span>)</span>

                <label class="view-source-button" for="AsyncTransactionHandler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.__init__-460"><a href="#AsyncTransactionHandler.__init__-460"><span class="linenos">460</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.__init__-461"><a href="#AsyncTransactionHandler.__init__-461"><span class="linenos">461</span></a>        <span class="n">SyncTransactionHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AsyncTransactionHandler.sendFramedData" class="classattr">
                                        <input id="AsyncTransactionHandler.sendFramedData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">sendFramedData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">size</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.sendFramedData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.sendFramedData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.sendFramedData-463"><a href="#AsyncTransactionHandler.sendFramedData-463"><span class="linenos">463</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">sendFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.sendFramedData-464"><a href="#AsyncTransactionHandler.sendFramedData-464"><span class="linenos">464</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.sendFramedData-465"><a href="#AsyncTransactionHandler.sendFramedData-465"><span class="linenos">465</span></a>        <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">encode_data</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">size</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler.sendFramedData-466"><a href="#AsyncTransactionHandler.sendFramedData-466"><span class="linenos">466</span></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">write_async</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="AsyncTransactionHandler.receiveFramedData" class="classattr">
                                        <input id="AsyncTransactionHandler.receiveFramedData-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">receiveFramedData</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.receiveFramedData-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.receiveFramedData"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.receiveFramedData-468"><a href="#AsyncTransactionHandler.receiveFramedData-468"><span class="linenos">468</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">receiveFramedData</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-469"><a href="#AsyncTransactionHandler.receiveFramedData-469"><span class="linenos">469</span></a>        <span class="n">t_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-470"><a href="#AsyncTransactionHandler.receiveFramedData-470"><span class="linenos">470</span></a>        <span class="n">rx_buffer</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-471"><a href="#AsyncTransactionHandler.receiveFramedData-471"><span class="linenos">471</span></a>        <span class="n">framer</span> <span class="o">=</span> <span class="n">cobbs_framing</span><span class="o">.</span><span class="n">CobbsFraming</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-472"><a href="#AsyncTransactionHandler.receiveFramedData-472"><span class="linenos">472</span></a>        <span class="k">while</span> <span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-473"><a href="#AsyncTransactionHandler.receiveFramedData-473"><span class="linenos">473</span></a>            <span class="n">nn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">inWaiting</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-474"><a href="#AsyncTransactionHandler.receiveFramedData-474"><span class="linenos">474</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-475"><a href="#AsyncTransactionHandler.receiveFramedData-475"><span class="linenos">475</span></a>                <span class="n">rbuf</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">read_async</span><span class="p">(</span><span class="n">nn</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-476"><a href="#AsyncTransactionHandler.receiveFramedData-476"><span class="linenos">476</span></a>                <span class="n">nu</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-477"><a href="#AsyncTransactionHandler.receiveFramedData-477"><span class="linenos">477</span></a>                <span class="k">for</span> <span class="n">byte_in</span> <span class="ow">in</span> <span class="n">rbuf</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-478"><a href="#AsyncTransactionHandler.receiveFramedData-478"><span class="linenos">478</span></a>                    <span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-479"><a href="#AsyncTransactionHandler.receiveFramedData-479"><span class="linenos">479</span></a>                    <span class="k">if</span> <span class="n">byte_in</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_marker</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-480"><a href="#AsyncTransactionHandler.receiveFramedData-480"><span class="linenos">480</span></a>                        <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="n">framer</span><span class="o">.</span><span class="n">decode_data</span><span class="p">(</span><span class="n">rx_buffer</span><span class="p">)</span>  <span class="c1"># [:-1])</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-481"><a href="#AsyncTransactionHandler.receiveFramedData-481"><span class="linenos">481</span></a>                        <span class="k">return</span> <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-482"><a href="#AsyncTransactionHandler.receiveFramedData-482"><span class="linenos">482</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-483"><a href="#AsyncTransactionHandler.receiveFramedData-483"><span class="linenos">483</span></a>                        <span class="n">rx_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">byte_in</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-484"><a href="#AsyncTransactionHandler.receiveFramedData-484"><span class="linenos">484</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-485"><a href="#AsyncTransactionHandler.receiveFramedData-485"><span class="linenos">485</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.00001</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.receiveFramedData-486"><a href="#AsyncTransactionHandler.receiveFramedData-486"><span class="linenos">486</span></a>        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[])</span>
</span></pre></div>


    

                            </div>
                            <div id="AsyncTransactionHandler.do_rpc" class="classattr">
                                        <input id="AsyncTransactionHandler.do_rpc-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_rpc</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">push</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.do_rpc-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.do_rpc"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.do_rpc-488"><a href="#AsyncTransactionHandler.do_rpc-488"><span class="linenos">488</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_rpc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">push</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_rpc-489"><a href="#AsyncTransactionHandler.do_rpc-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-490"><a href="#AsyncTransactionHandler.do_rpc-490"><span class="linenos">490</span></a>            <span class="k">return</span>
</span><span id="AsyncTransactionHandler.do_rpc-491"><a href="#AsyncTransactionHandler.do_rpc-491"><span class="linenos">491</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;transactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_rpc-492"><a href="#AsyncTransactionHandler.do_rpc-492"><span class="linenos">492</span></a>        <span class="c1"># if exiting:</span>
</span><span id="AsyncTransactionHandler.do_rpc-493"><a href="#AsyncTransactionHandler.do_rpc-493"><span class="linenos">493</span></a>        <span class="c1">#     time.sleep(0.1) #May have been a hard exit, give time for bad data to land, remove, do final RPC</span>
</span><span id="AsyncTransactionHandler.do_rpc-494"><a href="#AsyncTransactionHandler.do_rpc-494"><span class="linenos">494</span></a>        <span class="c1">#     self.ser.reset_output_buffer()</span>
</span><span id="AsyncTransactionHandler.do_rpc-495"><a href="#AsyncTransactionHandler.do_rpc-495"><span class="linenos">495</span></a>        <span class="c1">#     self.ser.reset_input_buffer()</span>
</span><span id="AsyncTransactionHandler.do_rpc-496"><a href="#AsyncTransactionHandler.do_rpc-496"><span class="linenos">496</span></a>        <span class="c1"># This will block until all RPCs have been completed</span>
</span><span id="AsyncTransactionHandler.do_rpc-497"><a href="#AsyncTransactionHandler.do_rpc-497"><span class="linenos">497</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-498"><a href="#AsyncTransactionHandler.do_rpc-498"><span class="linenos">498</span></a>            <span class="c1"># Now run RPC calls</span>
</span><span id="AsyncTransactionHandler.do_rpc-499"><a href="#AsyncTransactionHandler.do_rpc-499"><span class="linenos">499</span></a>            <span class="k">if</span> <span class="n">push</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-500"><a href="#AsyncTransactionHandler.do_rpc-500"><span class="linenos">500</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-501"><a href="#AsyncTransactionHandler.do_rpc-501"><span class="linenos">501</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_rpc-502"><a href="#AsyncTransactionHandler.do_rpc-502"><span class="linenos">502</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-503"><a href="#AsyncTransactionHandler.do_rpc-503"><span class="linenos">503</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_push_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_rpc-504"><a href="#AsyncTransactionHandler.do_rpc-504"><span class="linenos">504</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-505"><a href="#AsyncTransactionHandler.do_rpc-505"><span class="linenos">505</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-506"><a href="#AsyncTransactionHandler.do_rpc-506"><span class="linenos">506</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_transaction_v0</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_rpc-507"><a href="#AsyncTransactionHandler.do_rpc-507"><span class="linenos">507</span></a>                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-508"><a href="#AsyncTransactionHandler.do_rpc-508"><span class="linenos">508</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_pull_transaction_v1</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_rpc-509"><a href="#AsyncTransactionHandler.do_rpc-509"><span class="linenos">509</span></a>        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-510"><a href="#AsyncTransactionHandler.do_rpc-510"><span class="linenos">510</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;IOError(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler.do_rpc-511"><a href="#AsyncTransactionHandler.do_rpc-511"><span class="linenos">511</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_rpc-512"><a href="#AsyncTransactionHandler.do_rpc-512"><span class="linenos">512</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_rpc-513"><a href="#AsyncTransactionHandler.do_rpc-513"><span class="linenos">513</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_rpc-514"><a href="#AsyncTransactionHandler.do_rpc-514"><span class="linenos">514</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span></pre></div>


    

                            </div>
                            <div id="AsyncTransactionHandler.do_pull_transaction_v1" class="classattr">
                                        <input id="AsyncTransactionHandler.do_pull_transaction_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_pull_transaction_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc_data</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.do_pull_transaction_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.do_pull_transaction_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.do_pull_transaction_v1-516"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-516"><span class="linenos">516</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-517"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-517"><span class="linenos">517</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-518"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-518"><span class="linenos">518</span></a><span class="sd">                Parameters</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-519"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-519"><span class="linenos">519</span></a><span class="sd">        ----------</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-520"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-520"><span class="linenos">520</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-521"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-521"><span class="linenos">521</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-522"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-522"><span class="linenos">522</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-523"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-523"><span class="linenos">523</span></a><span class="sd">        -------</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-524"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-524"><span class="linenos">524</span></a><span class="sd">        This pulls status data from the device. The frame layout is analogous to do_push_transaction.</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-525"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-525"><span class="linenos">525</span></a><span class="sd">        However, here we send down only a pull request (single frame with an RPC_ID).</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-526"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-526"><span class="linenos">526</span></a><span class="sd">        We get back one or more frames of status data which is then decoded and passed to the callback.</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-527"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-527"><span class="linenos">527</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-528"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-528"><span class="linenos">528</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-529"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-529"><span class="linenos">529</span></a>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-530"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-530"><span class="linenos">530</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-531"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-531"><span class="linenos">531</span></a>            <span class="c1"># First initiate a pull transaction</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-532"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-532"><span class="linenos">532</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_FIRST</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-533"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-533"><span class="linenos">533</span></a>            <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-534"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-534"><span class="linenos">534</span></a>            <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-535"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-535"><span class="linenos">535</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-536"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-536"><span class="linenos">536</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-537"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-537"><span class="linenos">537</span></a>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-538"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-538"><span class="linenos">538</span></a>            <span class="c1"># Next read out the N reply frames (up to 18, if no ACK_LAST, then error</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-539"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-539"><span class="linenos">539</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RPC_V1_MAX_FRAMES</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-540"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-540"><span class="linenos">540</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-541"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-541"><span class="linenos">541</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_pull_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-542"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-542"><span class="linenos">542</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-543"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-543"><span class="linenos">543</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_LAST</span><span class="p">:</span>  <span class="c1"># No more frames to request</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-544"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-544"><span class="linenos">544</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-545"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-545"><span class="linenos">545</span></a>                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-546"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-546"><span class="linenos">546</span></a>                <span class="k">elif</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V1_PULL_FRAME_ACK_MORE</span><span class="p">:</span>  <span class="c1"># More frames to request</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-547"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-547"><span class="linenos">547</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PULL_FRAME_MORE</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-548"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-548"><span class="linenos">548</span></a>                    <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-549"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-549"><span class="linenos">549</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-550"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-550"><span class="linenos">550</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-551"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-551"><span class="linenos">551</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-552"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-552"><span class="linenos">552</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-553"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-553"><span class="linenos">553</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;In do_pull_transaction. Failed to get RPC_V1_PULL_FRAME_ACK_LAST&quot;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-554"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-554"><span class="linenos">554</span></a>            <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-555"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-555"><span class="linenos">555</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-556"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-556"><span class="linenos">556</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-557"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-557"><span class="linenos">557</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-558"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-558"><span class="linenos">558</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-559"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-559"><span class="linenos">559</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-560"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-560"><span class="linenos">560</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-561"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-561"><span class="linenos">561</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-562"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-562"><span class="linenos">562</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-563"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-563"><span class="linenos">563</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-564"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-564"><span class="linenos">564</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-565"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-565"><span class="linenos">565</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-566"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-566"><span class="linenos">566</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-567"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-567"><span class="linenos">567</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-568"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-568"><span class="linenos">568</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-569"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-569"><span class="linenos">569</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-570"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-570"><span class="linenos">570</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-571"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-571"><span class="linenos">571</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-572"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-572"><span class="linenos">572</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_pull_transaction_v1-573"><a href="#AsyncTransactionHandler.do_pull_transaction_v1-573"><span class="linenos">573</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>rpc_data: Buffer of data to transmit in RPC
rpc_callback: Call back to process RPC reply data</p>

<h2 id="returns-truefalse-if-successful">Returns: True/False if successful</h2>

<p>This pulls status data from the device. The frame layout is analogous to do_push_transaction.
However, here we send down only a pull request (single frame with an RPC_ID).
We get back one or more frames of status data which is then decoded and passed to the callback.</p>
</div>


                            </div>
                            <div id="AsyncTransactionHandler.do_push_transaction_v1" class="classattr">
                                        <input id="AsyncTransactionHandler.do_push_transaction_v1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_push_transaction_v1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc_data</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.do_push_transaction_v1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.do_push_transaction_v1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.do_push_transaction_v1-575"><a href="#AsyncTransactionHandler.do_push_transaction_v1-575"><span class="linenos">575</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_transaction_v1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc_data</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-576"><a href="#AsyncTransactionHandler.do_push_transaction_v1-576"><span class="linenos">576</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-577"><a href="#AsyncTransactionHandler.do_push_transaction_v1-577"><span class="linenos">577</span></a><span class="sd">                Parameters</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-578"><a href="#AsyncTransactionHandler.do_push_transaction_v1-578"><span class="linenos">578</span></a><span class="sd">        ----------</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-579"><a href="#AsyncTransactionHandler.do_push_transaction_v1-579"><span class="linenos">579</span></a><span class="sd">        rpc_data: Buffer of data to transmit in RPC</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-580"><a href="#AsyncTransactionHandler.do_push_transaction_v1-580"><span class="linenos">580</span></a><span class="sd">        rpc_callback: Call back to process RPC reply data</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-581"><a href="#AsyncTransactionHandler.do_push_transaction_v1-581"><span class="linenos">581</span></a><span class="sd">        Returns: True/False if successful</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-582"><a href="#AsyncTransactionHandler.do_push_transaction_v1-582"><span class="linenos">582</span></a><span class="sd">        -------</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-583"><a href="#AsyncTransactionHandler.do_push_transaction_v1-583"><span class="linenos">583</span></a><span class="sd">        Push command data</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-584"><a href="#AsyncTransactionHandler.do_push_transaction_v1-584"><span class="linenos">584</span></a><span class="sd">        Take the rpc_data, break into 64 byte encoded frames, and write to serial.</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-585"><a href="#AsyncTransactionHandler.do_push_transaction_v1-585"><span class="linenos">585</span></a><span class="sd">        Recieve back acks for each frame sent</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-586"><a href="#AsyncTransactionHandler.do_push_transaction_v1-586"><span class="linenos">586</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-587"><a href="#AsyncTransactionHandler.do_push_transaction_v1-587"><span class="linenos">587</span></a><span class="sd">        RPC data looks like:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-588"><a href="#AsyncTransactionHandler.do_push_transaction_v1-588"><span class="linenos">588</span></a><span class="sd">        rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-589"><a href="#AsyncTransactionHandler.do_push_transaction_v1-589"><span class="linenos">589</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-590"><a href="#AsyncTransactionHandler.do_push_transaction_v1-590"><span class="linenos">590</span></a><span class="sd">        The rpc_data is then grouped into one or more 59 byte frames.</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-591"><a href="#AsyncTransactionHandler.do_push_transaction_v1-591"><span class="linenos">591</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-592"><a href="#AsyncTransactionHandler.do_push_transaction_v1-592"><span class="linenos">592</span></a><span class="sd">        For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-593"><a href="#AsyncTransactionHandler.do_push_transaction_v1-593"><span class="linenos">593</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-594"><a href="#AsyncTransactionHandler.do_push_transaction_v1-594"><span class="linenos">594</span></a><span class="sd">        push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-595"><a href="#AsyncTransactionHandler.do_push_transaction_v1-595"><span class="linenos">595</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-596"><a href="#AsyncTransactionHandler.do_push_transaction_v1-596"><span class="linenos">596</span></a><span class="sd">        If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-597"><a href="#AsyncTransactionHandler.do_push_transaction_v1-597"><span class="linenos">597</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-598"><a href="#AsyncTransactionHandler.do_push_transaction_v1-598"><span class="linenos">598</span></a><span class="sd">        frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-599"><a href="#AsyncTransactionHandler.do_push_transaction_v1-599"><span class="linenos">599</span></a><span class="sd">        frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-600"><a href="#AsyncTransactionHandler.do_push_transaction_v1-600"><span class="linenos">600</span></a><span class="sd">        frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-601"><a href="#AsyncTransactionHandler.do_push_transaction_v1-601"><span class="linenos">601</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-602"><a href="#AsyncTransactionHandler.do_push_transaction_v1-602"><span class="linenos">602</span></a><span class="sd">        Before transmission each frame is first Cobbs encoded as:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-603"><a href="#AsyncTransactionHandler.do_push_transaction_v1-603"><span class="linenos">603</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-604"><a href="#AsyncTransactionHandler.do_push_transaction_v1-604"><span class="linenos">604</span></a><span class="sd">        [ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-605"><a href="#AsyncTransactionHandler.do_push_transaction_v1-605"><span class="linenos">605</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-606"><a href="#AsyncTransactionHandler.do_push_transaction_v1-606"><span class="linenos">606</span></a><span class="sd">        A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-607"><a href="#AsyncTransactionHandler.do_push_transaction_v1-607"><span class="linenos">607</span></a><span class="sd">        succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-608"><a href="#AsyncTransactionHandler.do_push_transaction_v1-608"><span class="linenos">608</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-609"><a href="#AsyncTransactionHandler.do_push_transaction_v1-609"><span class="linenos">609</span></a><span class="sd">        reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-610"><a href="#AsyncTransactionHandler.do_push_transaction_v1-610"><span class="linenos">610</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-611"><a href="#AsyncTransactionHandler.do_push_transaction_v1-611"><span class="linenos">611</span></a><span class="sd">        Finally, reply data is decoded and passed to the rpc_callback</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-612"><a href="#AsyncTransactionHandler.do_push_transaction_v1-612"><span class="linenos">612</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-613"><a href="#AsyncTransactionHandler.do_push_transaction_v1-613"><span class="linenos">613</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-614"><a href="#AsyncTransactionHandler.do_push_transaction_v1-614"><span class="linenos">614</span></a>        <span class="n">n_frames</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-615"><a href="#AsyncTransactionHandler.do_push_transaction_v1-615"><span class="linenos">615</span></a>        <span class="n">widx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-616"><a href="#AsyncTransactionHandler.do_push_transaction_v1-616"><span class="linenos">616</span></a>        <span class="n">frame_buf_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-617"><a href="#AsyncTransactionHandler.do_push_transaction_v1-617"><span class="linenos">617</span></a>        <span class="n">frame_buf_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_empty_frame</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-618"><a href="#AsyncTransactionHandler.do_push_transaction_v1-618"><span class="linenos">618</span></a>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-619"><a href="#AsyncTransactionHandler.do_push_transaction_v1-619"><span class="linenos">619</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-620"><a href="#AsyncTransactionHandler.do_push_transaction_v1-620"><span class="linenos">620</span></a>            <span class="k">for</span> <span class="n">fid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_frames</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-621"><a href="#AsyncTransactionHandler.do_push_transaction_v1-621"><span class="linenos">621</span></a>                <span class="c1"># Build the Nth frame and transmit</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-622"><a href="#AsyncTransactionHandler.do_push_transaction_v1-622"><span class="linenos">622</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-623"><a href="#AsyncTransactionHandler.do_push_transaction_v1-623"><span class="linenos">623</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_ONLY</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-624"><a href="#AsyncTransactionHandler.do_push_transaction_v1-624"><span class="linenos">624</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">n_frames</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-625"><a href="#AsyncTransactionHandler.do_push_transaction_v1-625"><span class="linenos">625</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_FIRST_MORE</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-626"><a href="#AsyncTransactionHandler.do_push_transaction_v1-626"><span class="linenos">626</span></a>                <span class="k">elif</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-627"><a href="#AsyncTransactionHandler.do_push_transaction_v1-627"><span class="linenos">627</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_LAST</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-628"><a href="#AsyncTransactionHandler.do_push_transaction_v1-628"><span class="linenos">628</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-629"><a href="#AsyncTransactionHandler.do_push_transaction_v1-629"><span class="linenos">629</span></a>                    <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V1_PUSH_FRAME_MORE</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-630"><a href="#AsyncTransactionHandler.do_push_transaction_v1-630"><span class="linenos">630</span></a>                <span class="n">nb_frame</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">RPC_V1_FRAME_DATA_MAX_BYTES</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">widx</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-631"><a href="#AsyncTransactionHandler.do_push_transaction_v1-631"><span class="linenos">631</span></a>                <span class="n">frame_buf_out</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpc_data</span><span class="p">[</span><span class="n">widx</span><span class="p">:</span><span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-632"><a href="#AsyncTransactionHandler.do_push_transaction_v1-632"><span class="linenos">632</span></a>                <span class="n">widx</span> <span class="o">=</span> <span class="n">widx</span> <span class="o">+</span> <span class="n">nb_frame</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-633"><a href="#AsyncTransactionHandler.do_push_transaction_v1-633"><span class="linenos">633</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf_out</span><span class="p">,</span> <span class="n">nb_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-634"><a href="#AsyncTransactionHandler.do_push_transaction_v1-634"><span class="linenos">634</span></a>                <span class="c1"># Get Ack back</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-635"><a href="#AsyncTransactionHandler.do_push_transaction_v1-635"><span class="linenos">635</span></a>                <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Remove stale data</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-636"><a href="#AsyncTransactionHandler.do_push_transaction_v1-636"><span class="linenos">636</span></a>                <span class="n">crc</span><span class="p">,</span> <span class="n">nr</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-637"><a href="#AsyncTransactionHandler.do_push_transaction_v1-637"><span class="linenos">637</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">handle_push_ack_v1</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-638"><a href="#AsyncTransactionHandler.do_push_transaction_v1-638"><span class="linenos">638</span></a>                <span class="k">if</span> <span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V1_PUSH_ACK</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-639"><a href="#AsyncTransactionHandler.do_push_transaction_v1-639"><span class="linenos">639</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span><span class="p">(</span><span class="s2">&quot;Byte 0 not RPC_V1_PUSH_ACK&quot;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-640"><a href="#AsyncTransactionHandler.do_push_transaction_v1-640"><span class="linenos">640</span></a>                <span class="k">if</span> <span class="n">fid</span> <span class="o">==</span> <span class="n">n_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-641"><a href="#AsyncTransactionHandler.do_push_transaction_v1-641"><span class="linenos">641</span></a>                    <span class="n">rpc_callback</span><span class="p">(</span><span class="n">frame_buf_in</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">])</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-642"><a href="#AsyncTransactionHandler.do_push_transaction_v1-642"><span class="linenos">642</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-643"><a href="#AsyncTransactionHandler.do_push_transaction_v1-643"><span class="linenos">643</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-644"><a href="#AsyncTransactionHandler.do_push_transaction_v1-644"><span class="linenos">644</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-645"><a href="#AsyncTransactionHandler.do_push_transaction_v1-645"><span class="linenos">645</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-646"><a href="#AsyncTransactionHandler.do_push_transaction_v1-646"><span class="linenos">646</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-647"><a href="#AsyncTransactionHandler.do_push_transaction_v1-647"><span class="linenos">647</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-648"><a href="#AsyncTransactionHandler.do_push_transaction_v1-648"><span class="linenos">648</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-649"><a href="#AsyncTransactionHandler.do_push_transaction_v1-649"><span class="linenos">649</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-650"><a href="#AsyncTransactionHandler.do_push_transaction_v1-650"><span class="linenos">650</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-651"><a href="#AsyncTransactionHandler.do_push_transaction_v1-651"><span class="linenos">651</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-652"><a href="#AsyncTransactionHandler.do_push_transaction_v1-652"><span class="linenos">652</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-653"><a href="#AsyncTransactionHandler.do_push_transaction_v1-653"><span class="linenos">653</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-654"><a href="#AsyncTransactionHandler.do_push_transaction_v1-654"><span class="linenos">654</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-655"><a href="#AsyncTransactionHandler.do_push_transaction_v1-655"><span class="linenos">655</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-656"><a href="#AsyncTransactionHandler.do_push_transaction_v1-656"><span class="linenos">656</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-657"><a href="#AsyncTransactionHandler.do_push_transaction_v1-657"><span class="linenos">657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-658"><a href="#AsyncTransactionHandler.do_push_transaction_v1-658"><span class="linenos">658</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-659"><a href="#AsyncTransactionHandler.do_push_transaction_v1-659"><span class="linenos">659</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-660"><a href="#AsyncTransactionHandler.do_push_transaction_v1-660"><span class="linenos">660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_push_transaction_v1-661"><a href="#AsyncTransactionHandler.do_push_transaction_v1-661"><span class="linenos">661</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><h2 id="parameters">Parameters</h2>

<p>rpc_data: Buffer of data to transmit in RPC
rpc_callback: Call back to process RPC reply data</p>

<h2 id="returns-truefalse-if-successful">Returns: True/False if successful</h2>

<p>Push command data
Take the rpc_data, break into 64 byte encoded frames, and write to serial.
Recieve back acks for each frame sent</p>

<p>RPC data looks like:
rpc_data = [RPC_ID D0, D1,...] (Len 1024 max)</p>

<p>The rpc_data is then grouped into one or more 59 byte frames.</p>

<p>For rpc_data&lt;=59 bytes, an RPC send is straigthforward:</p>

<p>push_frame_0 = [RPC_PUSH_FRAME_LAST, D0,...DN, CRC1 CRC2] (len 62 max, N&lt;=58)</p>

<p>If the size of data sent is over 59 bytes, then multiple frames are used. If for example, 150 bytes are sent:</p>

<p>frame_0 = [RPC_PUSH_FRAME_MORE, , D0,...D58, CRC1 CRC2] (len 62 max)
frame_1 = [RPC_PUSH_FRAME_MORE, D59,...D117, CRC1 CRC2] (len 62 max)
frame_2 = [RPC_PUSH_FRAME_LAST, D118,...D149, CRC1 CRC2] (len 62 max)</p>

<p>Before transmission each frame is first Cobbs encoded as:</p>

<p>[ OverheadByte 62_bytes_max_encoded DelimiterByte] (Len 64 max)</p>

<p>A push transaction does not return status data back. It returns a RPC_PUSH_x_ACK to acknowledge that a frame was
succesfully recieved. It also returns an RPC_ID_ACK for the callback to verify that the correct RPC call was completed.</p>

<p>reply_frame_0 = [RPC_PUSH_ACK RPC_ID_ACK CRC1 CRC2]</p>

<p>Finally, reply data is decoded and passed to the rpc_callback</p>
</div>


                            </div>
                            <div id="AsyncTransactionHandler.do_transaction_v0" class="classattr">
                                        <input id="AsyncTransactionHandler.do_transaction_v0-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_transaction_v0</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">rpc</span>, </span><span class="param"><span class="n">rpc_callback</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="AsyncTransactionHandler.do_transaction_v0-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AsyncTransactionHandler.do_transaction_v0"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AsyncTransactionHandler.do_transaction_v0-663"><a href="#AsyncTransactionHandler.do_transaction_v0-663"><span class="linenos">663</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_transaction_v0</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rpc</span><span class="p">,</span> <span class="n">rpc_callback</span><span class="p">):</span>  <span class="c1"># Handle a single RPC transaction</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-664"><a href="#AsyncTransactionHandler.do_transaction_v0-664"><span class="linenos">664</span></a>        <span class="n">frame_buf</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">COBBS_FRAME_SIZE_V0</span><span class="p">))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-665"><a href="#AsyncTransactionHandler.do_transaction_v0-665"><span class="linenos">665</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-666"><a href="#AsyncTransactionHandler.do_transaction_v0-666"><span class="linenos">666</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-667"><a href="#AsyncTransactionHandler.do_transaction_v0-667"><span class="linenos">667</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;--------------- New RPC -------------------------</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-668"><a href="#AsyncTransactionHandler.do_transaction_v0-668"><span class="linenos">668</span></a>            <span class="c1">########## Initiate new RPC</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-669"><a href="#AsyncTransactionHandler.do_transaction_v0-669"><span class="linenos">669</span></a>            <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_START_NEW_RPC</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-670"><a href="#AsyncTransactionHandler.do_transaction_v0-670"><span class="linenos">670</span></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-671"><a href="#AsyncTransactionHandler.do_transaction_v0-671"><span class="linenos">671</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-672"><a href="#AsyncTransactionHandler.do_transaction_v0-672"><span class="linenos">672</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_START_NEW_RPC</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-673"><a href="#AsyncTransactionHandler.do_transaction_v0-673"><span class="linenos">673</span></a>            <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-674"><a href="#AsyncTransactionHandler.do_transaction_v0-674"><span class="linenos">674</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-675"><a href="#AsyncTransactionHandler.do_transaction_v0-675"><span class="linenos">675</span></a>                <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-676"><a href="#AsyncTransactionHandler.do_transaction_v0-676"><span class="linenos">676</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_ACK_NEW_RPC CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-677"><a href="#AsyncTransactionHandler.do_transaction_v0-677"><span class="linenos">677</span></a>                        <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-678"><a href="#AsyncTransactionHandler.do_transaction_v0-678"><span class="linenos">678</span></a>                        <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-679"><a href="#AsyncTransactionHandler.do_transaction_v0-679"><span class="linenos">679</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-680"><a href="#AsyncTransactionHandler.do_transaction_v0-680"><span class="linenos">680</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_ACK_NEW_RPC&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-681"><a href="#AsyncTransactionHandler.do_transaction_v0-681"><span class="linenos">681</span></a>
</span><span id="AsyncTransactionHandler.do_transaction_v0-682"><a href="#AsyncTransactionHandler.do_transaction_v0-682"><span class="linenos">682</span></a>            <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_NEW_RPC</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-683"><a href="#AsyncTransactionHandler.do_transaction_v0-683"><span class="linenos">683</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-684"><a href="#AsyncTransactionHandler.do_transaction_v0-684"><span class="linenos">684</span></a>                    <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_NEW_RPC </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-685"><a href="#AsyncTransactionHandler.do_transaction_v0-685"><span class="linenos">685</span></a>                <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-686"><a href="#AsyncTransactionHandler.do_transaction_v0-686"><span class="linenos">686</span></a>
</span><span id="AsyncTransactionHandler.do_transaction_v0-687"><a href="#AsyncTransactionHandler.do_transaction_v0-687"><span class="linenos">687</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-688"><a href="#AsyncTransactionHandler.do_transaction_v0-688"><span class="linenos">688</span></a>            <span class="c1">#    print(&#39;New RPC initiated, len&#39;,len(rpc))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-689"><a href="#AsyncTransactionHandler.do_transaction_v0-689"><span class="linenos">689</span></a>            <span class="c1">########### Send all blocks</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-690"><a href="#AsyncTransactionHandler.do_transaction_v0-690"><span class="linenos">690</span></a>            <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-691"><a href="#AsyncTransactionHandler.do_transaction_v0-691"><span class="linenos">691</span></a>            <span class="k">while</span> <span class="n">ntx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-692"><a href="#AsyncTransactionHandler.do_transaction_v0-692"><span class="linenos">692</span></a>                <span class="n">nb</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">)</span> <span class="o">-</span> <span class="n">ntx</span><span class="p">,</span> <span class="n">RPC_V0_BLOCK_SIZE</span><span class="p">)</span>  <span class="c1"># Num bytes to send</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-693"><a href="#AsyncTransactionHandler.do_transaction_v0-693"><span class="linenos">693</span></a>                <span class="n">b</span> <span class="o">=</span> <span class="n">rpc</span><span class="p">[</span><span class="n">ntx</span><span class="p">:</span><span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-694"><a href="#AsyncTransactionHandler.do_transaction_v0-694"><span class="linenos">694</span></a>                <span class="n">ntx</span> <span class="o">=</span> <span class="n">ntx</span> <span class="o">+</span> <span class="n">nb</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-695"><a href="#AsyncTransactionHandler.do_transaction_v0-695"><span class="linenos">695</span></a>                <span class="k">if</span> <span class="n">ntx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">rpc</span><span class="p">):</span>  <span class="c1"># Last block</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-696"><a href="#AsyncTransactionHandler.do_transaction_v0-696"><span class="linenos">696</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_LAST</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-697"><a href="#AsyncTransactionHandler.do_transaction_v0-697"><span class="linenos">697</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-698"><a href="#AsyncTransactionHandler.do_transaction_v0-698"><span class="linenos">698</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-699"><a href="#AsyncTransactionHandler.do_transaction_v0-699"><span class="linenos">699</span></a>                    <span class="c1">#    print(&#39;Sending last block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-700"><a href="#AsyncTransactionHandler.do_transaction_v0-700"><span class="linenos">700</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-701"><a href="#AsyncTransactionHandler.do_transaction_v0-701"><span class="linenos">701</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-702"><a href="#AsyncTransactionHandler.do_transaction_v0-702"><span class="linenos">702</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_LAST</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-703"><a href="#AsyncTransactionHandler.do_transaction_v0-703"><span class="linenos">703</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-704"><a href="#AsyncTransactionHandler.do_transaction_v0-704"><span class="linenos">704</span></a>                    <span class="c1">#    print(&#39;Getting last block ack&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-705"><a href="#AsyncTransactionHandler.do_transaction_v0-705"><span class="linenos">705</span></a>
</span><span id="AsyncTransactionHandler.do_transaction_v0-706"><a href="#AsyncTransactionHandler.do_transaction_v0-706"><span class="linenos">706</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-707"><a href="#AsyncTransactionHandler.do_transaction_v0-707"><span class="linenos">707</span></a>
</span><span id="AsyncTransactionHandler.do_transaction_v0-708"><a href="#AsyncTransactionHandler.do_transaction_v0-708"><span class="linenos">708</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-709"><a href="#AsyncTransactionHandler.do_transaction_v0-709"><span class="linenos">709</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-710"><a href="#AsyncTransactionHandler.do_transaction_v0-710"><span class="linenos">710</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_LAST CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-711"><a href="#AsyncTransactionHandler.do_transaction_v0-711"><span class="linenos">711</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-712"><a href="#AsyncTransactionHandler.do_transaction_v0-712"><span class="linenos">712</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-713"><a href="#AsyncTransactionHandler.do_transaction_v0-713"><span class="linenos">713</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-714"><a href="#AsyncTransactionHandler.do_transaction_v0-714"><span class="linenos">714</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_LAST&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-715"><a href="#AsyncTransactionHandler.do_transaction_v0-715"><span class="linenos">715</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-716"><a href="#AsyncTransactionHandler.do_transaction_v0-716"><span class="linenos">716</span></a>                    <span class="c1">#    print(&#39;Last block ack rcvd&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-717"><a href="#AsyncTransactionHandler.do_transaction_v0-717"><span class="linenos">717</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_LAST</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-718"><a href="#AsyncTransactionHandler.do_transaction_v0-718"><span class="linenos">718</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-719"><a href="#AsyncTransactionHandler.do_transaction_v0-719"><span class="linenos">719</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_LAST </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-720"><a href="#AsyncTransactionHandler.do_transaction_v0-720"><span class="linenos">720</span></a>                                                                                                  <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-721"><a href="#AsyncTransactionHandler.do_transaction_v0-721"><span class="linenos">721</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-722"><a href="#AsyncTransactionHandler.do_transaction_v0-722"><span class="linenos">722</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-723"><a href="#AsyncTransactionHandler.do_transaction_v0-723"><span class="linenos">723</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_SEND_BLOCK_MORE</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-724"><a href="#AsyncTransactionHandler.do_transaction_v0-724"><span class="linenos">724</span></a>                    <span class="n">frame_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-725"><a href="#AsyncTransactionHandler.do_transaction_v0-725"><span class="linenos">725</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-726"><a href="#AsyncTransactionHandler.do_transaction_v0-726"><span class="linenos">726</span></a>                    <span class="c1">#    print(&#39;Sending next block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-727"><a href="#AsyncTransactionHandler.do_transaction_v0-727"><span class="linenos">727</span></a>                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-728"><a href="#AsyncTransactionHandler.do_transaction_v0-728"><span class="linenos">728</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-729"><a href="#AsyncTransactionHandler.do_transaction_v0-729"><span class="linenos">729</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer sent RPC_V0_SEND_BLOCK_MORE</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-730"><a href="#AsyncTransactionHandler.do_transaction_v0-730"><span class="linenos">730</span></a>                    <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-731"><a href="#AsyncTransactionHandler.do_transaction_v0-731"><span class="linenos">731</span></a>                    <span class="c1">#    print(&#39;Sent next block&#39;,ntx)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-732"><a href="#AsyncTransactionHandler.do_transaction_v0-732"><span class="linenos">732</span></a>                    <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-733"><a href="#AsyncTransactionHandler.do_transaction_v0-733"><span class="linenos">733</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-734"><a href="#AsyncTransactionHandler.do_transaction_v0-734"><span class="linenos">734</span></a>                        <span class="k">if</span> <span class="n">nr</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-735"><a href="#AsyncTransactionHandler.do_transaction_v0-735"><span class="linenos">735</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd on RPC_V0_SEND_BLOCK_MORE CRC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-736"><a href="#AsyncTransactionHandler.do_transaction_v0-736"><span class="linenos">736</span></a>                                <span class="n">crc_ok</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; NR: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39; Expected B0: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-737"><a href="#AsyncTransactionHandler.do_transaction_v0-737"><span class="linenos">737</span></a>                                <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-738"><a href="#AsyncTransactionHandler.do_transaction_v0-738"><span class="linenos">738</span></a>                        <span class="k">else</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-739"><a href="#AsyncTransactionHandler.do_transaction_v0-739"><span class="linenos">739</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span> <span class="o">+</span> <span class="s1">&#39;Framer rcvd 0 bytes on RPC_V0_SEND_BLOCK_MORE&#39;</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-740"><a href="#AsyncTransactionHandler.do_transaction_v0-740"><span class="linenos">740</span></a>                    <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">RPC_V0_ACK_SEND_BLOCK_MORE</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-741"><a href="#AsyncTransactionHandler.do_transaction_v0-741"><span class="linenos">741</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-742"><a href="#AsyncTransactionHandler.do_transaction_v0-742"><span class="linenos">742</span></a>                            <span class="s1">&#39;Transport RX Error on RPC_V0_ACK_SEND_BLOCK_MORE </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-743"><a href="#AsyncTransactionHandler.do_transaction_v0-743"><span class="linenos">743</span></a>                                                                                                  <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-744"><a href="#AsyncTransactionHandler.do_transaction_v0-744"><span class="linenos">744</span></a>                        <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-745"><a href="#AsyncTransactionHandler.do_transaction_v0-745"><span class="linenos">745</span></a>            <span class="c1">########### Receive all blocks</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-746"><a href="#AsyncTransactionHandler.do_transaction_v0-746"><span class="linenos">746</span></a>            <span class="n">reply</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-747"><a href="#AsyncTransactionHandler.do_transaction_v0-747"><span class="linenos">747</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-748"><a href="#AsyncTransactionHandler.do_transaction_v0-748"><span class="linenos">748</span></a>            <span class="c1">#    print(&#39;Receiving RPC reply&#39;)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-749"><a href="#AsyncTransactionHandler.do_transaction_v0-749"><span class="linenos">749</span></a>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-750"><a href="#AsyncTransactionHandler.do_transaction_v0-750"><span class="linenos">750</span></a>                <span class="n">frame_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">RPC_V0_GET_BLOCK</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-751"><a href="#AsyncTransactionHandler.do_transaction_v0-751"><span class="linenos">751</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-752"><a href="#AsyncTransactionHandler.do_transaction_v0-752"><span class="linenos">752</span></a>                <span class="c1">#    print(&#39;Block requested&#39;)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-753"><a href="#AsyncTransactionHandler.do_transaction_v0-753"><span class="linenos">753</span></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendFramedData</span><span class="p">(</span><span class="n">frame_buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-754"><a href="#AsyncTransactionHandler.do_transaction_v0-754"><span class="linenos">754</span></a>                <span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">receiveFramedData</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-755"><a href="#AsyncTransactionHandler.do_transaction_v0-755"><span class="linenos">755</span></a>                <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-756"><a href="#AsyncTransactionHandler.do_transaction_v0-756"><span class="linenos">756</span></a>                <span class="c1">#    print(&#39;Block request success&#39;)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-757"><a href="#AsyncTransactionHandler.do_transaction_v0-757"><span class="linenos">757</span></a>                <span class="k">if</span> <span class="n">crc_ok</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-758"><a href="#AsyncTransactionHandler.do_transaction_v0-758"><span class="linenos">758</span></a>                        <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_MORE</span> <span class="ow">or</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">):</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-759"><a href="#AsyncTransactionHandler.do_transaction_v0-759"><span class="linenos">759</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-760"><a href="#AsyncTransactionHandler.do_transaction_v0-760"><span class="linenos">760</span></a>                        <span class="s1">&#39;Transport RX Error on RPC_V0_GET_BLOCK </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">crc_ok</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-761"><a href="#AsyncTransactionHandler.do_transaction_v0-761"><span class="linenos">761</span></a>                    <span class="k">raise</span> <span class="n">TransportError</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-762"><a href="#AsyncTransactionHandler.do_transaction_v0-762"><span class="linenos">762</span></a>                <span class="n">reply</span> <span class="o">=</span> <span class="n">reply</span> <span class="o">+</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="n">nr</span><span class="p">]</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-763"><a href="#AsyncTransactionHandler.do_transaction_v0-763"><span class="linenos">763</span></a>
</span><span id="AsyncTransactionHandler.do_transaction_v0-764"><a href="#AsyncTransactionHandler.do_transaction_v0-764"><span class="linenos">764</span></a>                <span class="k">if</span> <span class="n">decoded_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">RPC_V0_ACK_GET_BLOCK_LAST</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-765"><a href="#AsyncTransactionHandler.do_transaction_v0-765"><span class="linenos">765</span></a>                    <span class="k">break</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-766"><a href="#AsyncTransactionHandler.do_transaction_v0-766"><span class="linenos">766</span></a>            <span class="c1"># Now process the reply</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-767"><a href="#AsyncTransactionHandler.do_transaction_v0-767"><span class="linenos">767</span></a>            <span class="c1"># if self.dbg_on:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-768"><a href="#AsyncTransactionHandler.do_transaction_v0-768"><span class="linenos">768</span></a>            <span class="c1">#    print(&#39;Got reply&#39;,len(reply))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-769"><a href="#AsyncTransactionHandler.do_transaction_v0-769"><span class="linenos">769</span></a>            <span class="c1"># print(&#39;---------------------- RPC complete, elapsed time------------------:&#39;,time.time()-ts)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-770"><a href="#AsyncTransactionHandler.do_transaction_v0-770"><span class="linenos">770</span></a>            <span class="n">rpc_callback</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-771"><a href="#AsyncTransactionHandler.do_transaction_v0-771"><span class="linenos">771</span></a>        <span class="k">except</span> <span class="n">TransportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-772"><a href="#AsyncTransactionHandler.do_transaction_v0-772"><span class="linenos">772</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dbg_on</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-773"><a href="#AsyncTransactionHandler.do_transaction_v0-773"><span class="linenos">773</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---- Debug Exception&#39;</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-774"><a href="#AsyncTransactionHandler.do_transaction_v0-774"><span class="linenos">774</span></a>                <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dbg_buf</span><span class="p">)</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-775"><a href="#AsyncTransactionHandler.do_transaction_v0-775"><span class="linenos">775</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;read_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-776"><a href="#AsyncTransactionHandler.do_transaction_v0-776"><span class="linenos">776</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_output_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-777"><a href="#AsyncTransactionHandler.do_transaction_v0-777"><span class="linenos">777</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-778"><a href="#AsyncTransactionHandler.do_transaction_v0-778"><span class="linenos">778</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TransportError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-779"><a href="#AsyncTransactionHandler.do_transaction_v0-779"><span class="linenos">779</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialTimeoutException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-780"><a href="#AsyncTransactionHandler.do_transaction_v0-780"><span class="linenos">780</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;write_error&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-781"><a href="#AsyncTransactionHandler.do_transaction_v0-781"><span class="linenos">781</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-782"><a href="#AsyncTransactionHandler.do_transaction_v0-782"><span class="linenos">782</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialTimeoutException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-783"><a href="#AsyncTransactionHandler.do_transaction_v0-783"><span class="linenos">783</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-784"><a href="#AsyncTransactionHandler.do_transaction_v0-784"><span class="linenos">784</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-785"><a href="#AsyncTransactionHandler.do_transaction_v0-785"><span class="linenos">785</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-786"><a href="#AsyncTransactionHandler.do_transaction_v0-786"><span class="linenos">786</span></a>        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-787"><a href="#AsyncTransactionHandler.do_transaction_v0-787"><span class="linenos">787</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TypeError: </span><span class="si">%s</span><span class="s2"> : </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>
</span><span id="AsyncTransactionHandler.do_transaction_v0-788"><a href="#AsyncTransactionHandler.do_transaction_v0-788"><span class="linenos">788</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SyncTransactionHandler">SyncTransactionHandler</a></dt>
                                <dd id="AsyncTransactionHandler.ser" class="variable"><a href="#SyncTransactionHandler.ser">ser</a></dd>
                <dd id="AsyncTransactionHandler.logger" class="variable"><a href="#SyncTransactionHandler.logger">logger</a></dd>
                <dd id="AsyncTransactionHandler.port_name" class="variable"><a href="#SyncTransactionHandler.port_name">port_name</a></dd>
                <dd id="AsyncTransactionHandler.empty_frame" class="variable"><a href="#SyncTransactionHandler.empty_frame">empty_frame</a></dd>
                <dd id="AsyncTransactionHandler.status" class="variable"><a href="#SyncTransactionHandler.status">status</a></dd>
                <dd id="AsyncTransactionHandler.version" class="variable"><a href="#SyncTransactionHandler.version">version</a></dd>
                <dd id="AsyncTransactionHandler.timeout" class="variable"><a href="#SyncTransactionHandler.timeout">timeout</a></dd>
                <dd id="AsyncTransactionHandler.packet_marker" class="variable"><a href="#SyncTransactionHandler.packet_marker">packet_marker</a></dd>
                <dd id="AsyncTransactionHandler.lock" class="variable"><a href="#SyncTransactionHandler.lock">lock</a></dd>
                <dd id="AsyncTransactionHandler.dbg_buf" class="variable"><a href="#SyncTransactionHandler.dbg_buf">dbg_buf</a></dd>
                <dd id="AsyncTransactionHandler.dbg_on" class="variable"><a href="#SyncTransactionHandler.dbg_on">dbg_on</a></dd>
                <dd id="AsyncTransactionHandler.get_empty_frame" class="function"><a href="#SyncTransactionHandler.get_empty_frame">get_empty_frame</a></dd>
                <dd id="AsyncTransactionHandler.handle_push_ack_v1" class="function"><a href="#SyncTransactionHandler.handle_push_ack_v1">handle_push_ack_v1</a></dd>
                <dd id="AsyncTransactionHandler.handle_pull_ack_v1" class="function"><a href="#SyncTransactionHandler.handle_pull_ack_v1">handle_pull_ack_v1</a></dd>
                <dd id="AsyncTransactionHandler.receiveFramedData2" class="function"><a href="#SyncTransactionHandler.receiveFramedData2">receiveFramedData2</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="Transport">
                            <input id="Transport-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Transport</span>:

                <label class="view-source-button" for="Transport-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport-791"><a href="#Transport-791"><span class="linenos">791</span></a><span class="k">class</span> <span class="nc">Transport</span><span class="p">():</span>
</span><span id="Transport-792"><a href="#Transport-792"><span class="linenos">792</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-793"><a href="#Transport-793"><span class="linenos">793</span></a><span class="sd">    Handle serial communications to a Hello Robot USB device using pySerial and asyncio</span>
</span><span id="Transport-794"><a href="#Transport-794"><span class="linenos">794</span></a>
</span><span id="Transport-795"><a href="#Transport-795"><span class="linenos">795</span></a><span class="sd">    Aioserial supports the standard  pySerial interface as well as async versions of the pySerial interface.</span>
</span><span id="Transport-796"><a href="#Transport-796"><span class="linenos">796</span></a><span class="sd">    This enables Transport to support both synchronous and asynchromous calls.</span>
</span><span id="Transport-797"><a href="#Transport-797"><span class="linenos">797</span></a><span class="sd">    Devices can use standard pySerial for non-timing critical transactions.</span>
</span><span id="Transport-798"><a href="#Transport-798"><span class="linenos">798</span></a><span class="sd">    They can use the asyncio interfaces for timing critical transactions where blocking on the RPC call is not desirable</span>
</span><span id="Transport-799"><a href="#Transport-799"><span class="linenos">799</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Transport-800"><a href="#Transport-800"><span class="linenos">800</span></a>
</span><span id="Transport-801"><a href="#Transport-801"><span class="linenos">801</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usb</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()):</span>
</span><span id="Transport-802"><a href="#Transport-802"><span class="linenos">802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">usb</span>
</span><span id="Transport-803"><a href="#Transport-803"><span class="linenos">803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="Transport-804"><a href="#Transport-804"><span class="linenos">804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="Transport-805"><a href="#Transport-805"><span class="linenos">805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Transport-806"><a href="#Transport-806"><span class="linenos">806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">RPC_DATA_MAX_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># RPC ID + 1024 bytes of data</span>
</span><span id="Transport-807"><a href="#Transport-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span><span id="Transport-808"><a href="#Transport-808"><span class="linenos">808</span></a>
</span><span id="Transport-809"><a href="#Transport-809"><span class="linenos">809</span></a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Transport-810"><a href="#Transport-810"><span class="linenos">810</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Transport-811"><a href="#Transport-811"><span class="linenos">811</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport-812"><a href="#Transport-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">aioserial</span><span class="o">.</span><span class="n">AioSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">write_timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="Transport-813"><a href="#Transport-813"><span class="linenos">813</span></a>            <span class="c1"># self.ser = serial.Serial(self.port_name,write_timeout=1.0)  # PosixPollSerial(self.usb)#Serial(self.usb)# 115200)  # , write_timeout=1.0)  # Baud not important since USB comms</span>
</span><span id="Transport-814"><a href="#Transport-814"><span class="linenos">814</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span> <span class="o">=</span> <span class="n">AsyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="Transport-815"><a href="#Transport-815"><span class="linenos">815</span></a>                                                         <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="Transport-816"><a href="#Transport-816"><span class="linenos">816</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span> <span class="o">=</span> <span class="n">SyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="Transport-817"><a href="#Transport-817"><span class="linenos">817</span></a>                                                       <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="Transport-818"><a href="#Transport-818"><span class="linenos">818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="Transport-819"><a href="#Transport-819"><span class="linenos">819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;sync&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="Transport-820"><a href="#Transport-820"><span class="linenos">820</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">isOpen</span><span class="p">():</span>
</span><span id="Transport-821"><a href="#Transport-821"><span class="linenos">821</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Transport-822"><a href="#Transport-822"><span class="linenos">822</span></a>                    <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
</span><span id="Transport-823"><a href="#Transport-823"><span class="linenos">823</span></a>                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Transport-824"><a href="#Transport-824"><span class="linenos">824</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="Transport-825"><a href="#Transport-825"><span class="linenos">825</span></a>                        <span class="s1">&#39;Port </span><span class="si">%s</span><span class="s1"> is busy. Check if another Stretch Body process is already running&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport-826"><a href="#Transport-826"><span class="linenos">826</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Transport-827"><a href="#Transport-827"><span class="linenos">827</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Transport-828"><a href="#Transport-828"><span class="linenos">828</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Transport-829"><a href="#Transport-829"><span class="linenos">829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="Transport-830"><a href="#Transport-830"><span class="linenos">830</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Transport-831"><a href="#Transport-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Transport-832"><a href="#Transport-832"><span class="linenos">832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to open serial port for device </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport-833"><a href="#Transport-833"><span class="linenos">833</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># return if hardware connection valid</span>
</span><span id="Transport-834"><a href="#Transport-834"><span class="linenos">834</span></a>
</span><span id="Transport-835"><a href="#Transport-835"><span class="linenos">835</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Transport-836"><a href="#Transport-836"><span class="linenos">836</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="Transport-837"><a href="#Transport-837"><span class="linenos">837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Shutting down TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport-838"><a href="#Transport-838"><span class="linenos">838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Transport-839"><a href="#Transport-839"><span class="linenos">839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Transport-840"><a href="#Transport-840"><span class="linenos">840</span></a>
</span><span id="Transport-841"><a href="#Transport-841"><span class="linenos">841</span></a>    <span class="k">def</span> <span class="nf">get_empty_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="Transport-842"><a href="#Transport-842"><span class="linenos">842</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span><span class="p">[:]</span>
</span><span id="Transport-843"><a href="#Transport-843"><span class="linenos">843</span></a>
</span><span id="Transport-844"><a href="#Transport-844"><span class="linenos">844</span></a>    <span class="k">def</span> <span class="nf">configure_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firmware_version</span><span class="p">):</span>
</span><span id="Transport-845"><a href="#Transport-845"><span class="linenos">845</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-846"><a href="#Transport-846"><span class="linenos">846</span></a><span class="sd">        Starting with Stepper/Wacc/Pimu firmware v0.4.0 a faster version (V1) of the transport layer is supported</span>
</span><span id="Transport-847"><a href="#Transport-847"><span class="linenos">847</span></a><span class="sd">        Check here if can run the Transport in V1 mode</span>
</span><span id="Transport-848"><a href="#Transport-848"><span class="linenos">848</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport-849"><a href="#Transport-849"><span class="linenos">849</span></a>        <span class="n">xl</span> <span class="o">=</span> <span class="n">firmware_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span><span id="Transport-850"><a href="#Transport-850"><span class="linenos">850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="Transport-851"><a href="#Transport-851"><span class="linenos">851</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid firmware version len&#39;</span><span class="p">)</span>
</span><span id="Transport-852"><a href="#Transport-852"><span class="linenos">852</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Transport-853"><a href="#Transport-853"><span class="linenos">853</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Stepper&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Wacc&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Pimu&#39;</span><span class="p">):</span>
</span><span id="Transport-854"><a href="#Transport-854"><span class="linenos">854</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid device name &#39;</span><span class="p">)</span>
</span><span id="Transport-855"><a href="#Transport-855"><span class="linenos">855</span></a>        <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Transport-856"><a href="#Transport-856"><span class="linenos">856</span></a>        <span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="Transport-857"><a href="#Transport-857"><span class="linenos">857</span></a>        <span class="k">if</span> <span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Transport-858"><a href="#Transport-858"><span class="linenos">858</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">)</span>
</span><span id="Transport-859"><a href="#Transport-859"><span class="linenos">859</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Transport-860"><a href="#Transport-860"><span class="linenos">860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">)</span>
</span><span id="Transport-861"><a href="#Transport-861"><span class="linenos">861</span></a>
</span><span id="Transport-862"><a href="#Transport-862"><span class="linenos">862</span></a>    <span class="k">def</span> <span class="nf">set_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Transport-863"><a href="#Transport-863"><span class="linenos">863</span></a>        <span class="c1"># print(&#39;VERSION&#39;,v,self.port_name)</span>
</span><span id="Transport-864"><a href="#Transport-864"><span class="linenos">864</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Transport-865"><a href="#Transport-865"><span class="linenos">865</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid version for Transport&#39;</span><span class="p">)</span>
</span><span id="Transport-866"><a href="#Transport-866"><span class="linenos">866</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Transport-867"><a href="#Transport-867"><span class="linenos">867</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="Transport-868"><a href="#Transport-868"><span class="linenos">868</span></a>
</span><span id="Transport-869"><a href="#Transport-869"><span class="linenos">869</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport-870"><a href="#Transport-870"><span class="linenos">870</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-871"><a href="#Transport-871"><span class="linenos">871</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="Transport-872"><a href="#Transport-872"><span class="linenos">872</span></a><span class="sd">        Parameters</span>
</span><span id="Transport-873"><a href="#Transport-873"><span class="linenos">873</span></a><span class="sd">        ----------</span>
</span><span id="Transport-874"><a href="#Transport-874"><span class="linenos">874</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport-875"><a href="#Transport-875"><span class="linenos">875</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport-876"><a href="#Transport-876"><span class="linenos">876</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport-877"><a href="#Transport-877"><span class="linenos">877</span></a>
</span><span id="Transport-878"><a href="#Transport-878"><span class="linenos">878</span></a><span class="sd">        Returns</span>
</span><span id="Transport-879"><a href="#Transport-879"><span class="linenos">879</span></a><span class="sd">        -------</span>
</span><span id="Transport-880"><a href="#Transport-880"><span class="linenos">880</span></a><span class="sd">        None</span>
</span><span id="Transport-881"><a href="#Transport-881"><span class="linenos">881</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport-882"><a href="#Transport-882"><span class="linenos">882</span></a>        <span class="c1"># Acquire the lock in a worker thread, suspending us while waiting.</span>
</span><span id="Transport-883"><a href="#Transport-883"><span class="linenos">883</span></a>        <span class="c1"># See https://stackoverflow.com/questions/63420413/how-to-use-threading-lock-in-async-function-while-object-can-be-accessed-from-mu</span>
</span><span id="Transport-884"><a href="#Transport-884"><span class="linenos">884</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="Transport-885"><a href="#Transport-885"><span class="linenos">885</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="Transport-886"><a href="#Transport-886"><span class="linenos">886</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="Transport-887"><a href="#Transport-887"><span class="linenos">887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="Transport-888"><a href="#Transport-888"><span class="linenos">888</span></a>
</span><span id="Transport-889"><a href="#Transport-889"><span class="linenos">889</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport-890"><a href="#Transport-890"><span class="linenos">890</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-891"><a href="#Transport-891"><span class="linenos">891</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="Transport-892"><a href="#Transport-892"><span class="linenos">892</span></a><span class="sd">        Parameters</span>
</span><span id="Transport-893"><a href="#Transport-893"><span class="linenos">893</span></a><span class="sd">        ----------</span>
</span><span id="Transport-894"><a href="#Transport-894"><span class="linenos">894</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport-895"><a href="#Transport-895"><span class="linenos">895</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport-896"><a href="#Transport-896"><span class="linenos">896</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport-897"><a href="#Transport-897"><span class="linenos">897</span></a><span class="sd">        Returns</span>
</span><span id="Transport-898"><a href="#Transport-898"><span class="linenos">898</span></a><span class="sd">        -------</span>
</span><span id="Transport-899"><a href="#Transport-899"><span class="linenos">899</span></a><span class="sd">        None</span>
</span><span id="Transport-900"><a href="#Transport-900"><span class="linenos">900</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport-901"><a href="#Transport-901"><span class="linenos">901</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="Transport-902"><a href="#Transport-902"><span class="linenos">902</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="Transport-903"><a href="#Transport-903"><span class="linenos">903</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="Transport-904"><a href="#Transport-904"><span class="linenos">904</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="Transport-905"><a href="#Transport-905"><span class="linenos">905</span></a>
</span><span id="Transport-906"><a href="#Transport-906"><span class="linenos">906</span></a>    <span class="k">def</span> <span class="nf">do_pull_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport-907"><a href="#Transport-907"><span class="linenos">907</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-908"><a href="#Transport-908"><span class="linenos">908</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="Transport-909"><a href="#Transport-909"><span class="linenos">909</span></a><span class="sd">        Parameters</span>
</span><span id="Transport-910"><a href="#Transport-910"><span class="linenos">910</span></a><span class="sd">        ----------</span>
</span><span id="Transport-911"><a href="#Transport-911"><span class="linenos">911</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport-912"><a href="#Transport-912"><span class="linenos">912</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport-913"><a href="#Transport-913"><span class="linenos">913</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport-914"><a href="#Transport-914"><span class="linenos">914</span></a>
</span><span id="Transport-915"><a href="#Transport-915"><span class="linenos">915</span></a><span class="sd">        Returns</span>
</span><span id="Transport-916"><a href="#Transport-916"><span class="linenos">916</span></a><span class="sd">        -------</span>
</span><span id="Transport-917"><a href="#Transport-917"><span class="linenos">917</span></a><span class="sd">        None</span>
</span><span id="Transport-918"><a href="#Transport-918"><span class="linenos">918</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport-919"><a href="#Transport-919"><span class="linenos">919</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="Transport-920"><a href="#Transport-920"><span class="linenos">920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="Transport-921"><a href="#Transport-921"><span class="linenos">921</span></a>
</span><span id="Transport-922"><a href="#Transport-922"><span class="linenos">922</span></a>    <span class="k">def</span> <span class="nf">do_push_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport-923"><a href="#Transport-923"><span class="linenos">923</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport-924"><a href="#Transport-924"><span class="linenos">924</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="Transport-925"><a href="#Transport-925"><span class="linenos">925</span></a><span class="sd">        Parameters</span>
</span><span id="Transport-926"><a href="#Transport-926"><span class="linenos">926</span></a><span class="sd">        ----------</span>
</span><span id="Transport-927"><a href="#Transport-927"><span class="linenos">927</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport-928"><a href="#Transport-928"><span class="linenos">928</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport-929"><a href="#Transport-929"><span class="linenos">929</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport-930"><a href="#Transport-930"><span class="linenos">930</span></a>
</span><span id="Transport-931"><a href="#Transport-931"><span class="linenos">931</span></a><span class="sd">        Returns</span>
</span><span id="Transport-932"><a href="#Transport-932"><span class="linenos">932</span></a><span class="sd">        -------</span>
</span><span id="Transport-933"><a href="#Transport-933"><span class="linenos">933</span></a><span class="sd">        None</span>
</span><span id="Transport-934"><a href="#Transport-934"><span class="linenos">934</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport-935"><a href="#Transport-935"><span class="linenos">935</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="Transport-936"><a href="#Transport-936"><span class="linenos">936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Handle serial communications to a Hello Robot USB device using pySerial and asyncio</p>

<p>Aioserial supports the standard  pySerial interface as well as async versions of the pySerial interface.
This enables Transport to support both synchronous and asynchromous calls.
Devices can use standard pySerial for non-timing critical transactions.
They can use the asyncio interfaces for timing critical transactions where blocking on the RPC call is not desirable</p>
</div>


                            <div id="Transport.__init__" class="classattr">
                                        <input id="Transport.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Transport</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">usb</span>, </span><span class="param"><span class="n">logger</span><span class="o">=&lt;</span><span class="n">RootLogger</span> <span class="n">root</span> <span class="p">(</span><span class="n">DEBUG</span><span class="p">)</span><span class="o">&gt;</span></span>)</span>

                <label class="view-source-button" for="Transport.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.__init__-801"><a href="#Transport.__init__-801"><span class="linenos">801</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usb</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()):</span>
</span><span id="Transport.__init__-802"><a href="#Transport.__init__-802"><span class="linenos">802</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span> <span class="o">=</span> <span class="n">usb</span>
</span><span id="Transport.__init__-803"><a href="#Transport.__init__-803"><span class="linenos">803</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span>
</span><span id="Transport.__init__-804"><a href="#Transport.__init__-804"><span class="linenos">804</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="Transport.__init__-805"><a href="#Transport.__init__-805"><span class="linenos">805</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="Transport.__init__-806"><a href="#Transport.__init__-806"><span class="linenos">806</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">RPC_DATA_MAX_BYTES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># RPC ID + 1024 bytes of data</span>
</span><span id="Transport.__init__-807"><a href="#Transport.__init__-807"><span class="linenos">807</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">RPC_TRANSPORT_VERSION_0</span>
</span></pre></div>


    

                            </div>
                            <div id="Transport.port_name" class="classattr">
                                <div class="attr variable">
            <span class="name">port_name</span>

        
    </div>
    <a class="headerlink" href="#Transport.port_name"></a>
    
    

                            </div>
                            <div id="Transport.logger" class="classattr">
                                <div class="attr variable">
            <span class="name">logger</span>

        
    </div>
    <a class="headerlink" href="#Transport.logger"></a>
    
    

                            </div>
                            <div id="Transport.lock" class="classattr">
                                <div class="attr variable">
            <span class="name">lock</span>

        
    </div>
    <a class="headerlink" href="#Transport.lock"></a>
    
    

                            </div>
                            <div id="Transport.status" class="classattr">
                                <div class="attr variable">
            <span class="name">status</span>

        
    </div>
    <a class="headerlink" href="#Transport.status"></a>
    
    

                            </div>
                            <div id="Transport.empty_payload" class="classattr">
                                <div class="attr variable">
            <span class="name">empty_payload</span>

        
    </div>
    <a class="headerlink" href="#Transport.empty_payload"></a>
    
    

                            </div>
                            <div id="Transport.version" class="classattr">
                                <div class="attr variable">
            <span class="name">version</span>

        
    </div>
    <a class="headerlink" href="#Transport.version"></a>
    
    

                            </div>
                            <div id="Transport.startup" class="classattr">
                                        <input id="Transport.startup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">startup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.startup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.startup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.startup-809"><a href="#Transport.startup-809"><span class="linenos">809</span></a>    <span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Transport.startup-810"><a href="#Transport.startup-810"><span class="linenos">810</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Transport.startup-811"><a href="#Transport.startup-811"><span class="linenos">811</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Starting TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport.startup-812"><a href="#Transport.startup-812"><span class="linenos">812</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="n">aioserial</span><span class="o">.</span><span class="n">AioSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">write_timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="Transport.startup-813"><a href="#Transport.startup-813"><span class="linenos">813</span></a>            <span class="c1"># self.ser = serial.Serial(self.port_name,write_timeout=1.0)  # PosixPollSerial(self.usb)#Serial(self.usb)# 115200)  # , write_timeout=1.0)  # Baud not important since USB comms</span>
</span><span id="Transport.startup-814"><a href="#Transport.startup-814"><span class="linenos">814</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span> <span class="o">=</span> <span class="n">AsyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="Transport.startup-815"><a href="#Transport.startup-815"><span class="linenos">815</span></a>                                                         <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="Transport.startup-816"><a href="#Transport.startup-816"><span class="linenos">816</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span> <span class="o">=</span> <span class="n">SyncTransactionHandler</span><span class="p">(</span><span class="n">port_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">,</span> <span class="n">ser</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
</span><span id="Transport.startup-817"><a href="#Transport.startup-817"><span class="linenos">817</span></a>                                                       <span class="n">lock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">)</span>
</span><span id="Transport.startup-818"><a href="#Transport.startup-818"><span class="linenos">818</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;async&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="Transport.startup-819"><a href="#Transport.startup-819"><span class="linenos">819</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s1">&#39;sync&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">status</span>
</span><span id="Transport.startup-820"><a href="#Transport.startup-820"><span class="linenos">820</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">isOpen</span><span class="p">():</span>
</span><span id="Transport.startup-821"><a href="#Transport.startup-821"><span class="linenos">821</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="Transport.startup-822"><a href="#Transport.startup-822"><span class="linenos">822</span></a>                    <span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span> <span class="o">|</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_NB</span><span class="p">)</span>
</span><span id="Transport.startup-823"><a href="#Transport.startup-823"><span class="linenos">823</span></a>                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span id="Transport.startup-824"><a href="#Transport.startup-824"><span class="linenos">824</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
</span><span id="Transport.startup-825"><a href="#Transport.startup-825"><span class="linenos">825</span></a>                        <span class="s1">&#39;Port </span><span class="si">%s</span><span class="s1"> is busy. Check if another Stretch Body process is already running&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport.startup-826"><a href="#Transport.startup-826"><span class="linenos">826</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Transport.startup-827"><a href="#Transport.startup-827"><span class="linenos">827</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Transport.startup-828"><a href="#Transport.startup-828"><span class="linenos">828</span></a>        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="Transport.startup-829"><a href="#Transport.startup-829"><span class="linenos">829</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;SerialException(</span><span class="si">{0}</span><span class="s2">): </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">strerror</span><span class="p">))</span>
</span><span id="Transport.startup-830"><a href="#Transport.startup-830"><span class="linenos">830</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Transport.startup-831"><a href="#Transport.startup-831"><span class="linenos">831</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Transport.startup-832"><a href="#Transport.startup-832"><span class="linenos">832</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Unable to open serial port for device </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport.startup-833"><a href="#Transport.startup-833"><span class="linenos">833</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># return if hardware connection valid</span>
</span></pre></div>


    

                            </div>
                            <div id="Transport.stop" class="classattr">
                                        <input id="Transport.stop-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">stop</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.stop-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.stop"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.stop-835"><a href="#Transport.stop-835"><span class="linenos">835</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Transport.stop-836"><a href="#Transport.stop-836"><span class="linenos">836</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="p">:</span>
</span><span id="Transport.stop-837"><a href="#Transport.stop-837"><span class="linenos">837</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Shutting down TransportConnection on: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">port_name</span><span class="p">)</span>
</span><span id="Transport.stop-838"><a href="#Transport.stop-838"><span class="linenos">838</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Transport.stop-839"><a href="#Transport.stop-839"><span class="linenos">839</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">ser</span> <span class="o">=</span> <span class="kc">None</span>
</span></pre></div>


    

                            </div>
                            <div id="Transport.get_empty_payload" class="classattr">
                                        <input id="Transport.get_empty_payload-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_empty_payload</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.get_empty_payload-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.get_empty_payload"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.get_empty_payload-841"><a href="#Transport.get_empty_payload-841"><span class="linenos">841</span></a>    <span class="k">def</span> <span class="nf">get_empty_payload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Just a fast convience function to create a large array of &#39;B&#39;</span>
</span><span id="Transport.get_empty_payload-842"><a href="#Transport.get_empty_payload-842"><span class="linenos">842</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_payload</span><span class="p">[:]</span>
</span></pre></div>


    

                            </div>
                            <div id="Transport.configure_version" class="classattr">
                                        <input id="Transport.configure_version-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">configure_version</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">firmware_version</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.configure_version-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.configure_version"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.configure_version-844"><a href="#Transport.configure_version-844"><span class="linenos">844</span></a>    <span class="k">def</span> <span class="nf">configure_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firmware_version</span><span class="p">):</span>
</span><span id="Transport.configure_version-845"><a href="#Transport.configure_version-845"><span class="linenos">845</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport.configure_version-846"><a href="#Transport.configure_version-846"><span class="linenos">846</span></a><span class="sd">        Starting with Stepper/Wacc/Pimu firmware v0.4.0 a faster version (V1) of the transport layer is supported</span>
</span><span id="Transport.configure_version-847"><a href="#Transport.configure_version-847"><span class="linenos">847</span></a><span class="sd">        Check here if can run the Transport in V1 mode</span>
</span><span id="Transport.configure_version-848"><a href="#Transport.configure_version-848"><span class="linenos">848</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport.configure_version-849"><a href="#Transport.configure_version-849"><span class="linenos">849</span></a>        <span class="n">xl</span> <span class="o">=</span> <span class="n">firmware_version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
</span><span id="Transport.configure_version-850"><a href="#Transport.configure_version-850"><span class="linenos">850</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
</span><span id="Transport.configure_version-851"><a href="#Transport.configure_version-851"><span class="linenos">851</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid firmware version len&#39;</span><span class="p">)</span>
</span><span id="Transport.configure_version-852"><a href="#Transport.configure_version-852"><span class="linenos">852</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">xl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Transport.configure_version-853"><a href="#Transport.configure_version-853"><span class="linenos">853</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Stepper&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Wacc&#39;</span> <span class="ow">or</span> <span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;Pimu&#39;</span><span class="p">):</span>
</span><span id="Transport.configure_version-854"><a href="#Transport.configure_version-854"><span class="linenos">854</span></a>            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Invalid device name &#39;</span><span class="p">)</span>
</span><span id="Transport.configure_version-855"><a href="#Transport.configure_version-855"><span class="linenos">855</span></a>        <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
</span><span id="Transport.configure_version-856"><a href="#Transport.configure_version-856"><span class="linenos">856</span></a>        <span class="n">minor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xl</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="Transport.configure_version-857"><a href="#Transport.configure_version-857"><span class="linenos">857</span></a>        <span class="k">if</span> <span class="n">major</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">minor</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="Transport.configure_version-858"><a href="#Transport.configure_version-858"><span class="linenos">858</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_0</span><span class="p">)</span>
</span><span id="Transport.configure_version-859"><a href="#Transport.configure_version-859"><span class="linenos">859</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Transport.configure_version-860"><a href="#Transport.configure_version-860"><span class="linenos">860</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">RPC_TRANSPORT_VERSION_1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Starting with Stepper/Wacc/Pimu firmware v0.4.0 a faster version (V1) of the transport layer is supported
Check here if can run the Transport in V1 mode</p>
</div>


                            </div>
                            <div id="Transport.set_version" class="classattr">
                                        <input id="Transport.set_version-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_version</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">v</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.set_version-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.set_version"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.set_version-862"><a href="#Transport.set_version-862"><span class="linenos">862</span></a>    <span class="k">def</span> <span class="nf">set_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Transport.set_version-863"><a href="#Transport.set_version-863"><span class="linenos">863</span></a>        <span class="c1"># print(&#39;VERSION&#39;,v,self.port_name)</span>
</span><span id="Transport.set_version-864"><a href="#Transport.set_version-864"><span class="linenos">864</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="Transport.set_version-865"><a href="#Transport.set_version-865"><span class="linenos">865</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid version for Transport&#39;</span><span class="p">)</span>
</span><span id="Transport.set_version-866"><a href="#Transport.set_version-866"><span class="linenos">866</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Transport.set_version-867"><a href="#Transport.set_version-867"><span class="linenos">867</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">v</span>
</span></pre></div>


    

                            </div>
                            <div id="Transport.do_pull_rpc_async" class="classattr">
                                        <input id="Transport.do_pull_rpc_async-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_pull_rpc_async</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.do_pull_rpc_async-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.do_pull_rpc_async"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.do_pull_rpc_async-869"><a href="#Transport.do_pull_rpc_async-869"><span class="linenos">869</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_pull_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport.do_pull_rpc_async-870"><a href="#Transport.do_pull_rpc_async-870"><span class="linenos">870</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport.do_pull_rpc_async-871"><a href="#Transport.do_pull_rpc_async-871"><span class="linenos">871</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="Transport.do_pull_rpc_async-872"><a href="#Transport.do_pull_rpc_async-872"><span class="linenos">872</span></a><span class="sd">        Parameters</span>
</span><span id="Transport.do_pull_rpc_async-873"><a href="#Transport.do_pull_rpc_async-873"><span class="linenos">873</span></a><span class="sd">        ----------</span>
</span><span id="Transport.do_pull_rpc_async-874"><a href="#Transport.do_pull_rpc_async-874"><span class="linenos">874</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport.do_pull_rpc_async-875"><a href="#Transport.do_pull_rpc_async-875"><span class="linenos">875</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport.do_pull_rpc_async-876"><a href="#Transport.do_pull_rpc_async-876"><span class="linenos">876</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport.do_pull_rpc_async-877"><a href="#Transport.do_pull_rpc_async-877"><span class="linenos">877</span></a>
</span><span id="Transport.do_pull_rpc_async-878"><a href="#Transport.do_pull_rpc_async-878"><span class="linenos">878</span></a><span class="sd">        Returns</span>
</span><span id="Transport.do_pull_rpc_async-879"><a href="#Transport.do_pull_rpc_async-879"><span class="linenos">879</span></a><span class="sd">        -------</span>
</span><span id="Transport.do_pull_rpc_async-880"><a href="#Transport.do_pull_rpc_async-880"><span class="linenos">880</span></a><span class="sd">        None</span>
</span><span id="Transport.do_pull_rpc_async-881"><a href="#Transport.do_pull_rpc_async-881"><span class="linenos">881</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport.do_pull_rpc_async-882"><a href="#Transport.do_pull_rpc_async-882"><span class="linenos">882</span></a>        <span class="c1"># Acquire the lock in a worker thread, suspending us while waiting.</span>
</span><span id="Transport.do_pull_rpc_async-883"><a href="#Transport.do_pull_rpc_async-883"><span class="linenos">883</span></a>        <span class="c1"># See https://stackoverflow.com/questions/63420413/how-to-use-threading-lock-in-async-function-while-object-can-be-accessed-from-mu</span>
</span><span id="Transport.do_pull_rpc_async-884"><a href="#Transport.do_pull_rpc_async-884"><span class="linenos">884</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="Transport.do_pull_rpc_async-885"><a href="#Transport.do_pull_rpc_async-885"><span class="linenos">885</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="Transport.do_pull_rpc_async-886"><a href="#Transport.do_pull_rpc_async-886"><span class="linenos">886</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="Transport.do_pull_rpc_async-887"><a href="#Transport.do_pull_rpc_async-887"><span class="linenos">887</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Do an RPC that pulls data from the device</p>

<h2 id="parameters">Parameters</h2>

<p>payload: Array of type 'B' with length of RPC data to transmit
reply_callback: Called after RPC data has been returned
exiting: Cleanup if a final call during exit</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="Transport.do_push_rpc_async" class="classattr">
                                        <input id="Transport.do_push_rpc_async-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">async def</span>
        <span class="name">do_push_rpc_async</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.do_push_rpc_async-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.do_push_rpc_async"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.do_push_rpc_async-889"><a href="#Transport.do_push_rpc_async-889"><span class="linenos">889</span></a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_push_rpc_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport.do_push_rpc_async-890"><a href="#Transport.do_push_rpc_async-890"><span class="linenos">890</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport.do_push_rpc_async-891"><a href="#Transport.do_push_rpc_async-891"><span class="linenos">891</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="Transport.do_push_rpc_async-892"><a href="#Transport.do_push_rpc_async-892"><span class="linenos">892</span></a><span class="sd">        Parameters</span>
</span><span id="Transport.do_push_rpc_async-893"><a href="#Transport.do_push_rpc_async-893"><span class="linenos">893</span></a><span class="sd">        ----------</span>
</span><span id="Transport.do_push_rpc_async-894"><a href="#Transport.do_push_rpc_async-894"><span class="linenos">894</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport.do_push_rpc_async-895"><a href="#Transport.do_push_rpc_async-895"><span class="linenos">895</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport.do_push_rpc_async-896"><a href="#Transport.do_push_rpc_async-896"><span class="linenos">896</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport.do_push_rpc_async-897"><a href="#Transport.do_push_rpc_async-897"><span class="linenos">897</span></a><span class="sd">        Returns</span>
</span><span id="Transport.do_push_rpc_async-898"><a href="#Transport.do_push_rpc_async-898"><span class="linenos">898</span></a><span class="sd">        -------</span>
</span><span id="Transport.do_push_rpc_async-899"><a href="#Transport.do_push_rpc_async-899"><span class="linenos">899</span></a><span class="sd">        None</span>
</span><span id="Transport.do_push_rpc_async-900"><a href="#Transport.do_push_rpc_async-900"><span class="linenos">900</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport.do_push_rpc_async-901"><a href="#Transport.do_push_rpc_async-901"><span class="linenos">901</span></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">)</span>
</span><span id="Transport.do_push_rpc_async-902"><a href="#Transport.do_push_rpc_async-902"><span class="linenos">902</span></a>        <span class="n">success</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span>
</span><span id="Transport.do_push_rpc_async-903"><a href="#Transport.do_push_rpc_async-903"><span class="linenos">903</span></a>                                                  <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span><span id="Transport.do_push_rpc_async-904"><a href="#Transport.do_push_rpc_async-904"><span class="linenos">904</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Do an RPC that pushes data to the device</p>

<h2 id="parameters">Parameters</h2>

<p>payload: Array of type 'B' with length of RPC data to transmit
reply_callback: Called after RPC data has been returned
exiting: Cleanup if a final call during exit</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="Transport.do_pull_rpc_sync" class="classattr">
                                        <input id="Transport.do_pull_rpc_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_pull_rpc_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.do_pull_rpc_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.do_pull_rpc_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.do_pull_rpc_sync-906"><a href="#Transport.do_pull_rpc_sync-906"><span class="linenos">906</span></a>    <span class="k">def</span> <span class="nf">do_pull_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport.do_pull_rpc_sync-907"><a href="#Transport.do_pull_rpc_sync-907"><span class="linenos">907</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport.do_pull_rpc_sync-908"><a href="#Transport.do_pull_rpc_sync-908"><span class="linenos">908</span></a><span class="sd">        Do an RPC that pulls data from the device</span>
</span><span id="Transport.do_pull_rpc_sync-909"><a href="#Transport.do_pull_rpc_sync-909"><span class="linenos">909</span></a><span class="sd">        Parameters</span>
</span><span id="Transport.do_pull_rpc_sync-910"><a href="#Transport.do_pull_rpc_sync-910"><span class="linenos">910</span></a><span class="sd">        ----------</span>
</span><span id="Transport.do_pull_rpc_sync-911"><a href="#Transport.do_pull_rpc_sync-911"><span class="linenos">911</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport.do_pull_rpc_sync-912"><a href="#Transport.do_pull_rpc_sync-912"><span class="linenos">912</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport.do_pull_rpc_sync-913"><a href="#Transport.do_pull_rpc_sync-913"><span class="linenos">913</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport.do_pull_rpc_sync-914"><a href="#Transport.do_pull_rpc_sync-914"><span class="linenos">914</span></a>
</span><span id="Transport.do_pull_rpc_sync-915"><a href="#Transport.do_pull_rpc_sync-915"><span class="linenos">915</span></a><span class="sd">        Returns</span>
</span><span id="Transport.do_pull_rpc_sync-916"><a href="#Transport.do_pull_rpc_sync-916"><span class="linenos">916</span></a><span class="sd">        -------</span>
</span><span id="Transport.do_pull_rpc_sync-917"><a href="#Transport.do_pull_rpc_sync-917"><span class="linenos">917</span></a><span class="sd">        None</span>
</span><span id="Transport.do_pull_rpc_sync-918"><a href="#Transport.do_pull_rpc_sync-918"><span class="linenos">918</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport.do_pull_rpc_sync-919"><a href="#Transport.do_pull_rpc_sync-919"><span class="linenos">919</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="Transport.do_pull_rpc_sync-920"><a href="#Transport.do_pull_rpc_sync-920"><span class="linenos">920</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Do an RPC that pulls data from the device</p>

<h2 id="parameters">Parameters</h2>

<p>payload: Array of type 'B' with length of RPC data to transmit
reply_callback: Called after RPC data has been returned
exiting: Cleanup if a final call during exit</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                            <div id="Transport.do_push_rpc_sync" class="classattr">
                                        <input id="Transport.do_push_rpc_sync-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">do_push_rpc_sync</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">payload</span>, </span><span class="param"><span class="n">reply_callback</span>, </span><span class="param"><span class="n">exiting</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Transport.do_push_rpc_sync-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Transport.do_push_rpc_sync"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Transport.do_push_rpc_sync-922"><a href="#Transport.do_push_rpc_sync-922"><span class="linenos">922</span></a>    <span class="k">def</span> <span class="nf">do_push_rpc_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="Transport.do_push_rpc_sync-923"><a href="#Transport.do_push_rpc_sync-923"><span class="linenos">923</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Transport.do_push_rpc_sync-924"><a href="#Transport.do_push_rpc_sync-924"><span class="linenos">924</span></a><span class="sd">        Do an RPC that pushes data to the device</span>
</span><span id="Transport.do_push_rpc_sync-925"><a href="#Transport.do_push_rpc_sync-925"><span class="linenos">925</span></a><span class="sd">        Parameters</span>
</span><span id="Transport.do_push_rpc_sync-926"><a href="#Transport.do_push_rpc_sync-926"><span class="linenos">926</span></a><span class="sd">        ----------</span>
</span><span id="Transport.do_push_rpc_sync-927"><a href="#Transport.do_push_rpc_sync-927"><span class="linenos">927</span></a><span class="sd">        payload: Array of type &#39;B&#39; with length of RPC data to transmit</span>
</span><span id="Transport.do_push_rpc_sync-928"><a href="#Transport.do_push_rpc_sync-928"><span class="linenos">928</span></a><span class="sd">        reply_callback: Called after RPC data has been returned</span>
</span><span id="Transport.do_push_rpc_sync-929"><a href="#Transport.do_push_rpc_sync-929"><span class="linenos">929</span></a><span class="sd">        exiting: Cleanup if a final call during exit</span>
</span><span id="Transport.do_push_rpc_sync-930"><a href="#Transport.do_push_rpc_sync-930"><span class="linenos">930</span></a>
</span><span id="Transport.do_push_rpc_sync-931"><a href="#Transport.do_push_rpc_sync-931"><span class="linenos">931</span></a><span class="sd">        Returns</span>
</span><span id="Transport.do_push_rpc_sync-932"><a href="#Transport.do_push_rpc_sync-932"><span class="linenos">932</span></a><span class="sd">        -------</span>
</span><span id="Transport.do_push_rpc_sync-933"><a href="#Transport.do_push_rpc_sync-933"><span class="linenos">933</span></a><span class="sd">        None</span>
</span><span id="Transport.do_push_rpc_sync-934"><a href="#Transport.do_push_rpc_sync-934"><span class="linenos">934</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Transport.do_push_rpc_sync-935"><a href="#Transport.do_push_rpc_sync-935"><span class="linenos">935</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
</span><span id="Transport.do_push_rpc_sync-936"><a href="#Transport.do_push_rpc_sync-936"><span class="linenos">936</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">sync_handler</span><span class="o">.</span><span class="n">do_rpc</span><span class="p">(</span><span class="n">push</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">payload</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">reply_callback</span><span class="o">=</span><span class="n">reply_callback</span><span class="p">,</span> <span class="n">exiting</span><span class="o">=</span><span class="n">exiting</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Do an RPC that pushes data to the device</p>

<h2 id="parameters">Parameters</h2>

<p>payload: Array of type 'B' with length of RPC data to transmit
reply_callback: Called after RPC data has been returned
exiting: Cleanup if a final call during exit</p>

<h2 id="returns">Returns</h2>

<p>None</p>
</div>


                            </div>
                </section>
                <section id="pack_string_t">
                            <input id="pack_string_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_string_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_string_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_string_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_string_t-941"><a href="#pack_string_t-941"><span class="linenos">941</span></a><span class="k">def</span> <span class="nf">pack_string_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_string_t-942"><a href="#pack_string_t-942"><span class="linenos">942</span></a>    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="pack_string_t-943"><a href="#pack_string_t-943"><span class="linenos">943</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="unpack_string_t">
                            <input id="unpack_string_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_string_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">n</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_string_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_string_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_string_t-946"><a href="#unpack_string_t-946"><span class="linenos">946</span></a><span class="k">def</span> <span class="nf">unpack_string_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
</span><span id="unpack_string_t-947"><a href="#unpack_string_t-947"><span class="linenos">947</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="unpack_int32_t">
                            <input id="unpack_int32_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_int32_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_int32_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_int32_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_int32_t-950"><a href="#unpack_int32_t-950"><span class="linenos">950</span></a><span class="k">def</span> <span class="nf">unpack_int32_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_int32_t-951"><a href="#unpack_int32_t-951"><span class="linenos">951</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_uint32_t">
                            <input id="unpack_uint32_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_uint32_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_uint32_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_uint32_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_uint32_t-954"><a href="#unpack_uint32_t-954"><span class="linenos">954</span></a><span class="k">def</span> <span class="nf">unpack_uint32_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_uint32_t-955"><a href="#unpack_uint32_t-955"><span class="linenos">955</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_int64_t">
                            <input id="unpack_int64_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_int64_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_int64_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_int64_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_int64_t-958"><a href="#unpack_int64_t-958"><span class="linenos">958</span></a><span class="k">def</span> <span class="nf">unpack_int64_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_int64_t-959"><a href="#unpack_int64_t-959"><span class="linenos">959</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_uint64_t">
                            <input id="unpack_uint64_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_uint64_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_uint64_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_uint64_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_uint64_t-962"><a href="#unpack_uint64_t-962"><span class="linenos">962</span></a><span class="k">def</span> <span class="nf">unpack_uint64_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_uint64_t-963"><a href="#unpack_uint64_t-963"><span class="linenos">963</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_int16_t">
                            <input id="unpack_int16_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_int16_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_int16_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_int16_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_int16_t-966"><a href="#unpack_int16_t-966"><span class="linenos">966</span></a><span class="k">def</span> <span class="nf">unpack_int16_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_int16_t-967"><a href="#unpack_int16_t-967"><span class="linenos">967</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_uint16_t">
                            <input id="unpack_uint16_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_uint16_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_uint16_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_uint16_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_uint16_t-970"><a href="#unpack_uint16_t-970"><span class="linenos">970</span></a><span class="k">def</span> <span class="nf">unpack_uint16_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_uint16_t-971"><a href="#unpack_uint16_t-971"><span class="linenos">971</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_uint8_t">
                            <input id="unpack_uint8_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_uint8_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_uint8_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_uint8_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_uint8_t-974"><a href="#unpack_uint8_t-974"><span class="linenos">974</span></a><span class="k">def</span> <span class="nf">unpack_uint8_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_uint8_t-975"><a href="#unpack_uint8_t-975"><span class="linenos">975</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_float_t">
                            <input id="unpack_float_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_float_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_float_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_float_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_float_t-978"><a href="#unpack_float_t-978"><span class="linenos">978</span></a><span class="k">def</span> <span class="nf">unpack_float_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_float_t-979"><a href="#unpack_float_t-979"><span class="linenos">979</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">4</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="unpack_double_t">
                            <input id="unpack_double_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unpack_double_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unpack_double_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unpack_double_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unpack_double_t-982"><a href="#unpack_double_t-982"><span class="linenos">982</span></a><span class="k">def</span> <span class="nf">unpack_double_t</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
</span><span id="unpack_double_t-983"><a href="#unpack_double_t-983"><span class="linenos">983</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[:</span><span class="mi">8</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                </section>
                <section id="pack_float_t">
                            <input id="pack_float_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_float_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_float_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_float_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_float_t-986"><a href="#pack_float_t-986"><span class="linenos">986</span></a><span class="k">def</span> <span class="nf">pack_float_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_float_t-987"><a href="#pack_float_t-987"><span class="linenos">987</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_double_t">
                            <input id="pack_double_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_double_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_double_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_double_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_double_t-990"><a href="#pack_double_t-990"><span class="linenos">990</span></a><span class="k">def</span> <span class="nf">pack_double_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_double_t-991"><a href="#pack_double_t-991"><span class="linenos">991</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_int32_t">
                            <input id="pack_int32_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_int32_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_int32_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_int32_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_int32_t-994"><a href="#pack_int32_t-994"><span class="linenos">994</span></a><span class="k">def</span> <span class="nf">pack_int32_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_int32_t-995"><a href="#pack_int32_t-995"><span class="linenos">995</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_uint32_t">
                            <input id="pack_uint32_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_uint32_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_uint32_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_uint32_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_uint32_t-998"><a href="#pack_uint32_t-998"><span class="linenos">998</span></a><span class="k">def</span> <span class="nf">pack_uint32_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_uint32_t-999"><a href="#pack_uint32_t-999"><span class="linenos">999</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_int16_t">
                            <input id="pack_int16_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_int16_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_int16_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_int16_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_int16_t-1002"><a href="#pack_int16_t-1002"><span class="linenos">1002</span></a><span class="k">def</span> <span class="nf">pack_int16_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_int16_t-1003"><a href="#pack_int16_t-1003"><span class="linenos">1003</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_uint16_t">
                            <input id="pack_uint16_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_uint16_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_uint16_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_uint16_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_uint16_t-1006"><a href="#pack_uint16_t-1006"><span class="linenos">1006</span></a><span class="k">def</span> <span class="nf">pack_uint16_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_uint16_t-1007"><a href="#pack_uint16_t-1007"><span class="linenos">1007</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="pack_uint8_t">
                            <input id="pack_uint8_t-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pack_uint8_t</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">s</span>, </span><span class="param"><span class="n">sidx</span>, </span><span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pack_uint8_t-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pack_uint8_t"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pack_uint8_t-1010"><a href="#pack_uint8_t-1010"><span class="linenos">1010</span></a><span class="k">def</span> <span class="nf">pack_uint8_t</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
</span><span id="pack_uint8_t-1011"><a href="#pack_uint8_t-1011"><span class="linenos">1011</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack_into</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">sidx</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</span></pre></div>


    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>